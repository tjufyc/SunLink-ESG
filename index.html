
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, height=device-height">
    <title>SunLink ESG 管理 | Experiment Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent; 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        }
        
        .header-spacer { width: 100%; height: 140px; flex-shrink: 0; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .stat-float { position: absolute; font-weight: bold; pointer-events: none; animation: floatUp 1.5s forwards; opacity: 0; z-index: 60; text-shadow: 0 1px 2px rgba(255,255,255,0.8); }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-30px) scale(1.2); opacity: 0; } }
        .dice-roll { animation: spin 0.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .comp-table { width: 100%; font-size: 10px; border-collapse: collapse; margin-top: 10px; }
        .comp-table th { background: #f1f5f9; color: #64748b; font-weight: bold; padding: 6px; text-align: center; border: 1px solid #e2e8f0; }
        .comp-table td { padding: 6px; text-align: center; border: 1px solid #e2e8f0; } 
        .comp-table tr.highlight { background: #eff6ff; font-weight: bold; color: #1e40af; }
        .comp-table tr.avg-row { background: #f8fafc; color: #64748b; font-style: italic; }
        
        /* 矩阵表格样式 */
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 9px; text-align: center; }
        .matrix-table th, .matrix-table td { border: 1px solid #cbd5e1; padding: 4px 2px; }
        .matrix-table th { background: #e2e8f0; color: #334155; }
        /* 修改4：高亮样式调整，适配彩色背景 */
        .matrix-highlight { border: 2px solid #2563eb !important; font-weight: bold; background-color: rgba(255,255,255,0.6); }
        /* 概率行样式调整，支持内部span高亮 */
        .prob-row { font-size: 8px; color: #64748b; background: rgba(255,255,255,0.5); }
        .prob-highlight { color: #dc2626; font-weight: bold; background-color: #fef2f2; padding: 0 2px; border-radius: 2px; border: 1px solid #fee2e2; }

        /* 问卷样式 */
        .likert-scale { display: flex; justify-content: space-between; margin-top: 8px; margin-bottom: 16px; padding: 4px; border-radius: 8px; transition: background 0.3s;}
        .likert-opt { display: flex; flex-direction: column; items-center; text-align: center; cursor: pointer; width: 18%; }
        .likert-circle { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; margin-bottom: 4px; transition: all 0.2s; font-size: 10px; font-weight: bold; color: #64748b; }
        .likert-opt.selected .likert-circle { background-color: #3b82f6; border-color: #3b82f6; color: white; transform: scale(1.1); }
        .likert-label { font-size: 8px; color: #94a3b8; line-height: 1.2; }
        
        /* 问卷未填高亮 */
        .scroll-highlight { animation: pulse-bg 1.5s infinite; border: 1px solid #ef4444; }
        @keyframes pulse-bg { 0% { background-color: #fee2e2; } 50% { background-color: #fff; } 100% { background-color: #fee2e2; } }

        /* 表单输入样式 */
        .form-group { margin-bottom: 12px; padding: 4px; border-radius: 6px; transition: background 0.3s; }
        .form-label { display: block; font-size: 12px; font-weight: bold; color: #475569; margin-bottom: 4px; }
        .form-select, .form-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 12px; background: #fff; }
        .radio-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .radio-label { display: flex; items-center: center; font-size: 12px; color: #475569; cursor: pointer; background: #f1f5f9; padding: 6px 10px; border-radius: 16px; border: 1px solid transparent; transition: all 0.2s; }
        .radio-label.checked { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; font-weight: bold; }
        .radio-label input { display: none; }


        /* 九宫格随机样式 */
        .grid-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; width: 100%; max-width: 300px; margin: 0 auto; }
        .grid-cell { aspect-ratio: 1; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; flex-col; flex-direction: column; align-items: center; justify-content: center; background: #f8fafc; transition: all 0.1s; opacity: 0.5; }
        .grid-cell.active { background: #3b82f6; color: white; transform: scale(1.05); opacity: 1; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); border-color: #2563eb; z-index: 10; }
        .grid-cell-text { font-size: 10px; font-weight: bold; text-align: center; }
        .grid-cell-sub { font-size: 8px; opacity: 0.8; }

        /* 修改3：情境描述卡片布局调整 (并行排列) */
        .ctx-desc-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 8px; }
        .ctx-desc-card { 
            font-size: 9px; 
            color: #475569; 
            background: #f8fafc; 
            padding: 6px; 
            border-radius: 6px; 
            border: 1px solid #cbd5e1; /* 加深未选中边框 */
            transition: all 0.3s; 
            opacity: 0.8; 
            display: flex; flex-direction: column;
            height: 100%;
        }
        .ctx-label { font-weight: bold; color: #334155; display: block; margin-bottom: 4px; font-size: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px;}
        
        /* 修改3：高亮样式增强 */
        .ctx-desc-card.highlighted {
            background: #eff6ff; /* 更明显的背景 */
            border-color: #2563eb;
            border-width: 2px;
            color: #0f172a;
            opacity: 1;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
            transform: scale(1.02); /* 微微放大 */
            z-index: 5;
        }
        
        .copyright-text { font-size: 9px; color: #cbd5e1; text-align: center; margin-top: 12px; font-family: sans-serif; }
        
        /* 错误提示条 */
        #network-status { display: none; }

        /* 跳动地球动画 */
        .bounce-earth { animation: bounce 2s infinite; font-size: 80px; display: block; text-align: center; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }
        
        /* 底部按钮容器通用样式 */
        .nav-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.95);
            border-top: 1px solid #f1f5f9;
            backdrop-filter: blur(4px);
            z-index: 30;
            padding: 16px;
            padding-bottom: env(safe-area-inset-bottom, 20px);
            display: flex; gap: 12px; /* 按钮间距 */
        }

        /* 主要按钮 (右侧) */
        .btn-primary {
            flex: 2; /* 占据更多空间 */
            background: #1e293b; color: white;
            font-weight: bold; border-radius: 12px;
            padding: 14px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        /* 次要/返回按钮 (左侧) */
        .btn-secondary {
            flex: 1; /* 占据较少空间 */
            background: #f1f5f9; color: #64748b;
            font-weight: bold; border-radius: 12px;
            padding: 14px; border: 1px solid #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .btn-secondary:active { background: #e2e8f0; }
        
        /* 强耦合UI高亮样式 */
        .highlight-short-term { background-color: #f0fdf4; color: #15803d; font-weight: bold; padding: 0 2px; border-radius: 2px; border: 1px solid #bbf7d0; }
        .highlight-long-term { background-color: #fefce8; color: #854d0e; font-weight: bold; padding: 0 2px; border-radius: 2px; border: 1px solid #fef08a; }

        /* 状态栏红色闪烁动画 */
        @keyframes box-flash-red {
            0%, 100% { background-color: #f8fafc; border-color: #e2e8f0; }
            50% { background-color: #fee2e2; border-color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
        }
        .animate-box-flash {
            animation: box-flash-red 1s infinite;
        }

        /* --- 启动海报 (v4.4 Layout & Bar Fix Edition) --- */
        #screen-poster {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 9999 !important;
            background-color: #050505; 
            display: flex; flex-direction: column; justify-content: flex-end;
            transition: opacity 0.8s ease-out;
        }
        
        .poster-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            z-index: 101;
            display: block; 
            filter: brightness(0.8) contrast(1.1);
        }
        
        /* 遮罩层 */
        .poster-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 60%, rgba(0,0,0,0.9) 100%);
            z-index: 102;
        }

        /* 标题容器：上移 10% */
        .poster-title-container {
            position: absolute;
            top: 30%; /* 原40%，上移10% */
            left: 50%; 
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
            z-index: 103;
            padding: 0 20px;
        }
        
        /* 标题 1: SunLink */
        /* 修改1：加大行距 (line-height) */
        .poster-main-title {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 56px; 
            font-weight: 900;
            margin-bottom: 0;
            line-height: 1.4; /* 修改：从 1.1 改为 1.4 */
            letter-spacing: -1px;
            background: linear-gradient(135deg, #ffffff 0%, #e0f2fe 50%, #38bdf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 15px rgba(0, 0, 0, 0.9));
        }

        /* 标题 2: ESG Simulator */
        /* 修改1：加大行距 (margin-top) */
        .poster-sub-title {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 26px; 
            font-weight: 600;
            color: #bef264; 
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.9); 
            margin-top: 20px; /* 修改：从 8px 改为 20px */
            letter-spacing: 3px; 
            text-transform: uppercase;
        }

        /* 底部机构信息 (位置修正：上移至25%，防止被遮挡) */
        .poster-footer-info {
            position: absolute; 
            bottom: 25%; /* 修改：10% -> 25% (上移15%) */
            left: 0; width: 100%;
            text-align: center;
            z-index: 103;
            color: #f8fafc;
            font-family: "Georgia", serif; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.95);
        }
        .poster-org-name {
            font-size: 18px; 
            font-weight: bold;
            display: block;
            margin-bottom: 6px;
            letter-spacing: 1px;
            text-transform: uppercase; 
        }
        .poster-center-name {
            font-size: 13px;
            opacity: 1.0; 
            display: block;
            letter-spacing: 0.5px;
            color: #e2e8f0;
            font-weight: 500;
        }

        /* 3秒倒计时进度条 - 修正版 */
        /* 位置：ESG Simulator 和 Tianjin University 中间 */
        /* title是 top: 30%左右, footer是 bottom: 25%左右 */
        /* 我们把 Bar 放在 bottom: 35% 左右比较合适 */
        .poster-bar-container {
            position: absolute; 
            bottom: 35%; /* 调整高度位置 */
            left: 50%; 
            transform: translateX(-50%);
            width: 60%; /* 稍微加宽一点 */
            height: 32px; /* 增高，以便容纳文字 */
            background: rgba(0,0,0,0.6); /* 半透明黑底 */
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px; 
            overflow: hidden; 
            z-index: 103;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        
        /* 内部进度条 */
        .poster-bar {
            width: 100%; 
            height: 100%; 
            background: linear-gradient(90deg, #38bdf8, #2563eb); /* 蓝渐变 */
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
            animation: posterCountdown 3s linear forwards;
        }
        @keyframes posterCountdown { 
            0% { width: 0%; } /* 从0开始增长，模拟加载/开始 */
            100% { width: 100%; } 
        }
        
        /* 进度条上的文字 */
        .poster-bar-text {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #ffffff;
            letter-spacing: 2px;
            z-index: 104;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

    </style>
</head>
<body class="flex flex-col text-slate-800 bg-slate-100">

    <!-- 0. 启动海报 (v4.4 Layout & Bar Fix Edition) -->
    <div id="screen-poster">
        <!-- 背景图 -->
        <img src="https://images.unsplash.com/photo-1473341304170-971dccb5ac1e?q=80&w=2070&auto=format&fit=crop" 
             alt="Green Earth Power Grid" 
             id="poster-image-element"
             class="poster-img">
             
        <!-- 遮罩层 -->
        <div class="poster-overlay"></div>

        <!-- 中间大标题：已上移 -->
        <div class="poster-title-container">
            <div class="poster-main-title">SunLink</div>
            <div class="poster-sub-title">ESG Simulator</div>
        </div>

        <!-- 3秒倒计时进度条：增加文字，位置居中 -->
        <div class="poster-bar-container">
             <div class="poster-bar-text">挑战即将开始</div> <!-- 修改：文字变更 -->
            <div class="poster-bar"></div>
        </div>

        <!-- 底部机构文字 -->
        <div class="poster-footer-info">
            <span class="poster-org-name">Tianjin University</span>
            <span class="poster-center-name">Global Infrastructure Projects Center</span>
        </div>
    </div>

    <!-- 顶部导航栏 (ID="main-header") -->
    <header id="main-header" class="bg-white shadow-sm border-b border-slate-200 z-50 px-3 py-2 w-full absolute top-0 left-0 hidden">
        <div class="flex justify-between items-center mb-2 pt-safe-top mt-2"> 
            <!-- 文字 Logo 样式 -->
            <div class="flex items-center gap-2">
                <div class="text-xl">🌍</div>
                <div class="font-black text-lg tracking-tight text-slate-800">SunLink <span class="text-blue-600">ESG</span></div>
            </div>
            <div class="text-xs text-slate-400 font-bold" id="level-indicator">Mission Briefing</div>
        </div>
        
        <!-- 核心数值仪表盘 -->
        <div class="grid grid-cols-3 gap-2 text-xs font-bold pb-1">
            <div class="flex flex-col items-center bg-slate-50 p-1 rounded border border-slate-200 relative overflow-visible">
                <span class="text-[10px] text-slate-400 scale-90">利润(万)</span>
                <span id="val-budget" class="text-emerald-600 text-base">1000.00</span>
                <div id="float-budget" class="absolute top-0 left-1/2 -translate-x-1/2"></div>
            </div>
            <div class="flex flex-col items-center bg-slate-50 p-1 rounded border border-slate-200 relative overflow-visible transition-all duration-300" id="box-schedule">
                <span id="lbl-schedule" class="text-[10px] text-slate-400 scale-90">进度(剩余)</span>
                <div class="flex items-baseline">
                    <span id="val-schedule" class="text-blue-600 text-base">4.0</span>
                    <span class="text-[10px] text-slate-300 font-normal ml-0.5">月</span>
                </div>
                <div id="float-schedule" class="absolute top-0 left-1/2 -translate-x-1/2"></div>
            </div>
            <div class="flex flex-col items-center bg-slate-50 p-1 rounded border border-slate-200 relative overflow-visible">
                <span class="text-[10px] text-slate-400 scale-90">声誉</span>
                <span id="val-reputation" class="text-yellow-600 text-base">100.00</span>
                <div id="float-reputation" class="absolute top-0 left-1/2 -translate-x-1/2"></div>
            </div>
        </div>
        
        <div class="w-full h-1 bg-slate-200 mt-2 rounded-full overflow-hidden">
            <div id="progress-bar" class="bg-blue-500 h-1 transition-all duration-500" style="width: 0%"></div>
        </div>
        <!-- 离线提示 -->
        <div id="network-status" class="w-full bg-orange-100 text-orange-700 text-[10px] text-center py-1 mt-1 rounded">
            当前为离线模式 (数据无法同步)
        </div>
    </header>

    <!-- 主内容区域 -->
    <main class="flex-1 relative w-full h-full max-w-lg mx-auto bg-white md:my-4 md:rounded-2xl md:shadow-xl md:border md:border-slate-200 overflow-hidden flex flex-col z-0">
        
        <!-- 1. 开场 (首页) -->
        <div id="screen-start" class="absolute inset-0 z-20 flex flex-col bg-white fade-in overflow-y-auto hidden"> <!-- 注意：默认先hidden，等海报结束后显示 -->
            <div class="flex-1 p-6 flex flex-col items-center justify-center text-center pb-40">
                <div class="bounce-earth mb-4">🌍</div>
                
                <h2 class="text-2xl font-black text-slate-800 mb-2">SunLink <span class="text-blue-600">ESG</span></h2>
                <p class="text-sm font-medium text-slate-500 mb-4">国际工程项目ESG管理模拟挑战</p>
                <p class="text-sm text-slate-600 mb-8 leading-relaxed px-4">
                    你需要平衡<b>工期压力</b>、<b>项目利润</b>与<b>合规要求</b><br>
                    每一个决定都将影响项目的最终命运
                </p>
                <div class="mt-4 pt-6 border-t border-slate-100 w-full">
                    <!-- 修改：增大行距 -->
                    <p class="text-xs text-slate-400 font-medium mb-2">开发单位</p>
                    <p class="text-xs text-slate-600 font-bold mb-4">天津大学全球工程经营实验室</p>
                    
                    <!-- 修改：增大行距 -->
                    <p class="text-xs text-slate-400 font-medium mb-2">联系人</p>
                    <p class="text-xs text-slate-600 font-bold mb-2">傅老师 yongcheng_fu@126.com</p>
                    
                    <div class="copyright-text">© 2025 Tianjin University GIPC. All Rights Reserved.</div>
                </div>
            </div>
            <div class="fixed bottom-0 left-0 w-full p-4 bg-white/95 border-t border-slate-100 backdrop-blur-sm z-50 pb-safe-area">
                <button onclick="goToSurvey()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">
                    开始挑战
                </button>
            </div>
        </div>

        <!-- 1.5 调查问卷 (重构) -->
        <div id="screen-survey" class="hidden flex-col h-full fade-in absolute inset-0 z-20 bg-white">
            <div class="pt-4 pb-2 px-6 flex justify-center items-center border-b border-slate-100 bg-white z-10">
                 <div class="text-2xl mr-2">🌍</div>
                 <div class="font-black text-xl tracking-tight text-slate-800">SunLink <span class="text-blue-600">ESG</span></div>
            </div>

            <div class="px-6 pt-4 flex-1 overflow-y-auto pb-40 scroll-smooth" id="survey-container">
                
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6 text-xs text-slate-600 leading-relaxed shadow-sm">
                    <h4 class="font-bold text-blue-800 mb-2 text-sm">🔬 实验研究知情同意书</h4>
                    <p class="mb-2">您即将参与的是一项关于国际工程 ESG 决策行为的学术研究实验，由天津大学全球工程经营实验室开发。</p>
                    <ul class="list-disc pl-4 space-y-1 text-slate-500">
                        <li><strong>匿名性：</strong>您的所有回答将被严格保密，系统仅记录去标识化的决策数据用于科研统计分析。</li>
                        <li><strong>自愿性：</strong>参与本实验完全自愿，您有权在任何时候关闭页面退出。</li>
                        <li><strong>无风险：</strong>本实验不涉及任何商业利益或个人隐私风险。</li>
                    </ul>
                </div>

                <h2 class="text-xl font-black text-slate-800 mb-6">📋 实验前小调查</h2>
                
                <form id="survey-form" onsubmit="submitSurvey(event)">
                    <!-- 0. 个人背景信息 -->
                    <div class="mb-6">
                        <p class="text-xs font-bold text-slate-500 mb-2 uppercase border-b pb-1">基本信息</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-3">
                             <div class="form-group" id="q-gender">
                                <label class="form-label">性别</label>
                                <select class="form-select" data-field="gender">
                                    <option value="">请选择</option>
                                    <option value="M">男</option>
                                    <option value="F">女</option>
                                </select>
                            </div>
                            <div class="form-group" id="q-age">
                                <label class="form-label">年龄</label>
                                <select class="form-select" data-field="age">
                                    <option value="">请选择</option>
                                    <option value="<20">20岁以下</option>
                                    <option value="20-25">20-25岁</option>
                                    <option value="26-30">26-30岁</option>
                                    <option value="31-35">31-35岁</option>
                                    <option value="36-40">36-40岁</option>
                                    <option value="41-45">41-45岁</option>
                                    <option value="46-50">46-50岁</option>
                                    <option value="51-55">51-55岁</option>
                                    <option value="56-60">56-60岁</option>
                                    <option value="61-65">61-65岁</option>
                                    <option value="65+">65岁以上</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" id="q-major">
                             <label class="form-label">专业背景</label>
                             <select class="form-select" data-field="major">
                                <option value="">请选择</option>
                                <option value="Engineering">工程技术</option>
                                <option value="Law">法律/合规</option>
                                <option value="Finance">财务/经济</option>
                                <option value="Environment">环境/安全</option>
                                <option value="Business">商务/管理</option>
                                <option value="Other">其他</option>
                            </select>
                        </div>

                        <div class="form-group" id="q-pm">
                            <label class="form-label">您是否担任过项目经理？</label>
                            <div class="radio-group">
                                <label class="radio-label" onclick="selectRadio(this, 'role_pm', 'yes')">
                                    <input type="radio" name="role_pm" value="yes"> 是
                                </label>
                                <label class="radio-label" onclick="selectRadio(this, 'role_pm', 'no')">
                                    <input type="radio" name="role_pm" value="no"> 否
                                </label>
                            </div>
                        </div>

                        <div class="form-group" id="q-hse">
                            <label class="form-label">您是否担任过HSE/ESG部门经理？</label>
                            <div class="radio-group">
                                <label class="radio-label" onclick="selectRadio(this, 'role_hse', 'yes')">
                                    <input type="radio" name="role_hse" value="yes"> 是
                                </label>
                                <label class="radio-label" onclick="selectRadio(this, 'role_hse', 'no')">
                                    <input type="radio" name="role_hse" value="no"> 否
                                </label>
                            </div>
                        </div>

                        <div class="form-group" id="q-exp">
                            <label class="form-label">以往是否经历过ESG负面事件(如环保被罚)？</label>
                            <div class="radio-group">
                                <label class="radio-label" onclick="selectRadio(this, 'exp_neg', 'yes')">
                                    <input type="radio" name="exp_neg" value="yes"> 是
                                </label>
                                <label class="radio-label" onclick="selectRadio(this, 'exp_neg', 'no')">
                                    <input type="radio" name="exp_neg" value="no"> 否
                                </label>
                            </div>
                        </div>
                    </div>

                    <hr class="border-slate-100 my-6">

                    <!-- 1. 个人特质 -->
                    <div class="mb-6">
                        <p class="text-xs font-bold text-purple-600 mb-2 uppercase">第一部分：个人特质</p>
                        <div class="mb-4" id="q-moral1">
                            <p class="text-sm font-medium mb-2">1. 对我来说，做一个有道德的人是非常重要的。</p>
                            <div class="likert-scale" data-name="moral1"></div>
                        </div>
                        <div class="mb-4" id="q-moral2">
                            <p class="text-sm font-medium mb-2">2. 如果我的行为被视为是不道德的，我会感到羞愧。</p>
                            <div class="likert-scale" data-name="moral2"></div>
                        </div>
                        <div class="mb-4" id="q-moral3">
                            <p class="text-sm font-medium mb-2">3. 即使没有人在看，我也坚持做正确（合乎道德）的事。</p>
                            <div class="likert-scale" data-name="moral3"></div>
                        </div>
                        <div class="mb-4" id="q-time1">
                            <p class="text-sm font-medium mb-2">4. 我通常愿意放弃眼前的利益，以换取未来更大的回报。</p>
                            <div class="likert-scale" data-name="time1"></div>
                        </div>
                        <div class="mb-4" id="q-time2">
                            <p class="text-sm font-medium mb-2">5. 我做决策时，经常考虑其对未来3-5年的影响。</p>
                            <div class="likert-scale" data-name="time2"></div>
                        </div>
                        <div class="mb-4" id="q-time3">
                            <p class="text-sm font-medium mb-2">6. 我不喜欢等待，更倾向于“落袋为安”。</p>
                            <div class="likert-scale" data-name="time3"></div>
                        </div>
                    </div>

                    <!-- 2. ESG 认同 -->
                    <div class="mb-6">
                        <p class="text-xs font-bold text-blue-600 mb-2 uppercase">第二部分：ESG 认同</p>
                        
                        <div class="mb-4" id="q-esg1">
                            <p class="text-sm font-medium mb-2">7. 我认为 ESG 主要是为了公关形象，对项目实质价值有限。</p>
                            <div class="likert-scale" data-name="esg1"></div> 
                        </div>
                        <div class="mb-4" id="q-esg2">
                            <p class="text-sm font-medium mb-2">8. 与项目带来的经济利益相比，ESG议题可以做出妥协。</p>
                            <div class="likert-scale" data-name="esg2"></div>
                        </div>
                        <div class="mb-4" id="q-esg3">
                            <p class="text-sm font-medium mb-2">9. 哪怕牺牲短期利润，企业也应严格遵守环境与社会标准。</p>
                            <div class="likert-scale" data-name="esg3"></div>
                        </div>
                    </div>

                    <!-- 3. 决策偏好 -->
                    <div class="mb-6">
                        <p class="text-xs font-bold text-orange-600 mb-2 uppercase">第三部分：决策偏好</p>
                        <div class="mb-4" id="q-risk1">
                            <p class="text-sm font-medium mb-2">10. 为了获得巨大的潜在收益，我愿意承担较高的失败风险。</p>
                            <div class="likert-scale" data-name="risk1"></div>
                        </div>
                        <div class="mb-4" id="q-risk2">
                            <p class="text-sm font-medium mb-2">11. 我做事通常通过“打擦边球”来提高效率。</p>
                            <div class="likert-scale" data-name="risk2"></div>
                        </div>
                        <div class="mb-4" id="q-risk3">
                            <p class="text-sm font-medium mb-2">12. 我宁愿稳妥地少赚一点，也不愿冒任何违规的风险。</p>
                            <div class="likert-scale" data-name="risk3"></div>
                        </div>
                    </div>
                    
                    <div class="h-8"></div>
                </form>
            </div>
            <!-- 底部并排按钮 -->
            <div class="nav-footer">
                <button class="btn-secondary" onclick="backToStart()">
                    ⬅️ 返回
                </button>
                <button class="btn-primary" onclick="validateAndSubmit()" id="btn-survey">
                    提交并继续 ➡️
                </button>
            </div>
        </div>

        <!-- 2. 简报 (内容微调) -->
        <div id="screen-briefing" class="hidden flex-col h-full fade-in absolute inset-0 z-15 bg-white">
            <div class="flex-1 overflow-y-auto scroll-smooth pb-32">
                <div class="header-spacer"></div>
                <div class="px-5 pt-2">
                    <h2 class="text-xl font-black text-slate-800 mb-4 border-l-4 border-blue-500 pl-3">项目概况 Briefing</h2>
                    
                    <div class="w-full h-40 mb-4 rounded-lg overflow-hidden shadow-sm border border-slate-200 relative bg-slate-100">
                        <!-- 修改：替换为更稳定的 Unsplash 图片 -->
                        <img src="https://images.unsplash.com/photo-1509391366360-2e959784a276?q=80&w=2072&auto=format&fit=crop" alt="Large Scale Solar Power Plant" class="w-full h-full object-cover">
                        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-slate-900/60 to-transparent p-2">
                            <p class="text-white text-xs font-bold">100MW 光伏 + 132kV 输电线路</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                        <div class="bg-emerald-50 border border-emerald-100 p-2 rounded">
                            <div class="text-[10px] text-emerald-600 mb-0.5">初始利润</div>
                            <div class="text-sm font-bold text-emerald-800">1000万</div>
                        </div>
                        <!-- 修改处：预计工期 -> 当前进度/合同工期 -->
                        <div class="bg-blue-50 border border-blue-100 p-2 rounded col-span-1">
                            <div class="text-[10px] text-blue-600 mb-0.5">当前进度/合同工期</div>
                            <div class="text-sm font-bold text-blue-800">12个月 / 16个月</div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-100 p-2 rounded">
                            <div class="text-[10px] text-yellow-600 mb-0.5">初始声誉</div>
                            <div class="text-sm font-bold text-yellow-800">100分</div>
                        </div>
                    </div>

                    <div class="space-y-4 text-sm text-slate-700">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <h4 class="font-bold text-slate-900 mb-1 text-xs uppercase text-blue-600">一、国家</h4>
                            <p class="text-xs">🌍 非洲某国</p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <h4 class="font-bold text-slate-900 mb-1 text-xs uppercase text-blue-600">二、项目范围</h4>
                            <ul class="list-disc pl-4 space-y-1 text-xs leading-relaxed">
                                <li>新建一座 <strong>100 MW 光伏电站</strong>；</li>
                                <li>配套建设约 <strong>80 km、132kV 输电线路</strong>，接入国家主干电网；</li>
                                <li>扩建一座现有变电站，新增 132/220kV 主变及相关设备。</li>
                            </ul>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <h4 class="font-bold text-slate-900 mb-1 text-xs uppercase text-blue-600">三、项目模式</h4>
                            <ul class="list-disc pl-4 space-y-1 text-xs leading-relaxed">
                                <li><strong>EPC 总承包</strong>；</li>
                                <li>你所在公司是该项目 EPC 总承包商，你担任<strong>项目经理</strong>角色；</li>
                                <li class="text-red-700 bg-red-50 p-1 rounded font-bold">关键条款：合同工期16个月，误期损害赔偿费100万/月。</li>
                            </ul>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <h4 class="font-bold text-slate-900 mb-1 text-xs uppercase text-blue-600">四、资金来源</h4>
                            <ul class="list-disc pl-4 space-y-1 text-xs leading-relaxed">
                                <li><strong>世界银行（World Bank）</strong>通过 IBRD/IDA 贷款和担保等方式主导融资；</li>
                                <li>项目适用世界银行<strong>《环境与社会框架》（ESF）</strong>及 10 项环境与社会标准（ESS）。</li>
                                <!-- 修改3：删除“导致强制退场” -->
                                <li class="text-red-600 font-bold bg-red-50 p-1 rounded mt-1">声誉红线：声誉分数低于 50 分将触发世行制裁。</li>
                            </ul>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <h4 class="font-bold text-slate-900 mb-1 text-xs uppercase text-blue-600">五、背景信息</h4>
                            <ul class="list-disc pl-4 space-y-2 text-[11px] leading-relaxed text-slate-600">
                                <li><strong>生态环境：</strong>项目区域涉及多种野生动物栖息地及候鸟迁徙路线，生态敏感性不确定。</li>
                                <li><strong>社会背景：</strong>征地涉及多个村庄，当地失业率较高，治安状况复杂，存在潜在社会矛盾。</li>
                                <li><strong>监管要求：</strong>世界银行ESF标准严格，但本地法律要求和监管部门的合规意识不确定。</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-footer">
                <button class="btn-secondary" onclick="backToSurvey()">⬅️ 返回</button>
                <button class="btn-primary" onclick="goToContext()" style="background-color: #2563eb;">获取任务 ➡️</button>
            </div>
        </div>

        <!-- 2.5 随机情境 (保持 v26) -->
        <div id="screen-context" class="hidden flex-col h-full fade-in absolute inset-0 z-15 bg-white">
            <div class="header-spacer"></div>
            <div class="px-6 pt-4 flex-1 overflow-y-auto pb-24">
                <div class="flex flex-col items-center text-center">
                    <h2 class="text-xl font-bold text-slate-800 mb-2">正在随机生成实验环境...</h2>
                    <p class="text-sm text-slate-500 mb-4">系统将在 3×3 矩阵中为您分配<br>企业资源与项目环境</p>
                    <div class="grid-box mb-6" id="random-grid"></div>
                    <div id="ctx-result-area" class="hidden flex-col items-center fade-in w-full">
                        <div class="bg-blue-50 border border-blue-200 p-3 rounded-xl w-full shadow-sm mb-4">
                            <div class="text-2xl mb-1">🎲</div>
                            <p class="text-xs text-blue-400 uppercase font-bold tracking-wider mb-1">随机结果</p>
                            <p id="final-ctx-text" class="text-lg font-black text-blue-800 mb-1"></p>
                        </div>
                    </div>
                    
                    <div class="bg-slate-100 p-2 rounded mb-4 text-[10px] text-slate-500 text-left leading-relaxed border border-slate-200">
                        <span class="font-bold text-slate-700">💡 逻辑说明：</span><br>
                        1. <span class="font-bold">资源越丰富</span>，企业ESG管理能力越强（如拥有专项资金和专家），能有效降低合规成本和负面影响。<br>
                        2. <span class="font-bold">项目越敏感</span>，各方关注度越高（如NGO、媒体），ESG管理不当被暴露的概率越高。
                    </div>

                    <div class="w-full text-left border-t border-slate-100 pt-2">
                        <h3 class="text-xs font-bold text-slate-800 uppercase tracking-wider mb-2">企业资源 (Resource) 说明</h3>
                        <!-- 修改3：三列布局 -->
                        <div class="ctx-desc-container">
                            <div class="ctx-desc-card" id="desc-res-low">
                                <span class="ctx-label text-slate-600">低资源 (Low)</span>
                                财务吃紧，无专门ESG团队，对项目支持十分有限，追求成本最低化。
                            </div>
                            <div class="ctx-desc-card" id="desc-res-mid">
                                <span class="ctx-label text-blue-600">中资源 (Mid)</span>
                                有一定资源储备，能支持合理的合规成本，但需平衡利润考核。
                            </div>
                             <div class="ctx-desc-card" id="desc-res-high">
                                <span class="ctx-label text-emerald-600">高资源 (High)</span>
                                资金雄厚，拥有成熟的ESG部门和专项预算，大力支持标杆项目建设。
                            </div>
                        </div>

                        <h3 class="text-xs font-bold text-slate-800 uppercase tracking-wider mb-2 mt-4">敏感度 (Sensitivity) 说明</h3>
                         <!-- 修改3：三列布局 -->
                        <div class="ctx-desc-container">
                             <div class="ctx-desc-card" id="desc-sen-low">
                                <span class="ctx-label text-green-600">低敏感度 (Low)</span>
                                项目位于偏远无人荒漠，社区稀少。NGO和媒体极少关注。
                            </div>
                             <div class="ctx-desc-card" id="desc-sen-mid">
                                <span class="ctx-label text-yellow-600">中敏感度 (Mid)</span>
                                项目周边有一定村落，涉及常规征地拆迁，存在常规社会风险。
                            </div>
                             <div class="ctx-desc-card" id="desc-sen-high">
                                <span class="ctx-label text-red-600">高敏感度 (High)</span>
                                项目位于保护区边缘，或涉及原住民圣地。NGO长期监督，违规极易暴露。
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-footer hidden" id="btn-start-matrix">
                <button class="btn-secondary" onclick="backToBriefing()">⬅️ 返回</button>
                <button class="btn-primary" onclick="goToMatrix()" style="background-color: #1e293b;">查看策略 ➡️</button>
            </div>
        </div>

        <!-- 2.6 策略矩阵 (保持 v26) -->
        <div id="screen-matrix" class="hidden flex-col h-full fade-in absolute inset-0 z-15 bg-white">
            <div class="header-spacer"></div>
            <div class="px-4 pt-2 flex-1 overflow-y-auto pb-32">
                <h2 class="text-lg font-bold text-slate-800 mb-2">SunLink ESG 响应策略表</h2>
                <p class="text-xs text-slate-500 mb-2">基于您的分配（<span id="user-ctx-summary" class="font-bold text-blue-600"></span>），不同策略的后果如下：</p>
                
                <div class="overflow-x-auto border border-slate-200 rounded shadow-sm">
                    <div id="matrix-container"></div> 
                </div>
                <p class="text-[10px] text-slate-400 mt-2 italic text-center">*表格中高亮列为您当前的资源条件，高亮文字为您当前的敏感度概率</p>
            </div>
            <div class="nav-footer">
                <button class="btn-secondary" onclick="backToContext()">⬅️ 返回</button>
                <button class="btn-primary" onclick="startGame()" style="background-color: #dc2626;">进入危机 ➡️</button>
            </div>
        </div>

        <!-- 3. 危机事件 -->
        <div id="screen-game" class="hidden flex-col h-full fade-in absolute inset-0 z-10 bg-white">
            <div class="header-spacer"></div>
            <div class="flex-1 overflow-y-auto scroll-smooth pb-32 px-4 pt-2">
                
                <!-- 动态实验组警示条 -->
                <div id="dynamic-warning" class="hidden bg-red-100 border-2 border-red-500 text-red-800 p-3 rounded mb-4 text-xs flex items-center gap-2 shadow-md animate-pulse">
                    <span class="text-2xl">⚠️</span>
                    <div>
                        <div class="font-black text-base">监管升级警告</div>
                        <div class="font-bold" id="dynamic-msg-content">项目已被重点关注！暴露概率与代价已上浮 X%！</div>
                    </div>
                </div>

                <span id="event-tag" class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded mb-2 inline-block tracking-wide">TAG</span>
                <h3 id="event-title" class="text-2xl font-black text-slate-900 mb-4 leading-snug mt-1">Title</h3>
                <div class="text-sm text-slate-700 leading-relaxed space-y-2 pb-4 mb-4 border-l-4 border-yellow-400 pl-3 bg-yellow-50 p-3 rounded-r border-y border-r border-yellow-100">
                     <div id="event-desc"></div>
                     <!-- 情境化时间压力插入点 (仅在逻辑中触发，UI上不显示红色警告文字了) -->
                     <div id="contextual-time-pressure" class="hidden mt-2 pt-2 border-t border-yellow-200 text-red-600 font-bold animate-pulse">
                     </div>
                </div>
                <div class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">请做出决策：</div>
                <div id="options-container" class="grid gap-3 pb-10"></div>
            </div>
            
             <div class="nav-footer hidden" id="game-back-container">
                <button class="btn-secondary" onclick="backFromGame()">⬅️ 返回</button>
                <button class="btn-primary disabled" style="opacity:0.3; cursor:default;">请选择上方选项</button>
            </div>
        </div>

        <!-- 4. 判定动画 -->
        <div id="screen-check" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center text-center bg-slate-900/95 text-white backdrop-blur-sm">
            <div class="text-6xl mb-6 dice-roll">🎲</div>
            <h2 class="text-xl font-bold mb-2">风险判定中...</h2>
            <p id="check-text" class="text-slate-400 text-sm">命运的硬币正在旋转...</p>
        </div>

        <!-- 5. 结算反馈 -->
        <div id="screen-result" class="hidden flex-col h-full fade-in absolute inset-0 z-10 bg-white">
            <div class="flex-1 overflow-y-auto pb-32">
                <div class="header-spacer"></div>
                <div class="px-5 pt-2 flex flex-col items-center">
                    <div id="result-icon" class="text-5xl mb-4 mt-2">🛑</div>
                    <h2 id="result-title" class="text-2xl font-black text-slate-800 mb-4 text-center">结果标题</h2>
                    <div class="bg-slate-50 rounded-xl p-4 w-full border border-slate-200 relative shadow-sm mb-4">
                        <div id="lucky-badge" class="hidden absolute -top-2 -right-2 bg-orange-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm transform rotate-3">侥幸逃脱</div>
                        <p id="result-desc" class="text-sm text-slate-700 italic leading-relaxed">...</p>
                        <div class="flex justify-center gap-3 text-xs font-bold font-mono pt-3 mt-3 border-t border-slate-200">
                            <span id="show-diff-budget" class="hidden"></span>
                            <span id="show-diff-schedule" class="hidden"></span>
                            <span id="show-diff-rep" class="hidden"></span>
                        </div>
                    </div>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-3 w-full mb-4 rounded-r text-xs leading-relaxed">
                        <span class="font-bold text-blue-800 block mb-1">💡 专家点评</span>
                        <span id="result-learning" class="text-blue-900/80">...</span>
                    </div>
                </div>
            </div>
            <div class="nav-footer">
                <button class="btn-secondary" onclick="alert('落子无悔，决策结果已生成，无法撤销。')">⬅️ 返回</button>
                <button onclick="nextLevel()" id="btn-next-level" class="btn-primary" style="background-color: #1e293b;">下一事件 ➡️</button>
            </div>
        </div>

        <!-- 6. 完工报告 (保持 v26) -->
        <div id="screen-end" class="hidden absolute inset-0 z-20 flex flex-col items-center bg-white fade-in">
             <div class="pt-4 pb-2 px-6 flex justify-center items-center border-b border-slate-100 bg-white z-10 flex-none w-full">
                 <div class="text-2xl mr-2">🌍</div>
                 <div class="font-black text-xl tracking-tight text-slate-800">SunLink <span class="text-blue-600">ESG</span></div>
            </div>
            <div class="flex-1 overflow-y-auto w-full flex flex-col items-center pb-40">
                <div class="px-6 pt-2 w-full flex flex-col items-center">
                    <div id="end-icon" class="text-6xl mt-2 mb-4">🏆</div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">完工报告</h2>
                    <div class="grid grid-cols-3 gap-2 w-full mb-6">
                        <div class="bg-slate-50 p-3 rounded border text-center">
                            <div class="text-[10px] text-slate-500 mb-1">最终利润</div>
                            <div id="end-budget" class="text-lg font-bold text-emerald-600"></div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded border text-center relative overflow-hidden">
                            <div class="text-[10px] text-slate-500 mb-1">最终工期</div>
                            <div id="end-schedule" class="text-lg font-bold text-blue-600"></div>
                            <div id="end-overdue-stamp" class="hidden absolute top-0 right-0 text-[8px] bg-red-500 text-white px-1 rounded-bl">逾期</div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded border text-center">
                            <div class="text-[10px] text-slate-500 mb-1">最终声誉</div>
                            <div id="end-rep" class="text-lg font-bold text-yellow-600"></div>
                        </div>
                    </div>

                    <!-- 对比表 (先显示) -->
                    <div class="w-full bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6">
                        <p class="text-sm font-bold text-slate-800 mb-2 border-l-4 border-indigo-500 pl-2">📊 决策路径对比分析</p>
                        <div id="loading-stats" class="text-xs text-blue-500 animate-pulse mb-2 hidden">正在同步云端学员数据...</div>

                        <table class="comp-table">
                            <thead>
                                <tr>
                                    <th>策略路径</th>
                                    <th>利润</th>
                                    <th>工期(月)</th>
                                    <th>声誉</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="highlight">
                                    <td>你的决策</td>
                                    <td id="comp-user-budget">-</td>
                                    <td id="comp-user-schedule">-</td>
                                    <td id="comp-user-rep">-</td>
                                </tr>
                                <tr class="avg-row">
                                    <td id="avg-label">👥 学员平均</td>
                                    <td id="avg-budget">计算中...</td>
                                    <td id="avg-schedule">计算中...</td>
                                    <td id="avg-rep">计算中...</td>
                                </tr>
                                <tr class="bg-emerald-100 text-emerald-800 font-medium">
                                    <td title="高资源企业，所有事件选C">最合规决策</td>
                                    <td id="bench-compliance-budget">600.00</td>
                                    <td id="bench-compliance-schedule">16.00</td>
                                    <td id="bench-compliance-rep">160.00</td>
                                </tr>
                                <tr class="bg-yellow-100 text-yellow-800 font-medium">
                                    <td title="高资源企业，所有选A且不暴露">最侥幸情况</td>
                                    <td id="bench-luck-budget">920.00</td>
                                    <td id="bench-luck-schedule">12.80</td>
                                    <td id="bench-luck-rep">100.00</td>
                                </tr>
                                <tr class="bg-red-100 text-red-800 font-medium">
                                    <td title="低资源企业，所有选A且暴露">最糟糕情况</td> <!-- 修改1：最狼狈 -> 最糟糕 -->
                                    <td id="bench-worst-budget">40.00</td>
                                    <td id="bench-worst-schedule">21.60</td>
                                    <td id="bench-worst-rep">-20.00</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="text-center mt-2">
                            <button onclick="forceRetryCloud()" class="text-[10px] text-blue-500 underline cursor-pointer hover:text-blue-700">刷新数据</button>
                        </div>
                    </div>

                    <!-- 点评 (后显示) -->
                    <div id="end-feedback" class="text-sm bg-white border border-slate-200 p-4 rounded-xl shadow-sm w-full mb-6 text-slate-700 leading-relaxed"></div>

                    <!-- 思考题 (v26) -->
                    <div class="w-full bg-blue-50/50 p-4 rounded-xl border border-blue-100 mb-6">
                        <p class="text-sm font-bold text-blue-800 mb-2">🤔 思考与讨论</p>
                        <p class="text-sm text-slate-600 leading-relaxed">
                            <!-- 修改1：文本修正 -->
                            对于国际工程 ESG 管理，经历了这个项目的种种挑战后，通过上面的对比，您有何感想？欢迎与同事或天津大学全球工程经营实验室交流。
                        </p>
                    </div>

                    <div class="mt-4 w-full text-center">
                        <!-- 修改：增大行距 -->
                        <p class="text-xs text-slate-400 font-medium mb-2">开发单位</p>
                        <p class="text-xs text-slate-600 font-bold mb-4">天津大学全球工程经营实验室</p>
                        
                        <!-- 修改：增大行距 -->
                        <p class="text-xs text-slate-400 font-medium mb-2">联系人</p>
                        <p class="text-xs text-slate-600 font-bold mb-2">傅老师 yongcheng_fu@126.com</p>
                        <div class="copyright-text">© 2025 Tianjin University GIPC. All Rights Reserved.</div>
                    </div>
                </div>
            </div>
            <div class="fixed bottom-0 left-0 w-full p-4 bg-white border-t border-slate-100 z-30 pb-safe-area">
                <button onclick="location.reload()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">再试一次</button>
            </div>
        </div>

    </main>

    <script>
        // --- 全局配置 ---
        const LIMIT_SCHEDULE = 16.0; 
        const PENALTY_PER_MONTH = 100; 

        // --- 实验变量 ---
        const CONTEXT_LEVELS = ['low', 'mid', 'high'];
        let globalContext = {
            resource: 'mid',    
            sensitivity: 'mid'  
        };
        let hasContextGenerated = false;
        
        // 新增：用于记录关卡开始时间
        let levelStartTime = 0;

        // 实验组分配：Static (0) vs Dynamic (1)
        let experimentGroup = Math.random() < 0.5 ? 'static' : 'dynamic'; 
        let dynamicMultiplier = 1.0; // 累乘系数
        let dynamicProbAdder = 0.0;  // 概率加成

        // --- 核心状态变量 ---
        let gameState = { 
            budget: 1000, 
            schedule: 12.0, 
            reputation: 100, 
            currentLevel: 0 
        };
        
        let userProfile = {
            // 基础分数
            esgScore: 0,
            riskScore: 0,
            moralScore: 0, 
            timeScore: 0,
            
            // 人口统计
            gender: "",
            age: "",
            major: "",
            role_pm: "",
            role_hse: "",
            exp_neg: "",
            
            surveyData: {}
        };
        
        let currentSessionId = null;
        let decisionPath = []; 

        // --- 页面初始化逻辑 (重写版 v33.9.47 - 3秒同步) ---
        (function() {
            const MIN_DISPLAY_TIME = 3000; // 严格同步CSS动画时间
            const MAX_WAIT_TIME = 5500;    // 兜底
            
            const startTime = Date.now();
            let hasEntered = false;

            // 核心进入函数
            function enterApp() {
                if (hasEntered) return;
                
                const now = Date.now();
                const elapsed = now - startTime;
                // 计算还需要等多久才能满足 MIN_DISPLAY_TIME
                const remaining = Math.max(0, MIN_DISPLAY_TIME - elapsed);

                // 只有当剩余等待时间 > 0 时才 setTimeout，否则直接执行
                setTimeout(() => {
                    if (hasEntered) return; // 双重检查
                    hasEntered = true;

                    const poster = document.getElementById('screen-poster');
                    const startScreen = document.getElementById('screen-start');
                    
                    if (poster) poster.style.opacity = 0; // 淡出动画
                    if (startScreen) startScreen.classList.remove('hidden');
                    
                    setTimeout(() => {
                        if (poster) poster.style.display = 'none';
                    }, 800); // 等待CSS transition结束
                }, remaining);
            }

            // 监听图片加载
            const img = document.getElementById('poster-image-element');
            if (img) {
                if (img.complete) {
                    enterApp();
                } else {
                    img.onload = enterApp;
                    img.onerror = enterApp; // 失败也进
                }
            } else {
                enterApp();
            }

            // 兜底：无论图片是否加载成功，MAX_WAIT_TIME 后强制进入
            setTimeout(enterApp, MAX_WAIT_TIME);
        })();


        // --- LeanCloud Config ---
        const LC_APP_ID = "esL6o1jmpB3rVGlkjsE6OFRu-MdYXbMMI";
        const LC_APP_KEY = "B1fDIAC8C2dXizdlslG7Cl1D";
        const LC_API_URL = "https://esl6o1jm.api.lncldglobal.com/1.1/classes/GameResult";

        // --- 数值逻辑引擎 ---
        const STRATEGY_LOGIC = {
            C: { 
                cost: {
                    high: { b: -80, s: 0.8, r: 12 },
                    mid:  { b: -100, s: 1.0, r: 10 },
                    low:  { b: -120, s: 1.2, r: 8 }
                }
            },
            B: { 
                prob: { high: 0.5, mid: 0.4, low: 0.3 },
                fail: { 
                    high: { b: -104, s: 1.04, r: -8 },
                    mid:  { b: -130, s: 1.3, r: -10 },
                    low:  { b: -156, s: 1.56, r: -12 }
                },
                success: { 
                    high: { b: -32, s: 0.32, r: 0 },
                    mid:  { b: -40, s: 0.4, r: 0 },
                    low:  { b: -48, s: 0.48, r: 0 }
                }
            },
            A: { 
                prob: { high: 0.7, mid: 0.6, low: 0.5 },
                fail: {
                    high: { b: -128, s: 1.28, r: -16 },
                    mid:  { b: -160, s: 1.6, r: -20 },
                    low:  { b: -192, s: 1.92, r: -24 }
                },
                success: {
                    high: { b: -16, s: 0.16, r: 0 },
                    mid:  { b: -20, s: 0.2, r: 0 },
                    low:  { b: -24, s: 0.24, r: 0 }
                }
            }
        };

        // --- 游戏文本数据 ---
        const gameData = [
            {
                id: 1, tag: "ESS6 生物多样性", title: "危机事件1：带血的羽毛",
                desc: "<strong>【事件描述】</strong><br>输电线路施工进入关键期。今早，在3号塔基附近发现了两只极危候鸟的尸体。此时，正好有一支国际环保NGO考察团计划在1天后访问现场。如果尸体被发现，项目将面临巨大的舆论风暴。",
                options: [
                    { type: "A", text: "这是意外。立刻清理现场，把鸟埋了，不要声张。通知安保封锁该区域，以‘施工安全’为由拒绝NGO接近该塔基。", riskRole: "NGO 无人机", riskMsg: "NGO 用无人机拍到了埋尸画面并在 Twitter 曝光。项目被勒令停工整顿。", luckyMsg: "你封锁了现场，NGO 没发现异常。但这事让你心惊肉跳。", learning: "掩盖环境事故是大忌。在数字时代，没有什么秘密能真正藏住。" },
                    { type: "B", text: "如实记录，但对外解释这是‘自然死亡’或‘既有线路造成’。同时在NGO来访前，临时挂几个驱鸟气球做做样子。", riskRole: "世行专家", riskMsg: "专家尸检证明是撞击致死。你们被认定为‘缺乏诚意’，增加了重点监管。", luckyMsg: "专家勉强接受了解释，只是简单记录了一下。", learning: "误导调查属于诚信问题，会极大损害与监管方的信任关系。" },
                    { type: "C", text: "立即停工，保护现场，通知世行和当地林业局。聘请专家评估原因，并承诺在 NGO 来访时公开整改方案（如加装鸟类转向器）。", successMsg: "主动停工整改花费巨大，但赢得了 NGO 的尊重，危机化解。", learning: "透明和专业的应对，能将危机转化为建立信任的契机。" }
                ]
            },
            {
                id: 2, tag: "ESS2 劳工条件", title: "危机事件2：沉默的工人",
                // 修改1：文本优化，“且为了方便“统一调度”” -> “为了统一调度”
                desc: "<strong>【事件描述】</strong><br>分包商为抢雨季前的工期实行“大干100天”，工人每日工作10小时以上，且没有周末休息。为了统一调度，分包商安排所有工人挤在现场周边的临时板房里，卫生条件恶劣，垃圾堆积，异味刺鼻。",
                options: [
                    { type: "A", text: "这是当地常态。只要按时发工资，工人为了赚钱是愿意吃苦的。让工头稍微注意一下垃圾清理，不要影响现场观感即可。", riskRole: "疫情爆发", riskMsg: "恶劣的卫生条件导致传染病在营地爆发，大批工人病倒。世行介入调查发现工时和居住环境严重违规。", luckyMsg: "虽然环境差了点，但大家为了加班费都忍了下来，工程进度保住了。", learning: "忽视基本的生活和工作条件（ESS2）不仅不人道，更是巨大的运营风险。" },
                    { type: "B", text: "环境太差容易滋生疾病。立即拨款改善宿舍卫生，加装风扇。至于加班，只要工人不公开抗议，为了节点只能先维持现状。", riskRole: "工会抗议", riskMsg: "改善住宿没能平息过度劳累的怨气。工会组织罢工，要求支付巨额加班费和健康赔偿。", luckyMsg: "住宿改善让工人心情好了一些，勉强维持着高强度工作直到节点。", learning: "小恩小惠无法掩盖系统性的劳动剥削，过度加班也是严重的合规问题。" },
                    { type: "C", text: "立即整改。强制限制加班工时（ESS2 劳工条件），租用外部民居以降低宿舍居住密度，确保人均居住面积和卫生达标，哪怕工期受影响。", successMsg: "成本上升，但工人效率提高，事故率下降。世行赞赏你们的人本管理。", learning: "确保供应链劳工合规是总包商不可推卸的责任（ESS2）。" }
                ]
            },
            {
                id: 3, tag: "ESS8 文化遗产", title: "危机事件3：神树拦路",
                // 修改5：去掉祖先栖息的神树周围多余的星号
                desc: "<strong>【事件描述】</strong><br>光伏场区平整土地时，推土机被村民拦下。场区中心有一棵看似普通的巨大的猴面包树。设计图纸上显示必须铲除，否则会遮挡两排组件，影响发电量。但村民坚称这是“祖先栖息的神树”，绝对不能动。",
                options: [
                    { type: "A", text: "没有什么是钱解决不了的。找村长私下谈，给村集体一笔‘祭祀费’，让我们明天把它砍了。", riskRole: "反腐机构", riskMsg: "村长私吞钱财引发暴动。这笔钱被定性为商业贿赂。", luckyMsg: "村长搞定了村民。树没了，耳根清净了。", learning: "不要试图用金钱买断文化信仰，这涉及严重的道德风险。" },
                    { type: "B", text: "这树不在官方保护名录里，土地我们也已经征下来了。夜间施工，把它推倒，造成既定事实。", riskRole: "世行红牌", riskMsg: "破坏文化遗产是世行红线。项目面临贷款取消风险。", luckyMsg: "树倒了，村民虽然骂，但没闹出大事。", learning: "尊重社区认定的文化价值，是获得‘社会许可’的前提。" },
                    { type: "C", text: "尊重社区意见。修改设计方案，保留这棵树，重新排布周围组件，哪怕损失一些发电效率。", successMsg: "虽然改设计很麻烦且昂贵，但神树成了项目友谊的象征，后续征地很顺。", learning: "包容性设计能有效规避长期的社会阻力。" }
                ]
            },
            {
                id: 4, tag: "ESS4 社区安全", title: "危机事件4：失控的保安",
                desc: "<strong>【事件描述】</strong><br>昨晚，安保公司的一名保安抓到了一名偷割电缆的村民。为了“杀鸡儆猴”，保安将该村民殴打致伤，并扣押在保安室一整夜。现在村民家属带着全村人围在门口要人，情绪极其激动。",
                options: [
                    { type: "A", text: "是他偷窃在先！把被盗电缆作为证据摆出来，支持保安的正当防卫，报警抓人。", riskRole: "社区阻工", riskMsg: "矛盾激化，进场道路被挖断，阻工半个多月。", luckyMsg: "警方带走了小偷，支持了你们的防卫说法。", learning: "偷窃是法律问题，但滥用私刑是人权问题，性质完全不同。" },
                    { type: "B", text: "千万别让世行知道。给伤者付医药费和赔偿金，把打人的保安连夜送走（开除），对外说是村民摔伤的。", riskRole: "合规调查", riskMsg: "医院报告泄露了殴打事实。隐瞒严重事故罪加一等。", luckyMsg: "家属拿钱闭嘴了，事情压下去了。", learning: "发生事故必须如实上报，隐瞒会被视为管理体系失效。" },
                    { type: "C", text: "立刻放人并送医。向社区公开道歉，承认安保过度执法。立即向世行报告该‘严重事故’，并配合警方调查保安。", successMsg: "快速反应机制得到了认可，赔偿虽然肉痛，但事态没有进一步扩大。", learning: "快速救治和平息事态是危机处理的第一原则。" }
                ]
            },
            {
                id: 5, tag: "ESS5 土地征用和非自愿移民", title: "危机事件5：看不见的“邻居”",
                desc: "<strong>【事件描述】</strong><br>在项目外围的一片荒地上，你们计划建设临时堆料场。土地权属显示这是“国有荒地”，手续齐全。但进场时发现，有几个游牧家庭（无固定居所）正在这里临时搭帐篷放牧。",
                options: [
                    { type: "A", text: "这是国有土地，我们有证。通知警察和政府，请他们依法离开。", riskRole: "人权观察", riskMsg: "强驱视频被曝光。ESS5 保护无证的传统使用者，你们严重违规。", luckyMsg: "他们看对方人多势众，吓跑了。", learning: "土地证不是唯一依据，生计和传统权益必须被尊重。" },
                    { type: "B", text: "给点米面油和少许现金，劝他们去别的地方。", riskRole: "NGO", riskMsg: "NGO 指控你们利用贫穷进行剥削。补偿必须基于重置成本。", luckyMsg: "他们拿了点钱，搬到了几公里外。", learning: "非正式的施舍无法解决根本的生计恢复问题。" },
                    { type: "C", text: "将他们识别为‘非正式占有者’（ESS5）。评估搬迁对他们生计（放牧）的影响，提供替代牧场建议或生计补偿方案，在方案达成前暂不强推。", successMsg: "流程繁琐且补偿金极高，但彻底消除了法律隐患。", learning: "妥善处理非自愿移民，是大型项目可持续的基础。" }
                ]
            }
        ];

        function fmt(n) {
            if(typeof n !== 'number') return n;
            return n.toFixed(2);
        }

        // --- 返回上一页逻辑 ---
        function backToStart() {
            document.getElementById('screen-survey').classList.add('hidden');
            document.getElementById('screen-survey').classList.remove('flex');
            document.getElementById('screen-start').classList.remove('hidden');
        }

        function backToSurvey() {
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('screen-briefing').classList.add('hidden');
            document.getElementById('screen-briefing').classList.remove('flex');
            document.getElementById('screen-survey').classList.remove('hidden');
            document.getElementById('screen-survey').classList.add('flex');
        }

        function backToBriefing() {
            document.getElementById('screen-context').classList.add('hidden');
            document.getElementById('screen-context').classList.remove('flex');
            document.getElementById('screen-briefing').classList.remove('hidden');
            document.getElementById('screen-briefing').classList.add('flex');
        }

        function backToContext() {
            document.getElementById('screen-matrix').classList.add('hidden');
            document.getElementById('screen-matrix').classList.remove('flex');
            document.getElementById('screen-context').classList.remove('hidden');
            document.getElementById('screen-context').classList.add('flex');
        }
        
        function backFromGame() {
            if(gameState.currentLevel === 0) {
                document.getElementById('screen-game').classList.add('hidden');
                document.getElementById('screen-game').classList.remove('flex');
                document.getElementById('screen-matrix').classList.remove('hidden');
                document.getElementById('screen-matrix').classList.add('flex');
            } else {
                alert("已进入后续关卡，为保证模拟真实性，不可退回上一关。");
            }
        }

        // --- 问卷逻辑 ---
        function goToSurvey() {
            document.getElementById('screen-start').classList.add('hidden');
            document.getElementById('screen-survey').classList.remove('hidden');
            document.getElementById('screen-survey').classList.add('flex');
            renderLikertScales();
            updateUI(); // 初始化顶部状态栏
        }

        function renderLikertScales() {
            if(document.querySelector('.likert-opt')) return;
            
            const scales = document.querySelectorAll('.likert-scale');
            scales.forEach(el => {
                const name = el.dataset.name;
                for(let i=1; i<=5; i++) {
                    let label = "";
                    if(i===1) label = "完全<br>不同意";
                    if(i===2) label = "不同意";
                    if(i===3) label = "中立";
                    if(i===4) label = "同意";
                    if(i===5) label = "完全<br>同意";
                    el.innerHTML += `
                        <div class="likert-opt" onclick="selectLikert('${name}', ${i}, this)">
                            <div class="likert-circle">${i}</div>
                            <span class="likert-label">${label}</span>
                        </div>
                    `;
                }
            });
        }

        function selectLikert(name, val, el) {
            userProfile.surveyData[name] = val;
            const parent = el.parentElement;
            Array.from(parent.children).forEach(child => child.classList.remove('selected'));
            el.classList.add('selected');
            parent.classList.remove('scroll-highlight'); // 移除高亮
        }

        // 单选框辅助函数
        function selectRadio(el, field, val) {
            const group = el.parentElement;
            const inputs = document.querySelectorAll(`input[name="${field}"]`);
            inputs.forEach(input => {
                input.parentElement.classList.remove('checked');
            });
            el.classList.add('checked');
            userProfile[field] = val;
            el.closest('.form-group').classList.remove('scroll-highlight'); // 移除高亮
        }

        // 监听 Select 变化移除高亮
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('form-select')) {
                userProfile[e.target.dataset.field] = e.target.value;
                if(e.target.value) {
                    e.target.closest('.form-group').classList.remove('scroll-highlight');
                }
            }
        });

        function validateAndSubmit() {
            // 收集当前数据
            const d = userProfile.surveyData;
            
            // 定义所有需要检查的字段ID
            const checks = [
                { id: 'q-gender', val: userProfile.gender },
                { id: 'q-age', val: userProfile.age },
                { id: 'q-major', val: userProfile.major },
                { id: 'q-pm', val: userProfile.role_pm },
                { id: 'q-hse', val: userProfile.role_hse },
                { id: 'q-exp', val: userProfile.exp_neg },
                { id: 'q-moral1', val: d.moral1 },
                { id: 'q-moral2', val: d.moral2 },
                { id: 'q-moral3', val: d.moral3 },
                { id: 'q-time1', val: d.time1 },
                { id: 'q-time2', val: d.time2 },
                { id: 'q-time3', val: d.time3 },
                { id: 'q-esg1', val: d.esg1 },
                { id: 'q-esg2', val: d.esg2 },
                { id: 'q-esg3', val: d.esg3 },
                { id: 'q-risk1', val: d.risk1 },
                { id: 'q-risk2', val: d.risk2 },
                { id: 'q-risk3', val: d.risk3 },
            ];

            let firstErrorId = null;

            // 清除旧的高亮
            document.querySelectorAll('.scroll-highlight').forEach(el => el.classList.remove('scroll-highlight'));

            checks.forEach(item => {
                if (!item.val) {
                    const el = document.getElementById(item.id);
                    if(el) {
                        el.classList.add('scroll-highlight');
                        if(!firstErrorId) firstErrorId = item.id;
                    }
                }
            });

            if (firstErrorId) {
                // 滚动到第一个错误
                const errorEl = document.getElementById(firstErrorId);
                errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // 可以加个震动或者提示
                return;
            }

            submitSurvey();
        }

        function submitSurvey(e) {
            if(e) e.preventDefault();
            const d = userProfile.surveyData;
            
            // 计算各维度分数
            userProfile.esgScore = ((6 - d.esg1) + (6 - d.esg2) + d.esg3) / 3; 
            userProfile.riskScore = (d.risk1 + d.risk2 + (6 - d.risk3)) / 3;
            userProfile.moralScore = (d.moral1 + d.moral2 + d.moral3) / 3;
            userProfile.timeScore = (d.time1 + d.time2 + (6 - d.time3)) / 3;
            
            goToBriefing();
        }

        // --- 流程跳转 ---
        function goToBriefing() {
            document.getElementById('screen-survey').classList.add('hidden');
            document.getElementById('screen-survey').classList.remove('flex');
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('screen-briefing').classList.remove('hidden');
            document.getElementById('screen-briefing').classList.add('flex');
        }

        function goToContext() {
            document.getElementById('screen-briefing').classList.add('hidden');
            document.getElementById('screen-briefing').classList.remove('flex');
            document.getElementById('screen-context').classList.remove('hidden');
            document.getElementById('screen-context').classList.add('flex');
            if (!hasContextGenerated) {
                runContextAnimation();
            } else {
                showSavedContext();
            }
        }

        // --- 九宫格动画 & 逻辑 ---
        function runContextAnimation() {
            document.getElementById('btn-start-matrix').classList.add('hidden');
            document.getElementById('btn-start-matrix').classList.remove('flex');
            const grid = document.getElementById('random-grid');
            grid.innerHTML = '';
            const resList = ['low', 'mid', 'high'];
            const senList = ['low', 'mid', 'high'];
            
            // 生成所有可能的组合
            const combinations = [];
            resList.forEach(r => { senList.forEach(s => { combinations.push({ r, s }); }); });
            
            // 渲染9个格子
            combinations.forEach((c, idx) => {
                const el = document.createElement('div');
                el.className = `grid-cell grid-cell-${idx}`;
                el.innerHTML = `<div class="grid-cell-text">${getResDescShort(c.r)}</div><div class="grid-cell-sub">+${getSenDescShort(c.s)}</div>`;
                grid.appendChild(el);
            });

            // 修改1：确保完全随机，直接从 0-8 中选一个索引
            const targetIndex = Math.floor(Math.random() * combinations.length); // 0-8
            const target = combinations[targetIndex];
            globalContext.resource = target.r;
            globalContext.sensitivity = target.s;

            let jumps = 0;
            let currentHighlight = 0;
            const maxJumps = 15 + Math.floor(Math.random() * 5);
            const cells = document.querySelectorAll('.grid-cell');
            const interval = setInterval(() => {
                cells.forEach(c => c.classList.remove('active'));
                currentHighlight = (currentHighlight + 1) % 9;
                cells[currentHighlight].classList.add('active');
                jumps++;
                if (jumps > maxJumps && currentHighlight === targetIndex) {
                    clearInterval(interval);
                    hasContextGenerated = true;
                    setTimeout(showContextResult, 500);
                }
            }, 100);
        }

        function showSavedContext() {
             const grid = document.getElementById('random-grid');
            grid.innerHTML = '';
            const resList = ['low', 'mid', 'high'];
            const senList = ['low', 'mid', 'high'];
            const combinations = [];
            resList.forEach(r => { senList.forEach(s => { combinations.push({ r, s }); }); });
            const targetIndex = combinations.findIndex(c => c.r === globalContext.resource && c.s === globalContext.sensitivity);
            combinations.forEach((c, idx) => {
                const el = document.createElement('div');
                el.className = `grid-cell ${idx === targetIndex ? 'active' : ''}`;
                if (idx === targetIndex) el.style.opacity = 1;
                el.innerHTML = `<div class="grid-cell-text">${getResDescShort(c.r)}</div><div class="grid-cell-sub">+${getSenDescShort(c.s)}</div>`;
                grid.appendChild(el);
            });
            showContextResult();
        }

        function showContextResult() {
            const footer = document.getElementById('btn-start-matrix');
            footer.classList.remove('hidden');
            footer.classList.add('flex');
            document.getElementById('ctx-result-area').classList.remove('hidden');
            document.getElementById('ctx-result-area').classList.add('flex');
            document.getElementById('final-ctx-text').innerText = `${getResDescShort(globalContext.resource)} + ${getSenDescShort(globalContext.sensitivity)}`;
            document.querySelectorAll('.ctx-desc-card').forEach(el => el.classList.remove('highlighted'));
            document.getElementById(`desc-res-${globalContext.resource}`).classList.add('highlighted');
            document.getElementById(`desc-sen-${globalContext.sensitivity}`).classList.add('highlighted');
        }

        function getResDescShort(l) { return l==='low'?'低资源':(l==='mid'?'中资源':'高资源'); }
        function getSenDescShort(l) { return l==='low'?'低敏感度':(l==='mid'?'中敏感度':'高敏感度'); }

        function goToMatrix() {
            document.getElementById('screen-context').classList.add('hidden');
            document.getElementById('screen-context').classList.remove('flex');
            document.getElementById('screen-matrix').classList.remove('hidden');
            document.getElementById('screen-matrix').classList.add('flex');
            renderMatrix();
        }

        function buildProbString(lowText, midText, highText) {
            const s = globalContext.sensitivity;
            const t1 = s === 'low' ? `<span class="prob-highlight">${lowText}</span>` : lowText;
            const t2 = s === 'mid' ? `<span class="prob-highlight">${midText}</span>` : midText;
            const t3 = s === 'high' ? `<span class="prob-highlight">${highText}</span>` : highText;
            return `暴露概率: ${t1} | ${t2} | ${t3}`;
        }

        function renderMatrix() {
            const r = globalContext.resource;
            document.getElementById('user-ctx-summary').innerText = `${getResDescShort(r)} + ${getSenDescShort(globalContext.sensitivity)}`;
            
            let html = `
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width:15%">策略</th>
                            <th rowspan="2" style="width:15%">状态</th>
                            <th colspan="3">利润影响</th>
                            <th colspan="3">工期影响(月)</th>
                            <th colspan="3">声誉影响</th>
                        </tr>
                        <tr>
                            <th class="${r==='low'?'matrix-highlight':''}">低资源</th>
                            <th class="${r==='mid'?'matrix-highlight':''}">中资源</th>
                            <th class="${r==='high'?'matrix-highlight':''}">高资源</th>
                            <th class="${r==='low'?'matrix-highlight':''}">低资源</th>
                            <th class="${r==='mid'?'matrix-highlight':''}">中资源</th>
                            <th class="${r==='high'?'matrix-highlight':''}">高资源</th>
                            <th class="${r==='low'?'matrix-highlight':''}">低资源</th>
                            <th class="${r==='mid'?'matrix-highlight':''}">中资源</th>
                            <th class="${r==='high'?'matrix-highlight':''}">高资源</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // 修改4：调整渲染顺序 A -> B -> C，并添加背景色

            // A 部分 (bg-red-50)
            html += `
                <tr class="bg-red-50">
                    <td rowspan="3" class="font-bold text-red-600 border border-red-200">A 逃避</td>
                    <td class="prob-row border border-red-200" colspan="10">
                        ${buildProbString('低敏感50%', '中敏感60%', '高敏感70%')}
                    </td>
                </tr>
                <tr class="bg-red-50">
                    <td class="text-[8px] border border-red-200">未暴露</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">-24</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">-20</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">-16</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">+0.24</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">+0.2</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">+0.16</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">0</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">0</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">0</td>
                </tr>
                <tr class="bg-red-50">
                    <td class="text-[8px] text-red-500 border border-red-200">暴露</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">-192</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">-160</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">-128</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">+1.92</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">+1.6</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">+1.28</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">-24</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">-20</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">-16</td>
                </tr>
            `;

            // B 部分 (bg-yellow-50)
            html += `
                <tr class="bg-yellow-50">
                    <td rowspan="3" class="font-bold text-yellow-600 border border-yellow-200">B 妥协</td>
                    <td class="prob-row border border-yellow-200" colspan="10">
                        ${buildProbString('低敏感30%', '中敏感40%', '高敏感50%')}
                    </td>
                </tr>
                <tr class="bg-yellow-50">
                    <td class="text-[8px] border border-yellow-200">未暴露</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">-48</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">-40</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">-32</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">+0.48</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">+0.4</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">+0.32</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">0</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">0</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">0</td>
                </tr>
                <tr class="bg-yellow-50">
                    <td class="text-[8px] text-red-500 border border-yellow-200">暴露</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">-156</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">-130</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">-104</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">+1.56</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">+1.3</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">+1.04</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">-12</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">-10</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">-8</td>
                </tr>
            `;
            
            // C 部分 (bg-green-50)
            html += `
                <tr class="bg-green-50">
                    <td class="font-bold text-green-600 border border-green-200">C 合规</td>
                    <td class="border border-green-200">-</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-green-200'}">-120</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-green-200'}">-100</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-green-200'}">-80</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-green-200'}">+1.2</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-green-200'}">+1.0</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-green-200'}">+0.8</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-green-200'}">+8</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-green-200'}">+10</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-green-200'}">+12</td>
                </tr>
            `;

            html += "</tbody></table>";
            document.getElementById('matrix-container').innerHTML = html;
        }

        // --- 游戏核心逻辑 ---

        function startGame() {
            gameState = { budget: 1000, schedule: 12.0, reputation: 100, currentLevel: 0 };
            decisionPath = [];
            dynamicMultiplier = 1.0; // 重置系数
            dynamicProbAdder = 0.0; // 重置概率
            updateUI();
            document.getElementById('screen-matrix').classList.add('hidden');
            document.getElementById('screen-matrix').classList.remove('flex');
            document.getElementById('screen-game').classList.remove('hidden');
            document.getElementById('screen-game').classList.add('flex');
            document.getElementById('game-back-container').classList.remove('hidden');
            document.getElementById('game-back-container').classList.add('flex');
            loadLevel(0);
        }

        function loadLevel(index) {
            if (index >= gameData.length) { endGame(); return; }
            if(index > 0) {
                 document.getElementById('game-back-container').classList.add('hidden');
                 document.getElementById('game-back-container').classList.remove('flex');
            }
            gameState.currentLevel = index;
            const data = gameData[index];
            document.getElementById('screen-result').classList.add('hidden');
            document.getElementById('screen-result').classList.remove('flex');
            document.getElementById('screen-game').classList.remove('hidden');
            document.getElementById('screen-game').classList.add('flex');
            document.querySelector('#screen-game .overflow-y-auto').scrollTop = 0;

            // 更新顶部状态栏
            updateUI(); 

            // 动态组警告逻辑 (累进式)
            const warningEl = document.getElementById('dynamic-warning');
            const warningMsg = document.getElementById('dynamic-msg-content');
            if (experimentGroup === 'dynamic' && dynamicMultiplier > 1.0) {
                warningEl.classList.remove('hidden');
                const increasePct = Math.round((dynamicMultiplier - 1.0) * 100);
                warningMsg.innerText = `项目已被重点关注！暴露概率与代价已上浮 ${increasePct}%！`;
            } else {
                warningEl.classList.add('hidden');
            }

            const btnNext = document.getElementById('btn-next-level');
            btnNext.onclick = null;
            if(index === 4) {
                btnNext.innerText = "查看最终结果 🏁";
                btnNext.onclick = function() { endGame(); };
            } else {
                btnNext.innerText = "下一事件 ➡️";
                btnNext.onclick = function() { nextLevel(); };
            }

            document.getElementById('level-indicator').innerText = `Level ${index + 1}/5`;
            document.getElementById('progress-bar').style.width = `${(index / gameData.length) * 100}%`;
            document.getElementById('event-tag').innerText = data.tag;
            document.getElementById('event-title').innerText = data.title;
            document.getElementById('event-desc').innerHTML = data.desc;

            // 情境化时间压力 (仅逻辑，不显示警告)
            const timePressureEl = document.getElementById('contextual-time-pressure');
            timePressureEl.classList.add('hidden');
            timePressureEl.innerHTML = ''; // 清空内容
            
            if (index >= 3) {
                // 仅保留逻辑检查点，如果未来需要恢复功能
                if (gameState.schedule > 14.5) {
                   // hidden 保持
                }
            }

            const container = document.getElementById('options-container');
            container.innerHTML = ''; 
            
            // 强耦合 UI 样式准备
            let budgetStyle = "";
            let repStyle = "";
            if (userProfile.timeScore <= 2) budgetStyle = "highlight-short-term"; 
            if (userProfile.timeScore >= 4) repStyle = "highlight-long-term";

            // 预先计算所有选项的当前数据，以便记录和显示
            const currentOptionsData = {};
            ['A', 'B', 'C'].forEach(type => {
                currentOptionsData[type] = calculateOptionImpact(type);
            });

            data.options.forEach((opt) => {
                const calc = currentOptionsData[opt.type];
                const btn = document.createElement('button');
                
                // 修改4：为不同选项设置背景颜色 (A: Red-50, B: Yellow-50, C: Green-50)
                let bgClass = "";
                let borderClass = "";
                if (opt.type === 'A') { bgClass = "bg-red-50"; borderClass = "border-red-200"; }
                else if (opt.type === 'B') { bgClass = "bg-yellow-50"; borderClass = "border-yellow-200"; }
                else if (opt.type === 'C') { bgClass = "bg-green-50"; borderClass = "border-green-200"; }
                else { bgClass = "bg-white"; borderClass = "border-slate-200"; }

                btn.className = `relative w-full text-left ${bgClass} border ${borderClass} rounded-xl p-3 shadow-sm active:scale-[0.98] transition-all duration-100 hover:shadow-md`;
                
                // 修改3：传递完整的 currentOptionsData 给 handleDecision
                btn.onclick = () => handleDecision(opt, calc, currentOptionsData);

                let riskLabel = "";
                let costPreview = "";
                
                if (opt.type === 'C') {
                    riskLabel = `<span class="text-[10px] px-2 py-0.5 rounded-full font-medium text-green-700 bg-white border border-green-200">安全合规</span>`;
                    costPreview = `<span class='text-green-700'>固定结果: <span class="${budgetStyle}">利润${fmt(calc.c.b)}</span> | 工期+${fmt(calc.c.s)} | <span class="${repStyle}">声誉+${fmt(calc.c.r)}</span></span>`;
                } else {
                    const probPct = (calc.prob * 100).toFixed(0);
                    const riskColor = opt.type === 'A' ? 'text-red-600 bg-white border-red-200' : 'text-yellow-600 bg-white border-yellow-200';
                    const labelText = opt.type === 'A' ? '逃避 (高风险)' : '妥协 (中风险)';
                    riskLabel = `<span class="text-[10px] px-2 py-0.5 rounded-full font-medium ${riskColor} border">${labelText}</span>`;
                    
                    costPreview = `
                        <span class='text-slate-500'>${100-probPct}% 未暴露: <span class="${budgetStyle}">利润${fmt(calc.success.b)}</span> | 工期+${fmt(calc.success.s)}</span><br>
                        <span class='text-red-600'>${probPct}% 暴露: <span class="${budgetStyle}">利润${fmt(calc.fail.b)}</span> | 工期+${fmt(calc.fail.s)} | <span class="${repStyle}">声誉${fmt(calc.fail.r)}</span></span>
                    `;
                }

                btn.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="bg-slate-800 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center text-xs shadow-sm flex-none">${opt.type}</span>
                        ${riskLabel}
                    </div>
                    <p class="text-sm font-bold text-slate-700 leading-tight mb-2">${opt.text}</p>
                    <div class="text-[10px] bg-white/60 p-2 rounded border border-slate-100/50 leading-snug">
                        ${costPreview}
                    </div>
                `;
                container.appendChild(btn);
            });

            // 新增：重置计时器
            levelStartTime = Date.now();
        }

        function calculateOptionImpact(type) {
            const r = globalContext.resource;
            const s = globalContext.sensitivity;
            
            // 动态实验组：使用全局累乘系数
            let probMod = 0;
            let costFactor = 1.0;

            if (experimentGroup === 'dynamic') {
                probMod = dynamicProbAdder;
                costFactor = dynamicMultiplier;
            }

            if (type === 'C') {
                return { c: STRATEGY_LOGIC.C.cost[r] };
            } else {
                const logic = STRATEGY_LOGIC[type];
                let baseProb = logic.prob[s];
                let finalProb = Math.min(baseProb + probMod, 1.0); // 封顶100%
                
                // 只有失败（暴露）的代价会增加
                const failRaw = logic.fail[r];
                const failAdjusted = {
                    b: failRaw.b * costFactor,
                    s: failRaw.s * costFactor,
                    r: failRaw.r * costFactor
                };

                return {
                    prob: finalProb,
                    fail: failAdjusted,
                    success: logic.success[r]
                };
            }
        }

        function handleDecision(opt, calc, allOptionsCalc) {
            // 新增：计算决策耗时 (秒)
            const duration = (Date.now() - levelStartTime) / 1000;

            // 修改3：记录决策时的当前状态 + 所有选项的具体参数 + 耗时
            decisionPath.push({ 
                level: gameState.currentLevel, 
                type: opt.type, 
                exposed: false,
                duration: duration, // <--- 新增字段
                // 快照当前状态 (决策前)
                snapshot: {
                    budget: gameState.budget,
                    schedule: gameState.schedule,
                    reputation: gameState.reputation
                },
                // 快照所有选项的参数 (用于分析动态惩罚的影响)
                optionsSnapshot: allOptionsCalc
            });
            
            if (opt.type === 'C') {
                resolveSafe(opt, calc.c);
            } else {
                document.getElementById('screen-check').classList.remove('hidden');
                document.getElementById('screen-check').classList.add('flex');
                document.getElementById('check-text').innerText = `风险判定中 (暴露概率 ${(calc.prob * 100).toFixed(0)}%)...`;
                setTimeout(() => {
                    document.getElementById('screen-check').classList.add('hidden');
                    document.getElementById('screen-check').classList.remove('flex');
                    resolveRisk(opt, calc);
                }, 1500);
            }
        }

        function resolveSafe(opt, cost) {
            applyResult({
                budget: cost.b,
                schedule: cost.s,
                rep: cost.r,
                isFail: false,
                title: "合规通过",
                desc: opt.successMsg,
                learning: opt.learning
            });
        }

        function resolveRisk(opt, calc) {
            const isCaught = Math.random() < calc.prob; 
            decisionPath[decisionPath.length - 1].exposed = isCaught;

            if (isCaught) {
                // 累进式惩罚逻辑：每次暴露，系数 * 1.1
                if (experimentGroup === 'dynamic') {
                    dynamicMultiplier *= 1.1;
                    dynamicProbAdder += 0.1; // 概率每次+10%
                }
                applyResult({
                    budget: calc.fail.b,
                    schedule: calc.fail.s,
                    rep: calc.fail.r,
                    isFail: true,
                    title: "风险暴露！",
                    desc: opt.riskMsg,
                    learning: opt.learning
                });
            } else {
                applyResult({
                    budget: calc.success.b,
                    schedule: calc.success.s,
                    rep: calc.success.r,
                    isFail: false,
                    isLucky: true,
                    title: "侥幸过关",
                    desc: opt.luckyMsg,
                    learning: opt.learning
                });
            }
        }

        function applyResult(result) {
            updateStat('budget', result.budget);
            updateStat('schedule', result.schedule);
            updateStat('reputation', result.rep);

            const screenResult = document.getElementById('screen-result');
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('flex');
            
            screenResult.classList.remove('hidden');
            screenResult.classList.add('flex');
            document.querySelector('#screen-result .overflow-y-auto').scrollTop = 0;

            const rIcon = document.getElementById('result-icon');
            const rTitle = document.getElementById('result-title');
            const rDesc = document.getElementById('result-desc');
            const rLearn = document.getElementById('result-learning');
            const rBadge = document.getElementById('lucky-badge');

            showDiff('show-diff-budget', result.budget, '利润');
            showDiff('show-diff-schedule', result.schedule, '工期');
            showDiff('show-diff-rep', result.rep, '声誉');

            rDesc.innerText = result.desc;
            rLearn.innerText = result.learning;
            rBadge.classList.add('hidden');

            if (result.isFail) {
                rIcon.innerText = "🛑";
                rTitle.className = "text-2xl font-black text-red-600 mb-4 text-center";
                rTitle.innerText = result.title;
                screenResult.classList.add('shake');
            } else if (result.isLucky) {
                rIcon.innerText = "😅";
                rTitle.className = "text-2xl font-black text-orange-500 mb-4 text-center";
                rTitle.innerText = result.title;
                rBadge.classList.remove('hidden');
                screenResult.classList.remove('shake');
            } else {
                rIcon.innerText = "✅";
                rTitle.className = "text-2xl font-black text-emerald-600 mb-4 text-center";
                rTitle.innerText = result.title;
                screenResult.classList.remove('shake');
            }
        }

        function showDiff(id, val, unit) {
            const el = document.getElementById(id);
            if (!val || val === 0) { el.classList.add('hidden'); return; }
            el.classList.remove('hidden');
            const prefix = val > 0 ? "+" : "";
            el.innerText = `${unit}${prefix}${val.toFixed(2)}`;
            if (unit === '工期') {
                el.className = val > 0 ? 'text-red-500' : 'text-emerald-500';
            } else {
                el.className = val > 0 ? 'text-emerald-500' : 'text-red-500';
            }
        }

        function updateStat(key, delta) {
            gameState[key] += delta;
            updateUI();
            if(delta !== 0) {
                const floatEl = document.getElementById(`float-${key}`);
                floatEl.innerText = delta > 0 ? `+${delta.toFixed(2)}` : delta.toFixed(2);
                floatEl.className = `stat-float text-sm ${delta > 0 ? (key === 'schedule' ? 'text-red-600' : 'text-emerald-600') : (key === 'schedule' ? 'text-emerald-600' : 'text-red-600')}`;
                floatEl.style.animation = 'none';
                floatEl.offsetHeight; 
                floatEl.style.animation = null; 
            }
        }

        function updateUI() {
            document.getElementById('val-budget').innerText = gameState.budget.toFixed(2);
            
            // 逻辑修改：状态栏显示剩余或延误
            const lbl = document.getElementById('lbl-schedule');
            const valEl = document.getElementById('val-schedule');
            const box = document.getElementById('box-schedule');

            if (gameState.schedule <= LIMIT_SCHEDULE) {
                const remaining = LIMIT_SCHEDULE - gameState.schedule;
                lbl.innerText = "进度(剩余)";
                valEl.innerText = remaining.toFixed(1); 
                valEl.className = "text-blue-600 text-base"; // 默认蓝色
                
                // 剩余工期 < 2个月，整个框闪烁
                if (remaining < 2.0) {
                    valEl.className = "text-red-600 text-base font-bold"; // 文字变红
                    box.classList.add('animate-box-flash'); // 增加闪烁动画类
                } else {
                    box.classList.remove('animate-box-flash');
                }

            } else {
                // 延误情况
                const overdue = gameState.schedule - LIMIT_SCHEDULE;
                lbl.innerText = "进度(延误)";
                valEl.innerText = "-" + overdue.toFixed(1);
                valEl.className = "text-red-600 text-base font-bold";
                // 逻辑修改：延误时也要闪烁
                box.classList.add('animate-box-flash'); 
            }
            
            document.getElementById('val-reputation').innerText = gameState.reputation.toFixed(2);
        }

        function nextLevel() {
            const nextIndex = gameState.currentLevel + 1;
            loadLevel(nextIndex);
        }

        async function endGame() {
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('screen-result').classList.add('hidden');
            document.getElementById('screen-result').classList.remove('flex');
            document.getElementById('screen-end').classList.remove('hidden');
            document.getElementById('screen-end').classList.add('flex');
            document.getElementById('progress-bar').style.width = '100%';
            document.querySelector('#screen-end .overflow-y-auto').scrollTop = 0;

            let finalBudget = gameState.budget; 
            let schedulePenalty = 0;
            // 逻辑修改：记录是否发生延误
            const isDelayed = gameState.schedule > LIMIT_SCHEDULE;

            if (isDelayed) {
                const overdue = gameState.schedule - LIMIT_SCHEDULE;
                schedulePenalty = Math.ceil(overdue * PENALTY_PER_MONTH); 
                finalBudget -= schedulePenalty;
                document.getElementById('end-overdue-stamp').classList.remove('hidden');
            }
            gameState.budget = finalBudget; 
            
            // 更新 UI
            document.getElementById('end-budget').innerText = finalBudget.toFixed(2);
            document.getElementById('end-schedule').innerText = gameState.schedule.toFixed(2);
            document.getElementById('end-rep').innerText = gameState.reputation.toFixed(2);
            document.getElementById('comp-user-budget').innerText = finalBudget.toFixed(2);
            document.getElementById('comp-user-schedule').innerText = gameState.schedule.toFixed(2);
            document.getElementById('comp-user-rep').innerText = gameState.reputation.toFixed(2);

            // --- 1. 智能点评逻辑优化 (v33.9.55 - 科学对比版) ---
            
            // 默认备用中性值 (Fallback / Theoretical Neutral)
            // 用于当云端无法连接或云端没有数据时
            let industryAvg = { budget: 600.0, schedule: 16.0, rep: 60.0 };
            let avgCount = 0;

            // 尝试同步获取云端平均数据
            try {
                const response = await fetch(LC_API_URL + '?limit=200&order=-createdAt', {
                    method: 'GET',
                    headers: { 'X-LC-Id': LC_APP_ID, 'X-LC-Key': LC_APP_KEY, 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const data = await response.json();
                    const results = data.results || [];
                    if (results.length > 0) {
                        let sumB = 0, sumS = 0, sumR = 0;
                        results.forEach(r => { 
                            sumB += (r.budget || 0); 
                            sumS += (r.schedule || 0); 
                            sumR += (r.reputation || 0); 
                        });
                        industryAvg.budget = sumB / results.length;
                        industryAvg.schedule = sumS / results.length;
                        industryAvg.rep = sumR / results.length;
                        avgCount = results.length;
                    }
                }
            } catch (e) {
                console.warn("点评数据预加载失败，使用理论中性值", e);
            }

            // 定义基准线
            const bestCompliance = { budget: 600, schedule: 16.0, rep: 160.0 }; // 最佳合规
            const repThreshold = 50; // 制裁线

            let feedbackHTML = "";
            let analysisText = "";

            // 计算差距
            const diffAvgBudget = finalBudget - industryAvg.budget;
            const diffAvgRep = gameState.reputation - industryAvg.rep;
            const diffCompRep = gameState.reputation - bestCompliance.rep;

            // --- A. 策略风格分析 ---
            const riskCount = decisionPath.filter(d => d.type === 'A').length; // 激进次数
            const safeCount = decisionPath.filter(d => d.type === 'C').length; // 保守次数
            
            let styleDesc = "";
            if (riskCount >= 3) {
                styleDesc = "您采取了<b>激进冒险</b>的策略组合（多次选择A方案），倾向于以博弈换取短期利益。";
            } else if (safeCount >= 3) {
                styleDesc = "您采取了<b>高度稳健</b>的合规策略（多次选择C方案），展现了对风险的极度厌恶。";
            } else {
                styleDesc = "您采取了<b>灵活务实</b>的混合策略，在不同情境下权衡了利弊。";
            }

            // --- B. 结果对比评价 ---
            
            // 1. 利润评价
            let budgetEval = "";
            if (finalBudget > industryAvg.budget + 100) {
                budgetEval = `经济效益<span class="text-emerald-600 font-bold">显著优于行业平均</span>`;
            } else if (finalBudget < industryAvg.budget - 100) {
                budgetEval = `经济效益<span class="text-red-600 font-bold">低于行业平均</span>`;
            } else {
                budgetEval = `经济效益与行业平均<span class="text-blue-600 font-bold">持平</span>`;
            }

            // 2. 声誉评价 (双重对比)
            let repEval = "";
            if (gameState.reputation >= bestCompliance.rep - 10) {
                repEval = `声誉表现达到了<span class="text-indigo-600 font-bold">最佳合规标杆</span>水准`;
            } else if (gameState.reputation > industryAvg.rep + 20) {
                repEval = `声誉积累<span class="text-emerald-600 font-bold">远超同僚</span>`;
            } else if (gameState.reputation < industryAvg.rep - 20) {
                repEval = `声誉<span class="text-yellow-600 font-bold">落后于行业主流</span>`;
            } else {
                repEval = `声誉表现处于<span class="text-slate-600 font-bold">行业主流区间</span>`;
            }

            // 组合分析文本
            analysisText = `在本次挑战中，${styleDesc}最终结果显示，您的${budgetEval}，同时${repEval}。`;
            
            // 如果是首位用户或离线
            if (avgCount === 0) {
                analysisText += `<br><span class="text-gray-400 italic text-xs">(注：当前暂无足够云端数据，对比基于理论中性值)</span>`;
            }

            // --- C. 生成最终 HTML ---
            if (gameState.reputation < repThreshold) {
                // Case 1: 失败 (制裁)
                feedbackHTML = `
                    <strong class="text-red-600 block mb-2">⚠️ 项目触发制裁机制 (强制退场)</strong>
                    <div class="bg-slate-100 p-2 rounded text-xs text-slate-700">
                        <span class="font-bold">管理洞察：</span><br>
                        虽然${styleDesc}，但您的声誉分已低于安全阈值（${repThreshold}分），直接触发了世行的黑名单机制。无论经济收益如何，项目已失败。合规是国际工程的生存底线。
                    </div>
                `;
            } else {
                let overallTitle = "";
                let overallColor = "";
                
                // 判定总体评价 Title
                if (finalBudget > industryAvg.budget && gameState.reputation > industryAvg.rep) {
                    overallTitle = "🏆 卓越的项目管理"; 
                    overallColor = "text-emerald-600";
                } else if (safeCount >= 3 && gameState.reputation >= 100) {
                    overallTitle = "🛡️ 负责任的长期主义者";
                    overallColor = "text-blue-600";
                } else if (riskCount >= 3 && finalBudget > 800) {
                    overallTitle = "💰 激进的利润追逐者";
                    overallColor = "text-orange-500";
                } else {
                    overallTitle = "⚖️ 均衡发展的管理者"; 
                    overallColor = "text-slate-700";
                }
                
                feedbackHTML = `
                    <strong class="${overallColor} block mb-2">${overallTitle}</strong>
                    <div class="bg-slate-100 p-2 rounded text-xs text-slate-700 border-l-2 border-slate-300">
                        <span class="font-bold text-slate-800">📊 智能画像：</span><br>
                        ${analysisText}
                    </div>
                `;
            }
            
            document.getElementById('end-feedback').innerHTML = feedbackHTML;
            
            updateBenchmarks();
            document.getElementById('loading-stats').classList.remove('hidden');
            
            // 数据存储结构更新
            const d = userProfile.surveyData;
            const saveData = {
                // --- 1. 基本结果 (Basic Results) ---
                budget: finalBudget,
                schedule: gameState.schedule,
                reputation: gameState.reputation,
                
                // --- 2. 人口统计 (Demographics) ---
                demo_gender: userProfile.gender,
                demo_age: userProfile.age,
                demo_major: userProfile.major,
                demo_role_pm: userProfile.role_pm,
                demo_role_hse: userProfile.role_hse,
                demo_exp_neg: userProfile.exp_neg,

                // --- 3. 实验设定 (Experiment Settings) ---
                ctx_resource: globalContext.resource,
                ctx_sensitivity: globalContext.sensitivity,
                exp_group: experimentGroup, 
                final_multiplier: dynamicMultiplier,

                // --- 4. 问卷分数 (Survey Scores) ---
                esgScore: userProfile.esgScore,
                riskScore: userProfile.riskScore,
                moralScore: userProfile.moralScore,
                timeScore: userProfile.timeScore,
                
                // --- 5. 问卷原始数据 (Survey Raw Data) ---
                raw_moral1: d.moral1, raw_moral2: d.moral2, raw_moral3: d.moral3,
                raw_time1: d.time1, raw_time2: d.time2, raw_time3: d.time3,
                raw_esg1: d.esg1, raw_esg2: d.esg2, raw_esg3: d.esg3,
                raw_risk1: d.risk1, raw_risk2: d.risk2, raw_risk3: d.risk3
            };
            
            // --- 6. 决策路径 (Decision Path) 按顺序排列 ---
            if(decisionPath && decisionPath.length > 0) {
                decisionPath.forEach((dp, index) => {
                    const step = index + 1;
                    if (dp) {
                        // 修改2：明确记录 d1_duration 至 d5_duration
                        saveData[`d${step}_duration`] = dp.duration || 0;

                        // A. 决策前的快照 (Snapshot BEFORE Decision)
                        if (dp.snapshot) {
                            saveData[`d${step}_snap_budget`] = dp.snapshot.budget;
                            saveData[`d${step}_snap_schedule`] = dp.snapshot.schedule;
                            saveData[`d${step}_snap_rep`] = dp.snapshot.reputation;
                        }

                        // B. 此时各选项的具体参数 (Options Parameters AT Decision)
                        if (dp.optionsSnapshot) {
                            // Option A (Risk)
                            const optA = dp.optionsSnapshot.A;
                            if (optA) {
                                saveData[`d${step}_optA_fail_prob`] = optA.prob; // 修改2: 明确为 fail_prob
                                saveData[`d${step}_optA_fail_b`] = optA.fail.b;
                                saveData[`d${step}_optA_fail_s`] = optA.fail.s; // 修改3: 补充工期
                                saveData[`d${step}_optA_fail_r`] = optA.fail.r;
                                saveData[`d${step}_optA_succ_b`] = optA.success.b;
                                saveData[`d${step}_optA_succ_s`] = optA.success.s; // 修改3: 补充工期
                                saveData[`d${step}_optA_succ_r`] = optA.success.r; // 修改2(v33.9.39): 补充声誉
                            }
                            
                            // Option B (Compromise)
                            const optB = dp.optionsSnapshot.B;
                            if (optB) {
                                saveData[`d${step}_optB_fail_prob`] = optB.prob; // 修改2: 明确为 fail_prob
                                saveData[`d${step}_optB_fail_b`] = optB.fail.b;
                                saveData[`d${step}_optB_fail_s`] = optB.fail.s; // 修改3: 补充工期
                                saveData[`d${step}_optB_fail_r`] = optB.fail.r;
                                saveData[`d${step}_optB_succ_b`] = optB.success.b;
                                saveData[`d${step}_optB_succ_s`] = optB.success.s; // 修改3: 补充工期
                                saveData[`d${step}_optB_succ_r`] = optB.success.r; // 修改2(v33.9.39): 补充声誉
                            }

                            // Option C (Compliance)
                            const optC = dp.optionsSnapshot.C;
                            if (optC && optC.c) {
                                saveData[`d${step}_optC_cost_b`] = optC.c.b;
                                saveData[`d${step}_optC_cost_s`] = optC.c.s; // 修改3: 补充工期
                                saveData[`d${step}_optC_cost_r`] = optC.c.r;
                            }
                        }

                        // C. 用户的最终决策 (User Decision)
                        saveData[`d${step}_type`] = dp.type || 'N/A';
                        saveData[`d${step}_exposed`] = dp.exposed === undefined ? false : dp.exposed;
                    }
                });
            }

            try {
                const response = await fetch(LC_API_URL, {
                    method: 'POST',
                    headers: { 'X-LC-Id': LC_APP_ID, 'X-LC-Key': LC_APP_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify(saveData)
                });

                if (!response.ok) throw new Error("HTTP " + response.status);
                const resultJson = await response.json();
                currentSessionId = resultJson.objectId;
                console.log("Save Success, ID:", currentSessionId);
            } catch(e) {
                console.warn("Data Sync Failed:", e);
                document.getElementById('network-status').style.display = 'block';
            }
            await fetchAverageData();
        }

        async function fetchAverageData() {
            const avgLabel = document.getElementById('avg-label');
            const elBudget = document.getElementById('avg-budget');
            const elSchedule = document.getElementById('avg-schedule');
            const elRep = document.getElementById('avg-rep');
            try {
                const response = await fetch(LC_API_URL + '?limit=200&order=-createdAt', {
                    method: 'GET',
                    headers: { 'X-LC-Id': LC_APP_ID, 'X-LC-Key': LC_APP_KEY, 'Content-Type': 'application/json' }
                });
                if(!response.ok) throw new Error("Fetch Error");
                const data = await response.json();
                let results = data.results || [];
                if (currentSessionId) results = results.filter(r => r.objectId !== currentSessionId);
                if (results && results.length > 0) {
                    let sumB = 0, sumS = 0, sumR = 0;
                    results.forEach(r => { sumB += (r.budget || 0); sumS += (r.schedule || 0); sumR += (r.reputation || 0); });
                    avgLabel.innerText = `👥 学员平均 (N=${results.length})`; 
                    elBudget.innerText = (sumB / results.length).toFixed(2);
                    elSchedule.innerText = (sumS / results.length).toFixed(2);
                    elRep.innerText = (sumR / results.length).toFixed(2);
                } else {
                    avgLabel.innerText = `👥 暂无其他数据`;
                    elBudget.innerText = "-"; elSchedule.innerText = "-"; elRep.innerText = "-";
                }
            } catch(e) {
                console.error("Fetch Failed", e);
                avgLabel.innerText = "⚠️ 离线模式";
                elBudget.innerText = "本地"; elSchedule.innerText = "本地"; elRep.innerText = "本地";
                document.getElementById('network-status').style.display = 'block';
            }
            document.getElementById('loading-stats').classList.add('hidden');
        }

        function forceRetryCloud() {
            document.getElementById('loading-stats').classList.remove('hidden');
            fetchAverageData();
        }
        
        function updateBenchmarks() {
            const bestC = { b: 1000 + (5 * -80), s: 12.0 + (5 * 0.8), r: 100 + (5 * 12) };
            const bestLuck = { b: 1000 + (5 * -16), s: 12.0 + (5 * 0.16), r: 100 + 0 };
            
            let worstS = 12.0 + (5 * 1.92);
            let worstB = 1000 + (5 * -192);
            let worstR = 100 + (5 * -24);
            if (worstS > 16.0) { worstB -= Math.ceil((worstS - 16.0) * 100); }

            document.getElementById('bench-compliance-budget').innerText = bestC.b.toFixed(2);
            document.getElementById('bench-compliance-schedule').innerText = bestC.s.toFixed(2);
            document.getElementById('bench-compliance-rep').innerText = bestC.r.toFixed(2);

            document.getElementById('bench-luck-budget').innerText = bestLuck.b.toFixed(2);
            document.getElementById('bench-luck-schedule').innerText = bestLuck.s.toFixed(2);
            document.getElementById('bench-luck-rep').innerText = bestLuck.r.toFixed(2);

            document.getElementById('bench-worst-budget').innerText = worstB.toFixed(2);
            document.getElementById('bench-worst-schedule').innerText = worstS.toFixed(2);
            document.getElementById('bench-worst-rep').innerText = worstR.toFixed(2);
        }
    </script>
<script>window.parent.postMessage({ action: "ready" }, "*"); 
 
window.console = new Proxy(console, {
  get(target, prop) {
    if (['log', 'warn', 'error'].includes(prop)) {
      return new Proxy(target[prop], {
        apply(fn, thisArg, args) {
          fn.apply(thisArg, args);
          window.parent.postMessage({ action: 'console', 
            type: prop, 
            args: args.map((arg) => {
              try {
                return JSON.stringify(arg).replace(/^["']|["']$/g, '');
              } catch (e) {
                return arg;
              }
            }) 
          }, '*');
        }
      });
    }
    return target[prop];
  }
});
</script></body>
</html>
