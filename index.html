
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, height=device-height">
    <title>SunLink ESG ç®¡ç† | Experiment Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent; 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        }
        
        .header-spacer { width: 100%; height: 140px; flex-shrink: 0; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .stat-float { position: absolute; font-weight: bold; pointer-events: none; animation: floatUp 1.5s forwards; opacity: 0; z-index: 60; text-shadow: 0 1px 2px rgba(255,255,255,0.8); }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-30px) scale(1.2); opacity: 0; } }
        .dice-roll { animation: spin 0.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .comp-table { width: 100%; font-size: 10px; border-collapse: collapse; margin-top: 10px; }
        .comp-table th { background: #f1f5f9; color: #64748b; font-weight: bold; padding: 6px; text-align: center; border: 1px solid #e2e8f0; }
        .comp-table td { padding: 6px; text-align: center; border: 1px solid #e2e8f0; } 
        .comp-table tr.highlight { background: #eff6ff; font-weight: bold; color: #1e40af; }
        .comp-table tr.avg-row { background: #f8fafc; color: #64748b; font-style: italic; }
        
        /* çŸ©é˜µè¡¨æ ¼æ ·å¼ */
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 9px; text-align: center; }
        .matrix-table th, .matrix-table td { border: 1px solid #cbd5e1; padding: 4px 2px; }
        .matrix-table th { background: #e2e8f0; color: #334155; }
        
        .matrix-highlight { border: 2px solid #2563eb !important; font-weight: bold; background-color: rgba(255,255,255,0.6); }
        
        .prob-row { font-size: 8px; color: #64748b; background: rgba(255,255,255,0.5); }
        .prob-highlight { color: #dc2626; font-weight: bold; background-color: #fef2f2; padding: 0 2px; border-radius: 2px; border: 1px solid #fee2e2; }

        /* é—®å·æ ·å¼ */
        .likert-scale { display: flex; justify-content: space-between; margin-top: 8px; margin-bottom: 16px; padding: 4px; border-radius: 8px; transition: background 0.3s;}
        .likert-opt { display: flex; flex-direction: column; items-center; text-align: center; cursor: pointer; width: 18%; }
        .likert-circle { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; margin-bottom: 4px; transition: all 0.2s; font-size: 10px; font-weight: bold; color: #64748b; }
        .likert-opt.selected .likert-circle { background-color: #3b82f6; border-color: #3b82f6; color: white; transform: scale(1.1); }
        .likert-label { font-size: 8px; color: #94a3b8; line-height: 1.2; }
        
        /* é—®å·æœªå¡«é«˜äº® */
        .scroll-highlight { animation: pulse-bg 1.5s infinite; border: 1px solid #ef4444; }
        @keyframes pulse-bg { 0% { background-color: #fee2e2; } 50% { background-color: #fff; } 100% { background-color: #fee2e2; } }

        /* è¡¨å•è¾“å…¥æ ·å¼ */
        .form-group { margin-bottom: 12px; padding: 4px; border-radius: 6px; transition: background 0.3s; }
        .form-label { display: block; font-size: 12px; font-weight: bold; color: #475569; margin-bottom: 4px; }
        .form-select, .form-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 12px; background: #fff; }
        .radio-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .radio-label { display: flex; items-center: center; font-size: 12px; color: #475569; cursor: pointer; background: #f1f5f9; padding: 6px 10px; border-radius: 16px; border: 1px solid transparent; transition: all 0.2s; }
        .radio-label.checked { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; font-weight: bold; }
        .radio-label input { display: none; }


        /* ä¹å®«æ ¼éšæœºæ ·å¼ */
        .grid-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; width: 100%; max-width: 300px; margin: 0 auto; }
        .grid-cell { 
            aspect-ratio: 1; 
            border: 1px solid rgba(0,0,0,0.1); 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.1s; 
            opacity: 0.7; 
            padding: 2px;
        }
        .grid-cell.active { 
            background-color: #3b82f6 !important; 
            color: white !important; 
            border-color: #2563eb !important;
            transform: scale(1.05); 
            opacity: 1; 
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); 
            z-index: 10; 
        }
        .grid-unified-text { 
            font-size: 9px; 
            font-weight: bold; 
            line-height: 1.4; 
            text-align: center;
            white-space: nowrap; 
        }

        .ctx-desc-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 8px; }
        .ctx-desc-card { 
            font-size: 9px; 
            color: #475569; 
            background: #f8fafc; 
            padding: 6px; 
            border-radius: 6px; 
            border: 1px solid #cbd5e1;
            transition: all 0.3s; 
            opacity: 0.8; 
            display: flex; flex-direction: column;
            height: 100%;
        }
        .ctx-label { font-weight: bold; color: #334155; display: block; margin-bottom: 4px; font-size: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px;}
        
        .ctx-desc-card.highlighted {
            background: #eff6ff; 
            border-color: #2563eb;
            border-width: 2px;
            color: #0f172a;
            opacity: 1;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
            transform: scale(1.02);
            z-index: 5;
        }
        
        .copyright-text { font-size: 9px; color: #cbd5e1; text-align: center; margin-top: 12px; font-family: sans-serif; }
        
        /* é”™è¯¯æç¤ºæ¡ */
        #network-status { display: none; }

        /* è·³åŠ¨åœ°çƒåŠ¨ç”» */
        .bounce-earth { animation: bounce 2s infinite; font-size: 80px; display: block; text-align: center; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }
        
        /* åº•éƒ¨æŒ‰é’®å®¹å™¨é€šç”¨æ ·å¼ */
        .nav-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.95);
            border-top: 1px solid #f1f5f9;
            backdrop-filter: blur(4px);
            z-index: 30;
            padding: 16px;
            padding-bottom: env(safe-area-inset-bottom, 20px);
            display: flex; gap: 12px; /* æŒ‰é’®é—´è· */
        }

        .btn-primary {
            flex: 2; 
            background: #1e293b; color: white;
            font-weight: bold; border-radius: 12px;
            padding: 14px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            flex: 1; 
            background: #f1f5f9; color: #64748b;
            font-weight: bold; border-radius: 12px;
            padding: 14px; border: 1px solid #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .btn-secondary:active { background: #e2e8f0; }
        
        .highlight-short-term { background-color: #f0fdf4; color: #15803d; font-weight: bold; padding: 0 2px; border-radius: 2px; border: 1px solid #bbf7d0; }
        .highlight-long-term { background-color: #fefce8; color: #854d0e; font-weight: bold; padding: 0 2px; border-radius: 2px; border: 1px solid #fef08a; }

        @keyframes box-flash-red {
            0%, 100% { background-color: #f8fafc; border-color: #e2e8f0; }
            50% { background-color: #fee2e2; border-color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
        }
        .animate-box-flash {
            animation: box-flash-red 1s infinite;
        }

        /* --- å¯åŠ¨æµ·æŠ¥ --- */
        #screen-poster {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 9999 !important;
            background-color: #050505; 
            display: flex; flex-direction: column; justify-content: flex-end;
            transition: opacity 0.8s ease-out;
        }
        
        .poster-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            z-index: 101;
            display: block; 
            filter: brightness(0.8) contrast(1.1);
        }
        
        .poster-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 60%, rgba(0,0,0,0.9) 100%);
            z-index: 102;
        }

        .poster-title-container {
            position: absolute;
            top: 30%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
            z-index: 103;
            padding: 0 20px;
        }
        
        .poster-main-title {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 56px; 
            font-weight: 900;
            margin-bottom: 0;
            line-height: 1.4;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #ffffff 0%, #e0f2fe 50%, #38bdf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 15px rgba(0, 0, 0, 0.9));
        }

        .poster-sub-title {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 26px; 
            font-weight: 600;
            color: #bef264; 
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.9); 
            margin-top: 20px; 
            letter-spacing: 3px; 
            text-transform: uppercase;
        }

        .poster-footer-info {
            position: absolute; 
            bottom: 25%; 
            left: 0; width: 100%;
            text-align: center;
            z-index: 103;
            color: #f8fafc;
            font-family: "Georgia", serif; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.95);
        }
        .poster-org-name {
            font-size: 18px; 
            font-weight: bold;
            display: block;
            margin-bottom: 6px;
            letter-spacing: 1px;
            text-transform: uppercase; 
        }
        .poster-center-name {
            font-size: 13px;
            opacity: 1.0; 
            display: block;
            letter-spacing: 0.5px;
            color: #e2e8f0;
            font-weight: 500;
        }

        .poster-bar-container {
            position: absolute; 
            bottom: 35%; 
            left: 50%; 
            transform: translateX(-50%);
            width: 60%; 
            height: 32px; 
            background: rgba(0,0,0,0.6); 
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px; 
            overflow: hidden; 
            z-index: 103;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        
        .poster-bar {
            width: 100%; 
            height: 100%; 
            background: linear-gradient(90deg, #38bdf8, #2563eb); 
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
            animation: posterCountdown 3s linear forwards;
        }
        @keyframes posterCountdown { 
            0% { width: 0%; } 
            100% { width: 100%; } 
        }
        
        .poster-bar-text {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #ffffff;
            letter-spacing: 2px;
            z-index: 104;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

    </style>
</head>
<body class="flex flex-col text-slate-800 bg-slate-100">

    <!-- 0. å¯åŠ¨æµ·æŠ¥ -->
    <div id="screen-poster">
        <img src="https://images.unsplash.com/photo-1473341304170-971dccb5ac1e?q=80&w=2070&auto=format&fit=crop" 
             alt="Green Earth Power Grid" 
             id="poster-image-element"
             class="poster-img">
        <div class="poster-overlay"></div>
        <div class="poster-title-container">
            <div class="poster-main-title">SunLink</div>
            <div class="poster-sub-title">ESG Simulator</div>
        </div>
        <div class="poster-bar-container">
             <div class="poster-bar-text">æŒ‘æˆ˜å³å°†å¼€å§‹</div>
            <div class="poster-bar"></div>
        </div>
        <div class="poster-footer-info">
            <span class="poster-org-name">Tianjin University</span>
            <span class="poster-center-name">Global Infrastructure Projects Center</span>
        </div>
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header id="main-header" class="bg-white shadow-sm border-b border-slate-200 z-50 px-3 py-2 w-full absolute top-0 left-0 hidden">
        <div class="flex justify-between items-center mb-2 pt-safe-top mt-2"> 
            <div class="flex items-center gap-2">
                <div class="text-xl">ğŸŒ</div>
                <div class="font-black text-lg tracking-tight text-slate-800">SunLink <span class="text-blue-600">ESG</span></div>
            </div>
            <div class="text-xs text-slate-400 font-bold" id="level-indicator">Mission Briefing</div>
        </div>
        
        <div class="grid grid-cols-3 gap-2 text-xs font-bold pb-1">
            <div class="flex flex-col items-center bg-slate-50 p-1 rounded border border-slate-200 relative overflow-visible">
                <span class="text-[10px] text-slate-400 scale-90">åˆ©æ¶¦(ä¸‡)</span>
                <span id="val-budget" class="text-emerald-600 text-base">1000.00</span>
                <div id="float-budget" class="absolute top-0 left-1/2 -translate-x-1/2"></div>
            </div>
            <div class="flex flex-col items-center bg-slate-50 p-1 rounded border border-slate-200 relative overflow-visible transition-all duration-300" id="box-schedule">
                <span id="lbl-schedule" class="text-[10px] text-slate-400 scale-90">è¿›åº¦(å‰©ä½™)</span>
                <div class="flex items-baseline">
                    <span id="val-schedule" class="text-blue-600 text-base">4.0</span>
                    <span class="text-[10px] text-slate-300 font-normal ml-0.5">æœˆ</span>
                </div>
                <div id="float-schedule" class="absolute top-0 left-1/2 -translate-x-1/2"></div>
            </div>
            <div class="flex flex-col items-center bg-slate-50 p-1 rounded border border-slate-200 relative overflow-visible">
                <span class="text-[10px] text-slate-400 scale-90">å£°èª‰</span>
                <span id="val-reputation" class="text-yellow-600 text-base">100.00</span>
                <div id="float-reputation" class="absolute top-0 left-1/2 -translate-x-1/2"></div>
            </div>
        </div>
        
        <div class="w-full h-1 bg-slate-200 mt-2 rounded-full overflow-hidden">
            <div id="progress-bar" class="bg-blue-500 h-1 transition-all duration-500" style="width: 0%"></div>
        </div>
        <div id="network-status" class="w-full bg-orange-100 text-orange-700 text-[10px] text-center py-1 mt-1 rounded">
            å½“å‰ä¸ºç¦»çº¿æ¨¡å¼ (æ•°æ®æ— æ³•åŒæ­¥)
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="flex-1 relative w-full h-full max-w-lg mx-auto bg-white md:my-4 md:rounded-2xl md:shadow-xl md:border md:border-slate-200 overflow-hidden flex flex-col z-0">
        
        <!-- 1. å¼€åœº (é¦–é¡µ) -->
        <div id="screen-start" class="absolute inset-0 z-20 flex flex-col bg-white fade-in overflow-y-auto hidden">
            <div class="flex-1 p-6 flex flex-col items-center justify-center text-center pb-40">
                <div class="bounce-earth mb-4">ğŸŒ</div>
                
                <h2 class="text-2xl font-black text-slate-800 mb-2">SunLink <span class="text-blue-600">ESG</span></h2>
                <p class="text-sm font-medium text-slate-500 mb-4">å›½é™…å·¥ç¨‹é¡¹ç›®ESGç®¡ç†æ¨¡æ‹ŸæŒ‘æˆ˜</p>
                <p class="text-sm text-slate-600 mb-8 leading-relaxed px-4">
                    ä½ éœ€è¦å¹³è¡¡<b>å·¥æœŸå‹åŠ›</b>ã€<b>é¡¹ç›®åˆ©æ¶¦</b>ä¸<b>åˆè§„è¦æ±‚</b><br>
                    æ¯ä¸€ä¸ªå†³å®šéƒ½å°†å½±å“é¡¹ç›®çš„æœ€ç»ˆå‘½è¿
                </p>
                <div class="mt-4 pt-6 border-t border-slate-100 w-full">
                    <p class="text-xs text-slate-400 font-medium mb-2">å¼€å‘å•ä½</p>
                    <p class="text-xs text-slate-600 font-bold mb-4">å¤©æ´¥å¤§å­¦å…¨çƒå·¥ç¨‹ç»è¥å®éªŒå®¤</p>
                    
                    <p class="text-xs text-slate-400 font-medium mb-2">è”ç³»äºº</p>
                    <p class="text-xs text-slate-600 font-bold mb-2">å‚…è€å¸ˆ yongcheng_fu@126.com</p>
                    
                    <div class="copyright-text">Â© 2025 Tianjin University GIPC. All Rights Reserved.</div>
                </div>
            </div>
            <div class="fixed bottom-0 left-0 w-full p-4 bg-white/95 border-t border-slate-100 backdrop-blur-sm z-50 pb-safe-area">
                <button onclick="goToSurvey()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">
                    å¼€å§‹æŒ‘æˆ˜
                </button>
            </div>
        </div>

        <!-- 1.5 è°ƒæŸ¥é—®å· -->
        <div id="screen-survey" class="hidden flex-col h-full fade-in absolute inset-0 z-20 bg-white">
            <div class="pt-4 pb-2 px-6 flex justify-center items-center border-b border-slate-100 bg-white z-10">
                 <div class="text-2xl mr-2">ğŸŒ</div>
                 <div class="font-black text-xl tracking-tight text-slate-800">SunLink <span class="text-blue-600">ESG</span></div>
            </div>

            <div class="px-6 pt-4 flex-1 overflow-y-auto pb-40 scroll-smooth" id="survey-container">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6 text-xs text-slate-600 leading-relaxed shadow-sm">
                    <h4 class="font-bold text-blue-800 mb-2 text-sm">ğŸ”¬ å®éªŒç ”ç©¶çŸ¥æƒ…åŒæ„ä¹¦</h4>
                    <p class="mb-2">æ‚¨å³å°†å‚ä¸çš„æ˜¯ä¸€é¡¹å…³äºå›½é™…å·¥ç¨‹ ESG å†³ç­–è¡Œä¸ºçš„å­¦æœ¯ç ”ç©¶å®éªŒï¼Œç”±å¤©æ´¥å¤§å­¦å…¨çƒå·¥ç¨‹ç»è¥å®éªŒå®¤å¼€å‘ã€‚</p>
                    <ul class="list-disc pl-4 space-y-1 text-slate-500">
                        <li><strong>åŒ¿åæ€§ï¼š</strong>æ‚¨çš„æ‰€æœ‰å›ç­”å°†è¢«ä¸¥æ ¼ä¿å¯†ï¼Œç³»ç»Ÿä»…è®°å½•å»æ ‡è¯†åŒ–çš„å†³ç­–æ•°æ®ç”¨äºç§‘ç ”ç»Ÿè®¡åˆ†æã€‚</li>
                        <li><strong>è‡ªæ„¿æ€§ï¼š</strong>å‚ä¸æœ¬å®éªŒå®Œå…¨è‡ªæ„¿ï¼Œæ‚¨æœ‰æƒåœ¨ä»»ä½•æ—¶å€™å…³é—­é¡µé¢é€€å‡ºã€‚</li>
                        <li><strong>æ— é£é™©ï¼š</strong>æœ¬å®éªŒä¸æ¶‰åŠä»»ä½•å•†ä¸šåˆ©ç›Šæˆ–ä¸ªäººéšç§é£é™©ã€‚</li>
                    </ul>
                </div>

                <h2 class="text-xl font-black text-slate-800 mb-6">ğŸ“‹ å®éªŒå‰å°è°ƒæŸ¥</h2>
                
                <form id="survey-form" onsubmit="submitSurvey(event)">
                    <!-- 0. ä¸ªäººèƒŒæ™¯ä¿¡æ¯ -->
                    <div class="mb-6">
                        <p class="text-xs font-bold text-slate-500 mb-2 uppercase border-b pb-1">åŸºæœ¬ä¿¡æ¯</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-3">
                             <div class="form-group" id="q-gender">
                                <label class="form-label">æ€§åˆ«</label>
                                <select class="form-select" data-field="gender">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="M">ç”·</option>
                                    <option value="F">å¥³</option>
                                </select>
                            </div>
                            <div class="form-group" id="q-age">
                                <label class="form-label">å¹´é¾„</label>
                                <select class="form-select" data-field="age">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="<20">20å²ä»¥ä¸‹</option>
                                    <option value="20-25">20-25å²</option>
                                    <option value="26-30">26-30å²</option>
                                    <option value="31-35">31-35å²</option>
                                    <option value="36-40">36-40å²</option>
                                    <option value="41-45">41-45å²</option>
                                    <option value="46-50">46-50å²</option>
                                    <option value="51-55">51-55å²</option>
                                    <option value="56-60">56-60å²</option>
                                    <option value="61-65">61-65å²</option>
                                    <option value="65+">65å²ä»¥ä¸Š</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" id="q-major">
                             <label class="form-label">ä¸“ä¸šèƒŒæ™¯</label>
                             <select class="form-select" data-field="major">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="Engineering">å·¥ç¨‹æŠ€æœ¯</option>
                                <option value="Law">æ³•å¾‹/åˆè§„</option>
                                <option value="Finance">è´¢åŠ¡/ç»æµ</option>
                                <option value="Environment">ç¯å¢ƒ/å®‰å…¨</option>
                                <option value="Business">å•†åŠ¡/ç®¡ç†</option>
                                <option value="Other">å…¶ä»–</option>
                            </select>
                        </div>

                        <div class="form-group" id="q-pm">
                            <label class="form-label">æ‚¨æ˜¯å¦æ‹…ä»»è¿‡é¡¹ç›®ç»ç†ï¼Ÿ</label>
                            <div class="radio-group">
                                <label class="radio-label" onclick="selectRadio(this, 'role_pm', 'yes')">
                                    <input type="radio" name="role_pm" value="yes"> æ˜¯
                                </label>
                                <label class="radio-label" onclick="selectRadio(this, 'role_pm', 'no')">
                                    <input type="radio" name="role_pm" value="no"> å¦
                                </label>
                            </div>
                        </div>

                        <div class="form-group" id="q-hse">
                            <label class="form-label">æ‚¨æ˜¯å¦æ‹…ä»»è¿‡HSE/ESGéƒ¨é—¨ç»ç†ï¼Ÿ</label>
                            <div class="radio-group">
                                <label class="radio-label" onclick="selectRadio(this, 'role_hse', 'yes')">
                                    <input type="radio" name="role_hse" value="yes"> æ˜¯
                                </label>
                                <label class="radio-label" onclick="selectRadio(this, 'role_hse', 'no')">
                                    <input type="radio" name="role_hse" value="no"> å¦
                                </label>
                            </div>
                        </div>

                        <div class="form-group" id="q-exp">
                            <label class="form-label">ä»¥å¾€æ˜¯å¦ç»å†è¿‡ESGè´Ÿé¢äº‹ä»¶(å¦‚ç¯ä¿è¢«ç½š)ï¼Ÿ</label>
                            <div class="radio-group">
                                <label class="radio-label" onclick="selectRadio(this, 'exp_neg', 'yes')">
                                    <input type="radio" name="exp_neg" value="yes"> æ˜¯
                                </label>
                                <label class="radio-label" onclick="selectRadio(this, 'exp_neg', 'no')">
                                    <input type="radio" name="exp_neg" value="no"> å¦
                                </label>
                            </div>
                        </div>
                    </div>

                    <hr class="border-slate-100 my-6">

                    <!-- 1. ä¸ªäººç‰¹è´¨ -->
                    <div class="mb-6">
                        <p class="text-xs font-bold text-purple-600 mb-2 uppercase">ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸ªäººç‰¹è´¨</p>
                        <div class="mb-4" id="q-moral1">
                            <p class="text-sm font-medium mb-2">1. å¯¹æˆ‘æ¥è¯´ï¼Œåšä¸€ä¸ªæœ‰é“å¾·çš„äººæ˜¯éå¸¸é‡è¦çš„ã€‚</p>
                            <div class="likert-scale" data-name="moral1"></div>
                        </div>
                        <div class="mb-4" id="q-moral2">
                            <p class="text-sm font-medium mb-2">2. å¦‚æœæˆ‘çš„è¡Œä¸ºè¢«è§†ä¸ºæ˜¯ä¸é“å¾·çš„ï¼Œæˆ‘ä¼šæ„Ÿåˆ°ç¾æ„§ã€‚</p>
                            <div class="likert-scale" data-name="moral2"></div>
                        </div>
                        <div class="mb-4" id="q-moral3">
                            <p class="text-sm font-medium mb-2">3. å³ä½¿æ²¡æœ‰äººåœ¨çœ‹ï¼Œæˆ‘ä¹ŸåšæŒåšæ­£ç¡®ï¼ˆåˆä¹é“å¾·ï¼‰çš„äº‹ã€‚</p>
                            <div class="likert-scale" data-name="moral3"></div>
                        </div>
                        <div class="mb-4" id="q-time1">
                            <p class="text-sm font-medium mb-2">4. æˆ‘é€šå¸¸æ„¿æ„æ”¾å¼ƒçœ¼å‰çš„åˆ©ç›Šï¼Œä»¥æ¢å–æœªæ¥æ›´å¤§çš„å›æŠ¥ã€‚</p>
                            <div class="likert-scale" data-name="time1"></div>
                        </div>
                        <div class="mb-4" id="q-time2">
                            <p class="text-sm font-medium mb-2">5. æˆ‘åšå†³ç­–æ—¶ï¼Œç»å¸¸è€ƒè™‘å…¶å¯¹æœªæ¥3-5å¹´çš„å½±å“ã€‚</p>
                            <div class="likert-scale" data-name="time2"></div>
                        </div>
                        <div class="mb-4" id="q-time3">
                            <p class="text-sm font-medium mb-2">6. æˆ‘ä¸å–œæ¬¢ç­‰å¾…ï¼Œæ›´å€¾å‘äºâ€œè½è¢‹ä¸ºå®‰â€ã€‚</p>
                            <div class="likert-scale" data-name="time3"></div>
                        </div>
                    </div>

                    <!-- 2. ESG è®¤åŒ -->
                    <div class="mb-6">
                        <p class="text-xs font-bold text-blue-600 mb-2 uppercase">ç¬¬äºŒéƒ¨åˆ†ï¼šESG è®¤åŒ</p>
                        <div class="mb-4" id="q-esg1">
                            <p class="text-sm font-medium mb-2">7. æˆ‘è®¤ä¸º ESG ä¸»è¦æ˜¯ä¸ºäº†å…¬å…³å½¢è±¡ï¼Œå¯¹é¡¹ç›®å®è´¨ä»·å€¼æœ‰é™ã€‚</p>
                            <div class="likert-scale" data-name="esg1"></div> 
                        </div>
                        <div class="mb-4" id="q-esg2">
                            <p class="text-sm font-medium mb-2">8. ä¸é¡¹ç›®å¸¦æ¥çš„ç»æµåˆ©ç›Šç›¸æ¯”ï¼ŒESGè®®é¢˜å¯ä»¥åšå‡ºå¦¥åã€‚</p>
                            <div class="likert-scale" data-name="esg2"></div>
                        </div>
                        <div class="mb-4" id="q-esg3">
                            <p class="text-sm font-medium mb-2">9. å“ªæ€•ç‰ºç‰²çŸ­æœŸåˆ©æ¶¦ï¼Œä¼ä¸šä¹Ÿåº”ä¸¥æ ¼éµå®ˆç¯å¢ƒä¸ç¤¾ä¼šæ ‡å‡†ã€‚</p>
                            <div class="likert-scale" data-name="esg3"></div>
                        </div>
                    </div>

                    <!-- 3. å†³ç­–åå¥½ -->
                    <div class="mb-6">
                        <p class="text-xs font-bold text-orange-600 mb-2 uppercase">ç¬¬ä¸‰éƒ¨åˆ†ï¼šå†³ç­–åå¥½</p>
                        <div class="mb-4" id="q-risk1">
                            <p class="text-sm font-medium mb-2">10. ä¸ºäº†è·å¾—å·¨å¤§çš„æ½œåœ¨æ”¶ç›Šï¼Œæˆ‘æ„¿æ„æ‰¿æ‹…è¾ƒé«˜çš„å¤±è´¥é£é™©ã€‚</p>
                            <div class="likert-scale" data-name="risk1"></div>
                        </div>
                        <div class="mb-4" id="q-risk2">
                            <p class="text-sm font-medium mb-2">11. æˆ‘åšäº‹é€šå¸¸é€šè¿‡â€œæ‰“æ“¦è¾¹çƒâ€æ¥æé«˜æ•ˆç‡ã€‚</p>
                            <div class="likert-scale" data-name="risk2"></div>
                        </div>
                        <div class="mb-4" id="q-risk3">
                            <p class="text-sm font-medium mb-2">12. æˆ‘å®æ„¿ç¨³å¦¥åœ°å°‘èµšä¸€ç‚¹ï¼Œä¹Ÿä¸æ„¿å†’ä»»ä½•è¿è§„çš„é£é™©ã€‚</p>
                            <div class="likert-scale" data-name="risk3"></div>
                        </div>
                    </div>
                    <div class="h-8"></div>
                </form>
            </div>
            <div class="nav-footer">
                <button class="btn-secondary" onclick="backToStart()">â¬…ï¸ è¿”å›</button>
                <button class="btn-primary" onclick="validateAndSubmit()" id="btn-survey">æäº¤å¹¶ç»§ç»­ â¡ï¸</button>
            </div>
        </div>

        <!-- 2. ç®€æŠ¥ -->
        <div id="screen-briefing" class="hidden flex-col h-full fade-in absolute inset-0 z-15 bg-white">
            <div class="flex-1 overflow-y-auto scroll-smooth pb-32">
                <div class="header-spacer"></div>
                <div class="px-5 pt-2">
                    <h2 class="text-xl font-black text-slate-800 mb-4 border-l-4 border-blue-500 pl-3">é¡¹ç›®æ¦‚å†µ Briefing</h2>
                    
                    <div class="w-full h-40 mb-4 rounded-lg overflow-hidden shadow-sm border border-slate-200 relative bg-slate-100">
                        <img src="https://images.unsplash.com/photo-1509391366360-2e959784a276?q=80&w=2072&auto=format&fit=crop" alt="Large Scale Solar Power Plant" class="w-full h-full object-cover">
                        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-slate-900/60 to-transparent p-2">
                            <p class="text-white text-xs font-bold">100MW å…‰ä¼ + 132kV è¾“ç”µçº¿è·¯</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                        <div class="bg-emerald-50 border border-emerald-100 p-2 rounded">
                            <div class="text-[10px] text-emerald-600 mb-0.5">åˆå§‹åˆ©æ¶¦</div>
                            <div class="text-sm font-bold text-emerald-800">1000ä¸‡</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-100 p-2 rounded col-span-1">
                            <div class="text-[10px] text-blue-600 mb-0.5">å½“å‰è¿›åº¦/åˆåŒå·¥æœŸ</div>
                            <div class="text-sm font-bold text-blue-800">12ä¸ªæœˆ / 16ä¸ªæœˆ</div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-100 p-2 rounded">
                            <div class="text-[10px] text-yellow-600 mb-0.5">åˆå§‹å£°èª‰</div>
                            <div class="text-sm font-bold text-yellow-800">100åˆ†</div>
                        </div>
                    </div>

                    <div class="space-y-4 text-sm text-slate-700">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <h4 class="font-bold text-slate-900 mb-1 text-xs uppercase text-blue-600">ä¸€ã€å›½å®¶</h4>
                            <p class="text-xs">ğŸŒ éæ´²æŸå›½</p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <h4 class="font-bold text-slate-900 mb-1 text-xs uppercase text-blue-600">äºŒã€é¡¹ç›®èŒƒå›´</h4>
                            <ul class="list-disc pl-4 space-y-1 text-xs leading-relaxed">
                                <li>æ–°å»ºä¸€åº§ <strong>100 MW å…‰ä¼ç”µç«™</strong>ï¼›</li>
                                <li>é…å¥—å»ºè®¾çº¦ <strong>80 kmã€132kV è¾“ç”µçº¿è·¯</strong>ï¼Œæ¥å…¥å›½å®¶ä¸»å¹²ç”µç½‘ï¼›</li>
                                <li>æ‰©å»ºä¸€åº§ç°æœ‰å˜ç”µç«™ï¼Œæ–°å¢ 132/220kV ä¸»å˜åŠç›¸å…³è®¾å¤‡ã€‚</li>
                            </ul>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <h4 class="font-bold text-slate-900 mb-1 text-xs uppercase text-blue-600">ä¸‰ã€é¡¹ç›®æ¨¡å¼</h4>
                            <ul class="list-disc pl-4 space-y-1 text-xs leading-relaxed">
                                <li><strong>EPC æ€»æ‰¿åŒ…</strong>ï¼›</li>
                                <li>ä½ æ‰€åœ¨å…¬å¸æ˜¯è¯¥é¡¹ç›® EPC æ€»æ‰¿åŒ…å•†ï¼Œä½ æ‹…ä»»<strong>é¡¹ç›®ç»ç†</strong>è§’è‰²ï¼›</li>
                                <li class="text-red-700 bg-red-50 p-1 rounded font-bold">å…³é”®æ¡æ¬¾ï¼šåˆåŒå·¥æœŸ16ä¸ªæœˆï¼Œè¯¯æœŸæŸå®³èµ”å¿è´¹100ä¸‡/æœˆã€‚</li>
                            </ul>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <h4 class="font-bold text-slate-900 mb-1 text-xs uppercase text-blue-600">å››ã€èµ„é‡‘æ¥æº</h4>
                            <ul class="list-disc pl-4 space-y-1 text-xs leading-relaxed">
                                <li><strong>ä¸–ç•Œé“¶è¡Œï¼ˆWorld Bankï¼‰</strong>é€šè¿‡ IBRD/IDA è´·æ¬¾å’Œæ‹…ä¿ç­‰æ–¹å¼ä¸»å¯¼èèµ„ï¼›</li>
                                <li>é¡¹ç›®é€‚ç”¨ä¸–ç•Œé“¶è¡Œ<strong>ã€Šç¯å¢ƒä¸ç¤¾ä¼šæ¡†æ¶ã€‹ï¼ˆESFï¼‰</strong>åŠ 10 é¡¹ç¯å¢ƒä¸ç¤¾ä¼šæ ‡å‡†ï¼ˆESSï¼‰ã€‚</li>
                                <li class="text-red-600 font-bold bg-red-50 p-1 rounded mt-1">å£°èª‰çº¢çº¿ï¼šå£°èª‰åˆ†æ•°ä½äº 50 åˆ†å°†è§¦å‘ä¸–è¡Œåˆ¶è£ã€‚</li>
                            </ul>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <h4 class="font-bold text-slate-900 mb-1 text-xs uppercase text-blue-600">äº”ã€èƒŒæ™¯ä¿¡æ¯</h4>
                            <ul class="list-disc pl-4 space-y-2 text-[11px] leading-relaxed text-slate-600">
                                <li><strong>ç”Ÿæ€ç¯å¢ƒï¼š</strong>é¡¹ç›®åŒºåŸŸæ¶‰åŠå¤šç§é‡ç”ŸåŠ¨ç‰©æ –æ¯åœ°åŠå€™é¸Ÿè¿å¾™è·¯çº¿ï¼Œç”Ÿæ€æ•æ„Ÿæ€§ä¸ç¡®å®šã€‚</li>
                                <li><strong>ç¤¾ä¼šèƒŒæ™¯ï¼š</strong>å¾åœ°æ¶‰åŠå¤šä¸ªæ‘åº„ï¼Œå½“åœ°å¤±ä¸šç‡è¾ƒé«˜ï¼Œæ²»å®‰çŠ¶å†µå¤æ‚ï¼Œå­˜åœ¨æ½œåœ¨ç¤¾ä¼šçŸ›ç›¾ã€‚</li>
                                <li><strong>ç›‘ç®¡è¦æ±‚ï¼š</strong>ä¸–ç•Œé“¶è¡ŒESFæ ‡å‡†ä¸¥æ ¼ï¼Œä½†æœ¬åœ°æ³•å¾‹è¦æ±‚å’Œç›‘ç®¡éƒ¨é—¨çš„åˆè§„æ„è¯†ä¸ç¡®å®šã€‚</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-footer">
                <button class="btn-secondary" onclick="backToSurvey()">â¬…ï¸ è¿”å›</button>
                <button class="btn-primary" onclick="goToContext()" style="background-color: #2563eb;">è·å–ä»»åŠ¡ â¡ï¸</button>
            </div>
        </div>

        <!-- 2.5 éšæœºæƒ…å¢ƒ -->
        <div id="screen-context" class="hidden flex-col h-full fade-in absolute inset-0 z-15 bg-white">
            <div class="header-spacer"></div>
            <div class="px-6 pt-4 flex-1 overflow-y-auto pb-24">
                <div class="flex flex-col items-center text-center">
                    <h2 class="text-xl font-bold text-slate-800 mb-2">æ­£åœ¨éšæœºç”Ÿæˆå®éªŒç¯å¢ƒ...</h2>
                    <p class="text-sm text-slate-500 mb-4">ç³»ç»Ÿå°†åœ¨ 3Ã—3 çŸ©é˜µä¸­ä¸ºæ‚¨åˆ†é…<br>ä¼ä¸šèµ„æºä¸é¡¹ç›®ç¯å¢ƒ</p>
                    <!-- ä¹å®«æ ¼å®¹å™¨ -->
                    <div class="grid-box mb-6" id="random-grid"></div>
                    
                    <div id="ctx-result-area" class="hidden flex-col items-center fade-in w-full">
                        <div class="bg-blue-50 border border-blue-200 p-3 rounded-xl w-full shadow-sm mb-4">
                            <div class="text-2xl mb-1">ğŸ²</div>
                            <p class="text-xs text-blue-400 uppercase font-bold tracking-wider mb-1">éšæœºç»“æœ</p>
                            <p id="final-ctx-text" class="text-lg font-black text-blue-800 mb-1"></p>
                        </div>
                    </div>
                    
                    <div class="bg-slate-100 p-2 rounded mb-4 text-[10px] text-slate-500 text-left leading-relaxed border border-slate-200">
                        <span class="font-bold text-slate-700">ğŸ’¡ é€»è¾‘è¯´æ˜ï¼š</span><br>
                        1. <span class="font-bold">èµ„æºè¶Šä¸°å¯Œ</span>ï¼Œä¼ä¸šESGç®¡ç†èƒ½åŠ›è¶Šå¼ºï¼ˆå¦‚æ‹¥æœ‰ä¸“é¡¹èµ„é‡‘å’Œä¸“å®¶ï¼‰ï¼Œèƒ½æœ‰æ•ˆé™ä½åˆè§„æˆæœ¬å’Œè´Ÿé¢å½±å“ã€‚<br>
                        2. <span class="font-bold">é¡¹ç›®è¶Šæ•æ„Ÿ</span>ï¼Œå„æ–¹å…³æ³¨åº¦è¶Šé«˜ï¼ˆå¦‚NGOã€åª’ä½“ï¼‰ï¼ŒESGç®¡ç†ä¸å½“è¢«æš´éœ²çš„æ¦‚ç‡è¶Šé«˜ã€‚
                    </div>

                    <div class="w-full text-left border-t border-slate-100 pt-2">
                        <h3 class="text-xs font-bold text-slate-800 uppercase tracking-wider mb-2">ä¼ä¸šèµ„æº (Resource) è¯´æ˜</h3>
                        <div class="ctx-desc-container">
                            <div class="ctx-desc-card" id="desc-res-low">
                                <span class="ctx-label text-slate-600">ä½èµ„æº (Low)</span>
                                è´¢åŠ¡åƒç´§ï¼Œæ— ä¸“é—¨ESGå›¢é˜Ÿï¼Œå¯¹é¡¹ç›®æ”¯æŒååˆ†æœ‰é™ï¼Œè¿½æ±‚æˆæœ¬æœ€ä½åŒ–ã€‚
                            </div>
                            <div class="ctx-desc-card" id="desc-res-mid">
                                <span class="ctx-label text-blue-600">ä¸­èµ„æº (Mid)</span>
                                æœ‰ä¸€å®šèµ„æºå‚¨å¤‡ï¼Œèƒ½æ”¯æŒåˆç†çš„åˆè§„æˆæœ¬ï¼Œä½†éœ€å¹³è¡¡åˆ©æ¶¦è€ƒæ ¸ã€‚
                            </div>
                             <div class="ctx-desc-card" id="desc-res-high">
                                <span class="ctx-label text-emerald-600">é«˜èµ„æº (High)</span>
                                èµ„é‡‘é›„åšï¼Œæ‹¥æœ‰æˆç†Ÿçš„ESGéƒ¨é—¨å’Œä¸“é¡¹é¢„ç®—ï¼Œå¤§åŠ›æ”¯æŒæ ‡æ†é¡¹ç›®å»ºè®¾ã€‚
                            </div>
                        </div>

                        <h3 class="text-xs font-bold text-slate-800 uppercase tracking-wider mb-2 mt-4">æ•æ„Ÿåº¦ (Sensitivity) è¯´æ˜</h3>
                        <div class="ctx-desc-container">
                             <div class="ctx-desc-card" id="desc-sen-low">
                                <span class="ctx-label text-green-600">ä½æ•æ„Ÿåº¦ (Low)</span>
                                é¡¹ç›®ä½äºåè¿œæ— äººè’æ¼ ï¼Œç¤¾åŒºç¨€å°‘ã€‚NGOå’Œåª’ä½“æå°‘å…³æ³¨ã€‚
                            </div>
                             <div class="ctx-desc-card" id="desc-sen-mid">
                                <span class="ctx-label text-yellow-600">ä¸­æ•æ„Ÿåº¦ (Mid)</span>
                                é¡¹ç›®å‘¨è¾¹æœ‰ä¸€å®šæ‘è½ï¼Œæ¶‰åŠå¸¸è§„å¾åœ°æ‹†è¿ï¼Œå­˜åœ¨å¸¸è§„ç¤¾ä¼šé£é™©ã€‚
                            </div>
                             <div class="ctx-desc-card" id="desc-sen-high">
                                <span class="ctx-label text-red-600">é«˜æ•æ„Ÿåº¦ (High)</span>
                                é¡¹ç›®ä½äºä¿æŠ¤åŒºè¾¹ç¼˜ï¼Œæˆ–æ¶‰åŠåŸä½æ°‘åœ£åœ°ã€‚NGOé•¿æœŸç›‘ç£ï¼Œè¿è§„ææ˜“æš´éœ²ã€‚
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-footer hidden" id="btn-start-matrix">
                <button class="btn-secondary" onclick="backToBriefing()">â¬…ï¸ è¿”å›</button>
                <button class="btn-primary" onclick="goToMatrix()" style="background-color: #1e293b;">æŸ¥çœ‹ç­–ç•¥ â¡ï¸</button>
            </div>
        </div>

        <!-- 2.6 ç­–ç•¥çŸ©é˜µ -->
        <div id="screen-matrix" class="hidden flex-col h-full fade-in absolute inset-0 z-15 bg-white">
            <div class="header-spacer"></div>
            <div class="px-4 pt-2 flex-1 overflow-y-auto pb-32">
                <h2 class="text-lg font-bold text-slate-800 mb-2">SunLink ESG å“åº”ç­–ç•¥è¡¨</h2>
                <p class="text-xs text-slate-500 mb-2">åŸºäºæ‚¨çš„åˆ†é…ï¼ˆ<span id="user-ctx-summary" class="font-bold text-blue-600"></span>ï¼‰ï¼Œä¸åŒç­–ç•¥çš„åæœå¦‚ä¸‹ï¼š</p>
                
                <div class="overflow-x-auto border border-slate-200 rounded shadow-sm">
                    <div id="matrix-container"></div> 
                </div>
                <p class="text-[10px] text-slate-400 mt-2 italic text-center">*è¡¨æ ¼ä¸­é«˜äº®åˆ—ä¸ºæ‚¨å½“å‰çš„èµ„æºæ¡ä»¶ï¼Œé«˜äº®æ–‡å­—ä¸ºæ‚¨å½“å‰çš„æ•æ„Ÿåº¦æ¦‚ç‡</p>
            </div>
            <div class="nav-footer">
                <button class="btn-secondary" onclick="backToContext()">â¬…ï¸ è¿”å›</button>
                <button class="btn-primary" onclick="startGame()" style="background-color: #dc2626;">è¿›å…¥å±æœº â¡ï¸</button>
            </div>
        </div>

        <!-- 3. å±æœºäº‹ä»¶ -->
        <div id="screen-game" class="hidden flex-col h-full fade-in absolute inset-0 z-10 bg-white">
            <div class="header-spacer"></div>
            <div class="flex-1 overflow-y-auto scroll-smooth pb-32 px-4 pt-2">
                
                <div id="dynamic-warning" class="hidden bg-red-100 border-2 border-red-500 text-red-800 p-3 rounded mb-4 text-xs flex items-center gap-2 shadow-md animate-pulse">
                    <span class="text-2xl">âš ï¸</span>
                    <div>
                        <div class="font-black text-base">ç›‘ç®¡å‡çº§è­¦å‘Š</div>
                        <div class="font-bold" id="dynamic-msg-content">é¡¹ç›®å·²è¢«é‡ç‚¹å…³æ³¨ï¼æš´éœ²æ¦‚ç‡ä¸ä»£ä»·å·²ä¸Šæµ® X%ï¼</div>
                    </div>
                </div>

                <span id="event-tag" class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded mb-2 inline-block tracking-wide">TAG</span>
                <h3 id="event-title" class="text-2xl font-black text-slate-900 mb-4 leading-snug mt-1">Title</h3>
                <div class="text-sm text-slate-700 leading-relaxed space-y-2 pb-4 mb-4 border-l-4 border-yellow-400 pl-3 bg-yellow-50 p-3 rounded-r border-y border-r border-yellow-100">
                     <div id="event-desc"></div>
                     <div id="contextual-time-pressure" class="hidden mt-2 pt-2 border-t border-yellow-200 text-red-600 font-bold animate-pulse">
                     </div>
                </div>
                <div class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">è¯·åšå‡ºå†³ç­–ï¼š</div>
                <div id="options-container" class="grid gap-3 pb-10"></div>
            </div>
            
             <div class="nav-footer hidden" id="game-back-container">
                <button class="btn-secondary" onclick="backFromGame()">â¬…ï¸ è¿”å›</button>
                <button class="btn-primary disabled" style="opacity:0.3; cursor:default;">è¯·é€‰æ‹©ä¸Šæ–¹é€‰é¡¹</button>
            </div>
        </div>

        <!-- 4. åˆ¤å®šåŠ¨ç”» -->
        <div id="screen-check" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center text-center bg-slate-900/95 text-white backdrop-blur-sm">
            <div class="text-6xl mb-6 dice-roll">ğŸ²</div>
            <h2 class="text-xl font-bold mb-2">é£é™©åˆ¤å®šä¸­...</h2>
            <p id="check-text" class="text-slate-400 text-sm">å‘½è¿çš„ç¡¬å¸æ­£åœ¨æ—‹è½¬...</p>
        </div>

        <!-- 5. ç»“ç®—åé¦ˆ -->
        <div id="screen-result" class="hidden flex-col h-full fade-in absolute inset-0 z-10 bg-white">
            <div class="flex-1 overflow-y-auto pb-32">
                <div class="header-spacer"></div>
                <div class="px-5 pt-2 flex flex-col items-center">
                    <div id="result-icon" class="text-5xl mb-4 mt-2">ğŸ›‘</div>
                    <h2 id="result-title" class="text-2xl font-black text-slate-800 mb-4 text-center">ç»“æœæ ‡é¢˜</h2>
                    <div class="bg-slate-50 rounded-xl p-4 w-full border border-slate-200 relative shadow-sm mb-4">
                        <div id="lucky-badge" class="hidden absolute -top-2 -right-2 bg-orange-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm transform rotate-3">ä¾¥å¹¸é€ƒè„±</div>
                        <p id="result-desc" class="text-sm text-slate-700 italic leading-relaxed">...</p>
                        <div class="flex justify-center gap-3 text-xs font-bold font-mono pt-3 mt-3 border-t border-slate-200">
                            <span id="show-diff-budget" class="hidden"></span>
                            <span id="show-diff-schedule" class="hidden"></span>
                            <span id="show-diff-rep" class="hidden"></span>
                        </div>
                    </div>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-3 w-full mb-4 rounded-r text-xs leading-relaxed">
                        <span class="font-bold text-blue-800 block mb-1">ğŸ’¡ ä¸“å®¶ç‚¹è¯„</span>
                        <span id="result-learning" class="text-blue-900/80">...</span>
                    </div>
                </div>
            </div>
            <div class="nav-footer">
                <button class="btn-secondary" onclick="alert('è½å­æ— æ‚”ï¼Œå†³ç­–ç»“æœå·²ç”Ÿæˆï¼Œæ— æ³•æ’¤é”€ã€‚')">â¬…ï¸ è¿”å›</button>
                <button onclick="nextLevel()" id="btn-next-level" class="btn-primary" style="background-color: #1e293b;">ä¸‹ä¸€äº‹ä»¶ â¡ï¸</button>
            </div>
        </div>

        <!-- 6. å®Œå·¥æŠ¥å‘Š -->
        <div id="screen-end" class="hidden absolute inset-0 z-20 flex flex-col items-center bg-white fade-in">
             <div class="pt-4 pb-2 px-6 flex justify-center items-center border-b border-slate-100 bg-white z-10 flex-none w-full">
                 <div class="text-2xl mr-2">ğŸŒ</div>
                 <div class="font-black text-xl tracking-tight text-slate-800">SunLink <span class="text-blue-600">ESG</span></div>
            </div>
            <div class="flex-1 overflow-y-auto w-full flex flex-col items-center pb-40">
                <div class="px-6 pt-2 w-full flex flex-col items-center">
                    <div id="end-icon" class="text-6xl mt-2 mb-4">ğŸ†</div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">å®Œå·¥æŠ¥å‘Š</h2>
                    <div class="grid grid-cols-3 gap-2 w-full mb-6">
                        <div class="bg-slate-50 p-3 rounded border text-center">
                            <div class="text-[10px] text-slate-500 mb-1">æœ€ç»ˆåˆ©æ¶¦</div>
                            <div id="end-budget" class="text-lg font-bold text-emerald-600"></div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded border text-center relative overflow-hidden">
                            <div class="text-[10px] text-slate-500 mb-1">æœ€ç»ˆå·¥æœŸ</div>
                            <div id="end-schedule" class="text-lg font-bold text-blue-600"></div>
                            <div id="end-overdue-stamp" class="hidden absolute top-0 right-0 text-[8px] bg-red-500 text-white px-1 rounded-bl">é€¾æœŸ</div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded border text-center">
                            <div class="text-[10px] text-slate-500 mb-1">æœ€ç»ˆå£°èª‰</div>
                            <div id="end-rep" class="text-lg font-bold text-yellow-600"></div>
                        </div>
                    </div>

                    <!-- å¯¹æ¯”è¡¨ -->
                    <div class="w-full bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6">
                        <p class="text-sm font-bold text-slate-800 mb-2 border-l-4 border-indigo-500 pl-2">ğŸ“Š å†³ç­–è·¯å¾„å¯¹æ¯”åˆ†æ</p>
                        <div id="loading-stats" class="text-xs text-blue-500 animate-pulse mb-2 hidden">æ­£åœ¨åŒæ­¥äº‘ç«¯å­¦å‘˜æ•°æ®...</div>

                        <table class="comp-table">
                            <thead>
                                <tr>
                                    <th>ç­–ç•¥è·¯å¾„</th>
                                    <th>åˆ©æ¶¦</th>
                                    <th>å·¥æœŸ(æœˆ)</th>
                                    <th>å£°èª‰</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="highlight">
                                    <td>ä½ çš„å†³ç­–</td>
                                    <td id="comp-user-budget">-</td>
                                    <td id="comp-user-schedule">-</td>
                                    <td id="comp-user-rep">-</td>
                                </tr>
                                <tr class="avg-row">
                                    <td id="avg-label">ğŸ‘¥ å­¦å‘˜å¹³å‡</td>
                                    <td id="avg-budget">è®¡ç®—ä¸­...</td>
                                    <td id="avg-schedule">è®¡ç®—ä¸­...</td>
                                    <td id="avg-rep">è®¡ç®—ä¸­...</td>
                                </tr>
                                <tr class="bg-emerald-100 text-emerald-800 font-medium">
                                    <td title="é«˜èµ„æºä¼ä¸šï¼Œæ‰€æœ‰äº‹ä»¶é€‰C">æœ€åˆè§„å†³ç­–</td>
                                    <td id="bench-compliance-budget">600.00</td>
                                    <td id="bench-compliance-schedule">16.00</td>
                                    <td id="bench-compliance-rep">160.00</td>
                                </tr>
                                <tr class="bg-yellow-100 text-yellow-800 font-medium">
                                    <td title="é«˜èµ„æºä¼ä¸šï¼Œæ‰€æœ‰é€‰Aä¸”ä¸æš´éœ²">æœ€ä¾¥å¹¸æƒ…å†µ</td>
                                    <td id="bench-luck-budget">920.00</td>
                                    <td id="bench-luck-schedule">12.80</td>
                                    <td id="bench-luck-rep">100.00</td>
                                </tr>
                                <tr class="bg-red-100 text-red-800 font-medium">
                                    <td title="ä½èµ„æºä¼ä¸šï¼Œæ‰€æœ‰é€‰Aä¸”æš´éœ²">æœ€ç³Ÿç³•æƒ…å†µ</td> 
                                    <td id="bench-worst-budget">40.00</td>
                                    <td id="bench-worst-schedule">21.60</td>
                                    <td id="bench-worst-rep">-20.00</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="text-center mt-2">
                            <button onclick="forceRetryCloud()" class="text-[10px] text-blue-500 underline cursor-pointer hover:text-blue-700">åˆ·æ–°æ•°æ®</button>
                        </div>
                    </div>

                    <div id="end-feedback" class="text-sm bg-white border border-slate-200 p-4 rounded-xl shadow-sm w-full mb-6 text-slate-700 leading-relaxed"></div>

                    <div class="w-full bg-blue-50/50 p-4 rounded-xl border border-blue-100 mb-6">
                        <p class="text-sm font-bold text-blue-800 mb-2">ğŸ¤” æ€è€ƒä¸è®¨è®º</p>
                        <p class="text-sm text-slate-600 leading-relaxed">
                            å¯¹äºå›½é™…å·¥ç¨‹ ESG ç®¡ç†ï¼Œç»å†äº†è¿™ä¸ªé¡¹ç›®çš„ç§ç§æŒ‘æˆ˜åï¼Œé€šè¿‡ä¸Šé¢çš„å¯¹æ¯”ï¼Œæ‚¨æœ‰ä½•æ„Ÿæƒ³ï¼Ÿæ¬¢è¿ä¸åŒäº‹æˆ–å¤©æ´¥å¤§å­¦å…¨çƒå·¥ç¨‹ç»è¥å®éªŒå®¤äº¤æµã€‚
                        </p>
                    </div>

                    <div class="mt-4 w-full text-center">
                        <p class="text-xs text-slate-400 font-medium mb-2">å¼€å‘å•ä½</p>
                        <p class="text-xs text-slate-600 font-bold mb-4">å¤©æ´¥å¤§å­¦å…¨çƒå·¥ç¨‹ç»è¥å®éªŒå®¤</p>
                        
                        <p class="text-xs text-slate-400 font-medium mb-2">è”ç³»äºº</p>
                        <p class="text-xs text-slate-600 font-bold mb-2">å‚…è€å¸ˆ yongcheng_fu@126.com</p>
                        <div class="copyright-text">Â© 2025 Tianjin University GIPC. All Rights Reserved.</div>
                    </div>
                </div>
            </div>
            <div class="fixed bottom-0 left-0 w-full p-4 bg-white border-t border-slate-100 z-30 pb-safe-area">
                <button onclick="location.reload()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">å†è¯•ä¸€æ¬¡</button>
            </div>
        </div>

    </main>

    <script>
        // --- å…¨å±€é…ç½® ---
        const LIMIT_SCHEDULE = 16.0; 
        const PENALTY_PER_MONTH = 100; 

        // --- å®éªŒå˜é‡ ---
        const CONTEXT_LEVELS = ['low', 'mid', 'high'];
        let globalContext = {
            resource: 'mid',    
            sensitivity: 'mid'  
        };
        let hasContextGenerated = false;
        
        let levelStartTime = 0;
        let experimentGroup = Math.random() < 0.5 ? 'static' : 'dynamic'; 
        let dynamicMultiplier = 1.0; 
        let dynamicProbAdder = 0.0;  

        // --- æ ¸å¿ƒçŠ¶æ€å˜é‡ ---
        let gameState = { 
            budget: 1000, 
            schedule: 12.0, 
            reputation: 100, 
            currentLevel: 0 
        };
        
        let userProfile = {
            esgScore: 0,
            riskScore: 0,
            moralScore: 0, 
            timeScore: 0,
            gender: "",
            age: "",
            major: "",
            role_pm: "",
            role_hse: "",
            exp_neg: "",
            surveyData: {}
        };
        
        let currentSessionId = null;
        let decisionPath = []; 

        // --- é¡µé¢åˆå§‹åŒ–é€»è¾‘ ---
        (function() {
            const MIN_DISPLAY_TIME = 3000; 
            const MAX_WAIT_TIME = 5500;    
            
            const startTime = Date.now();
            let hasEntered = false;

            function enterApp() {
                if (hasEntered) return;
                
                const now = Date.now();
                const elapsed = now - startTime;
                const remaining = Math.max(0, MIN_DISPLAY_TIME - elapsed);

                setTimeout(() => {
                    if (hasEntered) return; 
                    hasEntered = true;

                    const poster = document.getElementById('screen-poster');
                    const startScreen = document.getElementById('screen-start');
                    
                    if (poster) poster.style.opacity = 0; 
                    if (startScreen) startScreen.classList.remove('hidden');
                    
                    setTimeout(() => {
                        if (poster) poster.style.display = 'none';
                    }, 800); 
                }, remaining);
            }

            const img = document.getElementById('poster-image-element');
            if (img) {
                if (img.complete) {
                    enterApp();
                } else {
                    img.onload = enterApp;
                    img.onerror = enterApp; 
                }
            } else {
                enterApp();
            }
            setTimeout(enterApp, MAX_WAIT_TIME);
        })();


        // --- LeanCloud Config ---
        const LC_APP_ID = "esL6o1jmpB3rVGlkjsE6OFRu-MdYXbMMI";
        const LC_APP_KEY = "B1fDIAC8C2dXizdlslG7Cl1D";
        
        // [Fix] å³ä½¿æ˜¯å›½é™…ç‰ˆï¼Œç›´æ¥æ‹¼AppIDä¹Ÿæ˜¯æœ€ç¨³çš„
        const LC_API_URL = "https://esl6o1jm.api.lncldglobal.com/1.1/classes/GameResult";

        // --- æ•°å€¼é€»è¾‘å¼•æ“ ---
        const STRATEGY_LOGIC = {
            C: { 
                cost: {
                    high: { b: -80, s: 0.8, r: 12 },
                    mid:  { b: -100, s: 1.0, r: 10 },
                    low:  { b: -120, s: 1.2, r: 8 }
                }
            },
            B: { 
                prob: { high: 0.5, mid: 0.4, low: 0.3 },
                fail: { 
                    high: { b: -104, s: 1.04, r: -8 },
                    mid:  { b: -130, s: 1.3, r: -10 },
                    low:  { b: -156, s: 1.56, r: -12 }
                },
                success: { 
                    high: { b: -32, s: 0.32, r: 0 },
                    mid:  { b: -40, s: 0.4, r: 0 },
                    low:  { b: -48, s: 0.48, r: 0 }
                }
            },
            A: { 
                prob: { high: 0.7, mid: 0.6, low: 0.5 },
                fail: {
                    high: { b: -128, s: 1.28, r: -16 },
                    mid:  { b: -160, s: 1.6, r: -20 },
                    low:  { b: -192, s: 1.92, r: -24 }
                },
                success: {
                    high: { b: -16, s: 0.16, r: 0 },
                    mid:  { b: -20, s: 0.2, r: 0 },
                    low:  { b: -24, s: 0.24, r: 0 }
                }
            }
        };

        // --- æ¸¸æˆæ–‡æœ¬æ•°æ® ---
        const gameData = [
            {
                id: 1, tag: "ESS6 ç”Ÿç‰©å¤šæ ·æ€§", title: "å±æœºäº‹ä»¶1ï¼šå¸¦è¡€çš„ç¾½æ¯›",
                desc: "<strong>ã€äº‹ä»¶æè¿°ã€‘</strong><br>è¾“ç”µçº¿è·¯æ–½å·¥è¿›å…¥å…³é”®æœŸã€‚ä»Šæ—©ï¼Œåœ¨3å·å¡”åŸºé™„è¿‘å‘ç°äº†ä¸¤åªæå±å€™é¸Ÿçš„å°¸ä½“ã€‚æ­¤æ—¶ï¼Œæ­£å¥½æœ‰ä¸€æ”¯å›½é™…ç¯ä¿NGOè€ƒå¯Ÿå›¢è®¡åˆ’åœ¨1å¤©åè®¿é—®ç°åœºã€‚å¦‚æœå°¸ä½“è¢«å‘ç°ï¼Œé¡¹ç›®å°†é¢ä¸´å·¨å¤§çš„èˆ†è®ºé£æš´ã€‚",
                options: [
                    { type: "A", text: "è¿™æ˜¯æ„å¤–ã€‚ç«‹åˆ»æ¸…ç†ç°åœºï¼ŒæŠŠé¸ŸåŸ‹äº†ï¼Œä¸è¦å£°å¼ ã€‚é€šçŸ¥å®‰ä¿å°é”è¯¥åŒºåŸŸï¼Œä»¥â€˜æ–½å·¥å®‰å…¨â€™ä¸ºç”±æ‹’ç»NGOæ¥è¿‘è¯¥å¡”åŸºã€‚", riskRole: "NGO æ— äººæœº", riskMsg: "NGO ç”¨æ— äººæœºæ‹åˆ°äº†åŸ‹å°¸ç”»é¢å¹¶åœ¨ Twitter æ›å…‰ã€‚é¡¹ç›®è¢«å‹’ä»¤åœå·¥æ•´é¡¿ã€‚", luckyMsg: "ä½ å°é”äº†ç°åœºï¼ŒNGO æ²¡å‘ç°å¼‚å¸¸ã€‚ä½†è¿™äº‹è®©ä½ å¿ƒæƒŠè‚‰è·³ã€‚", learning: "æ©ç›–ç¯å¢ƒäº‹æ•…æ˜¯å¤§å¿Œã€‚åœ¨æ•°å­—æ—¶ä»£ï¼Œæ²¡æœ‰ä»€ä¹ˆç§˜å¯†èƒ½çœŸæ­£è—ä½ã€‚" },
                    { type: "B", text: "å¦‚å®è®°å½•ï¼Œä½†å¯¹å¤–è§£é‡Šè¿™æ˜¯â€˜è‡ªç„¶æ­»äº¡â€™æˆ–â€˜æ—¢æœ‰çº¿è·¯é€ æˆâ€™ã€‚åŒæ—¶åœ¨NGOæ¥è®¿å‰ï¼Œä¸´æ—¶æŒ‚å‡ ä¸ªé©±é¸Ÿæ°”çƒåšåšæ ·å­ã€‚", riskRole: "ä¸–è¡Œä¸“å®¶", riskMsg: "ä¸“å®¶å°¸æ£€è¯æ˜æ˜¯æ’å‡»è‡´æ­»ã€‚ä½ ä»¬è¢«è®¤å®šä¸ºâ€˜ç¼ºä¹è¯šæ„â€™ï¼Œå¢åŠ äº†é‡ç‚¹ç›‘ç®¡ã€‚", luckyMsg: "ä¸“å®¶å‹‰å¼ºæ¥å—äº†è§£é‡Šï¼Œåªæ˜¯ç®€å•è®°å½•äº†ä¸€ä¸‹ã€‚", learning: "è¯¯å¯¼è°ƒæŸ¥å±äºè¯šä¿¡é—®é¢˜ï¼Œä¼šæå¤§æŸå®³ä¸ç›‘ç®¡æ–¹çš„ä¿¡ä»»å…³ç³»ã€‚" },
                    { type: "C", text: "ç«‹å³åœå·¥ï¼Œä¿æŠ¤ç°åœºï¼Œé€šçŸ¥ä¸–è¡Œå’Œå½“åœ°æ—ä¸šå±€ã€‚è˜è¯·ä¸“å®¶è¯„ä¼°åŸå› ï¼Œå¹¶æ‰¿è¯ºåœ¨ NGO æ¥è®¿æ—¶å…¬å¼€æ•´æ”¹æ–¹æ¡ˆï¼ˆå¦‚åŠ è£…é¸Ÿç±»è½¬å‘å™¨ï¼‰ã€‚", successMsg: "ä¸»åŠ¨åœå·¥æ•´æ”¹èŠ±è´¹å·¨å¤§ï¼Œä½†èµ¢å¾—äº† NGO çš„å°Šé‡ï¼Œå±æœºåŒ–è§£ã€‚", learning: "é€æ˜å’Œä¸“ä¸šçš„åº”å¯¹ï¼Œèƒ½å°†å±æœºè½¬åŒ–ä¸ºå»ºç«‹ä¿¡ä»»çš„å¥‘æœºã€‚" }
                ]
            },
            {
                id: 2, tag: "ESS2 åŠ³å·¥æ¡ä»¶", title: "å±æœºäº‹ä»¶2ï¼šæ²‰é»˜çš„å·¥äºº",
                desc: "<strong>ã€äº‹ä»¶æè¿°ã€‘</strong><br>åˆ†åŒ…å•†ä¸ºæŠ¢é›¨å­£å‰çš„å·¥æœŸå®è¡Œâ€œå¤§å¹²100å¤©â€ï¼Œå·¥äººæ¯æ—¥å·¥ä½œ10å°æ—¶ä»¥ä¸Šï¼Œä¸”æ²¡æœ‰å‘¨æœ«ä¼‘æ¯ã€‚ä¸ºäº†ç»Ÿä¸€è°ƒåº¦ï¼Œåˆ†åŒ…å•†å®‰æ’æ‰€æœ‰å·¥äººæŒ¤åœ¨ç°åœºå‘¨è¾¹çš„ä¸´æ—¶æ¿æˆ¿é‡Œï¼Œå«ç”Ÿæ¡ä»¶æ¶åŠ£ï¼Œåƒåœ¾å †ç§¯ï¼Œå¼‚å‘³åˆºé¼»ã€‚",
                options: [
                    { type: "A", text: "è¿™æ˜¯å½“åœ°å¸¸æ€ã€‚åªè¦æŒ‰æ—¶å‘å·¥èµ„ï¼Œå·¥äººä¸ºäº†èµšé’±æ˜¯æ„¿æ„åƒè‹¦çš„ã€‚è®©å·¥å¤´ç¨å¾®æ³¨æ„ä¸€ä¸‹åƒåœ¾æ¸…ç†ï¼Œä¸è¦å½±å“ç°åœºè§‚æ„Ÿå³å¯ã€‚", riskRole: "ç–«æƒ…çˆ†å‘", riskMsg: "æ¶åŠ£çš„å«ç”Ÿæ¡ä»¶å¯¼è‡´ä¼ æŸ“ç—…åœ¨è¥åœ°çˆ†å‘ï¼Œå¤§æ‰¹å·¥äººç—…å€’ã€‚ä¸–è¡Œä»‹å…¥è°ƒæŸ¥å‘ç°å·¥æ—¶å’Œå±…ä½ç¯å¢ƒä¸¥é‡è¿è§„ã€‚", luckyMsg: "è™½ç„¶ç¯å¢ƒå·®äº†ç‚¹ï¼Œä½†å¤§å®¶ä¸ºäº†åŠ ç­è´¹éƒ½å¿äº†ä¸‹æ¥ï¼Œå·¥ç¨‹è¿›åº¦ä¿ä½äº†ã€‚", learning: "å¿½è§†åŸºæœ¬çš„ç”Ÿæ´»å’Œå·¥ä½œæ¡ä»¶ï¼ˆESS2ï¼‰ä¸ä»…ä¸äººé“ï¼Œæ›´æ˜¯å·¨å¤§çš„è¿è¥é£é™©ã€‚" },
                    { type: "B", text: "ç¯å¢ƒå¤ªå·®å®¹æ˜“æ»‹ç”Ÿç–¾ç—…ã€‚ç«‹å³æ‹¨æ¬¾æ”¹å–„å®¿èˆå«ç”Ÿï¼ŒåŠ è£…é£æ‰‡ã€‚è‡³äºåŠ ç­ï¼Œåªè¦å·¥äººä¸å…¬å¼€æŠ—è®®ï¼Œä¸ºäº†èŠ‚ç‚¹åªèƒ½å…ˆç»´æŒç°çŠ¶ã€‚", riskRole: "å·¥ä¼šæŠ—è®®", riskMsg: "æ”¹å–„ä½å®¿æ²¡èƒ½å¹³æ¯è¿‡åº¦åŠ³ç´¯çš„æ€¨æ°”ã€‚å·¥ä¼šç»„ç»‡ç½¢å·¥ï¼Œè¦æ±‚æ”¯ä»˜å·¨é¢åŠ ç­è´¹å’Œå¥åº·èµ”å¿ã€‚", luckyMsg: "ä½å®¿æ”¹å–„è®©å·¥äººå¿ƒæƒ…å¥½äº†ä¸€äº›ï¼Œå‹‰å¼ºç»´æŒç€é«˜å¼ºåº¦å·¥ä½œç›´åˆ°èŠ‚ç‚¹ã€‚", learning: "å°æ©å°æƒ æ— æ³•æ©ç›–ç³»ç»Ÿæ€§çš„åŠ³åŠ¨å‰¥å‰Šï¼Œè¿‡åº¦åŠ ç­ä¹Ÿæ˜¯ä¸¥é‡çš„åˆè§„é—®é¢˜ã€‚" },
                    { type: "C", text: "ç«‹å³æ•´æ”¹ã€‚å¼ºåˆ¶é™åˆ¶åŠ ç­å·¥æ—¶ï¼ˆESS2 åŠ³å·¥æ¡ä»¶ï¼‰ï¼Œç§Ÿç”¨å¤–éƒ¨æ°‘å±…ä»¥é™ä½å®¿èˆå±…ä½å¯†åº¦ï¼Œç¡®ä¿äººå‡å±…ä½é¢ç§¯å’Œå«ç”Ÿè¾¾æ ‡ï¼Œå“ªæ€•å·¥æœŸå—å½±å“ã€‚", successMsg: "æˆæœ¬ä¸Šå‡ï¼Œä½†å·¥äººæ•ˆç‡æé«˜ï¼Œäº‹æ•…ç‡ä¸‹é™ã€‚ä¸–è¡Œèµèµä½ ä»¬çš„äººæœ¬ç®¡ç†ã€‚", learning: "ç¡®ä¿ä¾›åº”é“¾åŠ³å·¥åˆè§„æ˜¯æ€»åŒ…å•†ä¸å¯æ¨å¸çš„è´£ä»»ï¼ˆESS2ï¼‰ã€‚" }
                ]
            },
            {
                id: 3, tag: "ESS8 æ–‡åŒ–é—äº§", title: "å±æœºäº‹ä»¶3ï¼šç¥æ ‘æ‹¦è·¯",
                desc: "<strong>ã€äº‹ä»¶æè¿°ã€‘</strong><br>å…‰ä¼åœºåŒºå¹³æ•´åœŸåœ°æ—¶ï¼Œæ¨åœŸæœºè¢«æ‘æ°‘æ‹¦ä¸‹ã€‚åœºåŒºä¸­å¿ƒæœ‰ä¸€æ£µçœ‹ä¼¼æ™®é€šçš„å·¨å¤§çš„çŒ´é¢åŒ…æ ‘ã€‚è®¾è®¡å›¾çº¸ä¸Šæ˜¾ç¤ºå¿…é¡»é“²é™¤ï¼Œå¦åˆ™ä¼šé®æŒ¡ä¸¤æ’ç»„ä»¶ï¼Œå½±å“å‘ç”µé‡ã€‚ä½†æ‘æ°‘åšç§°è¿™æ˜¯â€œç¥–å…ˆæ –æ¯çš„ç¥æ ‘â€ï¼Œç»å¯¹ä¸èƒ½åŠ¨ã€‚",
                options: [
                    { type: "A", text: "æ²¡æœ‰ä»€ä¹ˆæ˜¯é’±è§£å†³ä¸äº†çš„ã€‚æ‰¾æ‘é•¿ç§ä¸‹è°ˆï¼Œç»™æ‘é›†ä½“ä¸€ç¬”â€˜ç¥­ç¥€è´¹â€™ï¼Œè®©æˆ‘ä»¬æ˜å¤©æŠŠå®ƒç äº†ã€‚", riskRole: "åè…æœºæ„", riskMsg: "æ‘é•¿ç§åé’±è´¢å¼•å‘æš´åŠ¨ã€‚è¿™ç¬”é’±è¢«å®šæ€§ä¸ºå•†ä¸šè´¿èµ‚ã€‚", luckyMsg: "æ‘é•¿æå®šäº†æ‘æ°‘ã€‚æ ‘æ²¡äº†ï¼Œè€³æ ¹æ¸…å‡€äº†ã€‚", learning: "ä¸è¦è¯•å›¾ç”¨é‡‘é’±ä¹°æ–­æ–‡åŒ–ä¿¡ä»°ï¼Œè¿™æ¶‰åŠä¸¥é‡çš„é“å¾·é£é™©ã€‚" },
                    { type: "B", text: "è¿™æ ‘ä¸åœ¨å®˜æ–¹ä¿æŠ¤åå½•é‡Œï¼ŒåœŸåœ°æˆ‘ä»¬ä¹Ÿå·²ç»å¾ä¸‹æ¥äº†ã€‚å¤œé—´æ–½å·¥ï¼ŒæŠŠå®ƒæ¨å€’ï¼Œé€ æˆæ—¢å®šäº‹å®ã€‚", riskRole: "ä¸–è¡Œçº¢ç‰Œ", riskMsg: "ç ´åæ–‡åŒ–é—äº§æ˜¯ä¸–è¡Œçº¢çº¿ã€‚é¡¹ç›®é¢ä¸´è´·æ¬¾å–æ¶ˆé£é™©ã€‚", luckyMsg: "æ ‘å€’äº†ï¼Œæ‘æ°‘è™½ç„¶éª‚ï¼Œä½†æ²¡é—¹å‡ºå¤§äº‹ã€‚", learning: "å°Šé‡ç¤¾åŒºè®¤å®šçš„æ–‡åŒ–ä»·å€¼ï¼Œæ˜¯è·å¾—â€˜ç¤¾ä¼šè®¸å¯â€™çš„å‰æã€‚" },
                    { type: "C", text: "å°Šé‡ç¤¾åŒºæ„è§ã€‚ä¿®æ”¹è®¾è®¡æ–¹æ¡ˆï¼Œä¿ç•™è¿™æ£µæ ‘ï¼Œé‡æ–°æ’å¸ƒå‘¨å›´ç»„ä»¶ï¼Œå“ªæ€•æŸå¤±ä¸€äº›å‘ç”µæ•ˆç‡ã€‚", successMsg: "è™½ç„¶æ”¹è®¾è®¡å¾ˆéº»çƒ¦ä¸”æ˜‚è´µï¼Œä½†ç¥æ ‘æˆäº†é¡¹ç›®å‹è°Šçš„è±¡å¾ï¼Œåç»­å¾åœ°å¾ˆé¡ºã€‚", learning: "åŒ…å®¹æ€§è®¾è®¡èƒ½æœ‰æ•ˆè§„é¿é•¿æœŸçš„ç¤¾ä¼šé˜»åŠ›ã€‚" }
                ]
            },
            {
                id: 4, tag: "ESS4 ç¤¾åŒºå®‰å…¨", title: "å±æœºäº‹ä»¶4ï¼šå¤±æ§çš„ä¿å®‰",
                desc: "<strong>ã€äº‹ä»¶æè¿°ã€‘</strong><br>æ˜¨æ™šï¼Œå®‰ä¿å…¬å¸çš„ä¸€åä¿å®‰æŠ“åˆ°äº†ä¸€åå·å‰²ç”µç¼†çš„æ‘æ°‘ã€‚ä¸ºäº†â€œæ€é¸¡å„†çŒ´â€ï¼Œä¿å®‰å°†è¯¥æ‘æ°‘æ®´æ‰“è‡´ä¼¤ï¼Œå¹¶æ‰£æŠ¼åœ¨ä¿å®‰å®¤ä¸€æ•´å¤œã€‚ç°åœ¨æ‘æ°‘å®¶å±å¸¦ç€å…¨æ‘äººå›´åœ¨é—¨å£è¦äººï¼Œæƒ…ç»ªæå…¶æ¿€åŠ¨ã€‚",
                options: [
                    { type: "A", text: "æ˜¯ä»–å·çªƒåœ¨å…ˆï¼æŠŠè¢«ç›—ç”µç¼†ä½œä¸ºè¯æ®æ‘†å‡ºæ¥ï¼Œæ”¯æŒä¿å®‰çš„æ­£å½“é˜²å«ï¼ŒæŠ¥è­¦æŠ“äººã€‚", riskRole: "ç¤¾åŒºé˜»å·¥", riskMsg: "çŸ›ç›¾æ¿€åŒ–ï¼Œè¿›åœºé“è·¯è¢«æŒ–æ–­ï¼Œé˜»å·¥åŠä¸ªå¤šæœˆã€‚", luckyMsg: "è­¦æ–¹å¸¦èµ°äº†å°å·ï¼Œæ”¯æŒäº†ä½ ä»¬çš„é˜²å«è¯´æ³•ã€‚", learning: "å·çªƒæ˜¯æ³•å¾‹é—®é¢˜ï¼Œä½†æ»¥ç”¨ç§åˆ‘æ˜¯äººæƒé—®é¢˜ï¼Œæ€§è´¨å®Œå…¨ä¸åŒã€‚" },
                    { type: "B", text: "åƒä¸‡åˆ«è®©ä¸–è¡ŒçŸ¥é“ã€‚ç»™ä¼¤è€…ä»˜åŒ»è¯è´¹å’Œèµ”å¿é‡‘ï¼ŒæŠŠæ‰“äººçš„ä¿å®‰è¿å¤œé€èµ°ï¼ˆå¼€é™¤ï¼‰ï¼Œå¯¹å¤–è¯´æ˜¯æ‘æ°‘æ‘”ä¼¤çš„ã€‚", riskRole: "åˆè§„è°ƒæŸ¥", riskMsg: "åŒ»é™¢æŠ¥å‘Šæ³„éœ²äº†æ®´æ‰“äº‹å®ã€‚éšç’ä¸¥é‡äº‹æ•…ç½ªåŠ ä¸€ç­‰ã€‚", luckyMsg: "å®¶å±æ‹¿é’±é—­å˜´äº†ï¼Œäº‹æƒ…å‹ä¸‹å»äº†ã€‚", learning: "å‘ç”Ÿäº‹æ•…å¿…é¡»å¦‚å®ä¸ŠæŠ¥ï¼Œéšç’ä¼šè¢«è§†ä¸ºç®¡ç†ä½“ç³»å¤±æ•ˆã€‚" },
                    { type: "C", text: "ç«‹åˆ»æ”¾äººå¹¶é€åŒ»ã€‚å‘ç¤¾åŒºå…¬å¼€é“æ­‰ï¼Œæ‰¿è®¤å®‰ä¿è¿‡åº¦æ‰§æ³•ã€‚ç«‹å³å‘ä¸–è¡ŒæŠ¥å‘Šè¯¥â€˜ä¸¥é‡äº‹æ•…â€™ï¼Œå¹¶é…åˆè­¦æ–¹è°ƒæŸ¥ä¿å®‰ã€‚", successMsg: "å¿«é€Ÿååº”æœºåˆ¶å¾—åˆ°äº†è®¤å¯ï¼Œèµ”å¿è™½ç„¶è‚‰ç—›ï¼Œä½†äº‹æ€æ²¡æœ‰è¿›ä¸€æ­¥æ‰©å¤§ã€‚", learning: "å¿«é€Ÿæ•‘æ²»å’Œå¹³æ¯äº‹æ€æ˜¯å±æœºå¤„ç†çš„ç¬¬ä¸€åŸåˆ™ã€‚" }
                ]
            },
            {
                id: 5, tag: "ESS5 åœŸåœ°å¾ç”¨å’Œéè‡ªæ„¿ç§»æ°‘", title: "å±æœºäº‹ä»¶5ï¼šçœ‹ä¸è§çš„â€œé‚»å±…â€",
                desc: "<strong>ã€äº‹ä»¶æè¿°ã€‘</strong><br>åœ¨é¡¹ç›®å¤–å›´çš„ä¸€ç‰‡è’åœ°ä¸Šï¼Œä½ ä»¬è®¡åˆ’å»ºè®¾ä¸´æ—¶å †æ–™åœºã€‚åœŸåœ°æƒå±æ˜¾ç¤ºè¿™æ˜¯â€œå›½æœ‰è’åœ°â€ï¼Œæ‰‹ç»­é½å…¨ã€‚ä½†è¿›åœºæ—¶å‘ç°ï¼Œæœ‰å‡ ä¸ªæ¸¸ç‰§å®¶åº­ï¼ˆæ— å›ºå®šå±…æ‰€ï¼‰æ­£åœ¨è¿™é‡Œä¸´æ—¶æ­å¸ç¯·æ”¾ç‰§ã€‚",
                options: [
                    { type: "A", text: "è¿™æ˜¯å›½æœ‰åœŸåœ°ï¼Œæˆ‘ä»¬æœ‰è¯ã€‚é€šçŸ¥è­¦å¯Ÿå’Œæ”¿åºœï¼Œè¯·ä»–ä»¬ä¾æ³•ç¦»å¼€ã€‚", riskRole: "äººæƒè§‚å¯Ÿ", riskMsg: "å¼ºé©±è§†é¢‘è¢«æ›å…‰ã€‚ESS5 ä¿æŠ¤æ— è¯çš„ä¼ ç»Ÿä½¿ç”¨è€…ï¼Œä½ ä»¬ä¸¥é‡è¿è§„ã€‚", luckyMsg: "ä»–ä»¬çœ‹å¯¹æ–¹äººå¤šåŠ¿ä¼—ï¼Œå“è·‘äº†ã€‚", learning: "åœŸåœ°è¯ä¸æ˜¯å”¯ä¸€ä¾æ®ï¼Œç”Ÿè®¡å’Œä¼ ç»Ÿæƒç›Šå¿…é¡»è¢«å°Šé‡ã€‚" },
                    { type: "B", text: "ç»™ç‚¹ç±³é¢æ²¹å’Œå°‘è®¸ç°é‡‘ï¼ŒåŠä»–ä»¬å»åˆ«çš„åœ°æ–¹ã€‚", riskRole: "NGO", riskMsg: "NGO æŒ‡æ§ä½ ä»¬åˆ©ç”¨è´«ç©·è¿›è¡Œå‰¥å‰Šã€‚è¡¥å¿å¿…é¡»åŸºäºé‡ç½®æˆæœ¬ã€‚", luckyMsg: "ä»–ä»¬æ‹¿äº†ç‚¹é’±ï¼Œæ¬åˆ°äº†å‡ å…¬é‡Œå¤–ã€‚", learning: "éæ­£å¼çš„æ–½èˆæ— æ³•è§£å†³æ ¹æœ¬çš„ç”Ÿè®¡æ¢å¤é—®é¢˜ã€‚" },
                    { type: "C", text: "å°†ä»–ä»¬è¯†åˆ«ä¸ºâ€˜éæ­£å¼å æœ‰è€…â€™ï¼ˆESS5ï¼‰ã€‚è¯„ä¼°æ¬è¿å¯¹ä»–ä»¬ç”Ÿè®¡ï¼ˆæ”¾ç‰§ï¼‰çš„å½±å“ï¼Œæä¾›æ›¿ä»£ç‰§åœºå»ºè®®æˆ–ç”Ÿè®¡è¡¥å¿æ–¹æ¡ˆï¼Œåœ¨æ–¹æ¡ˆè¾¾æˆå‰æš‚ä¸å¼ºæ¨ã€‚", successMsg: "æµç¨‹ç¹çä¸”è¡¥å¿é‡‘æé«˜ï¼Œä½†å½»åº•æ¶ˆé™¤äº†æ³•å¾‹éšæ‚£ã€‚", learning: "å¦¥å–„å¤„ç†éè‡ªæ„¿ç§»æ°‘ï¼Œæ˜¯å¤§å‹é¡¹ç›®å¯æŒç»­çš„åŸºç¡€ã€‚" }
                ]
            }
        ];

        function fmt(n) {
            if(typeof n !== 'number') return n;
            return n.toFixed(2);
        }

        // --- è¿”å›ä¸Šä¸€é¡µé€»è¾‘ ---
        function backToStart() {
            document.getElementById('screen-survey').classList.add('hidden');
            document.getElementById('screen-survey').classList.remove('flex');
            document.getElementById('screen-start').classList.remove('hidden');
        }

        function backToSurvey() {
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('screen-briefing').classList.add('hidden');
            document.getElementById('screen-briefing').classList.remove('flex');
            document.getElementById('screen-survey').classList.remove('hidden');
            document.getElementById('screen-survey').classList.add('flex');
        }

        function backToBriefing() {
            document.getElementById('screen-context').classList.add('hidden');
            document.getElementById('screen-context').classList.remove('flex');
            document.getElementById('screen-briefing').classList.remove('hidden');
            document.getElementById('screen-briefing').classList.add('flex');
        }

        function backToContext() {
            document.getElementById('screen-matrix').classList.add('hidden');
            document.getElementById('screen-matrix').classList.remove('flex');
            document.getElementById('screen-context').classList.remove('hidden');
            document.getElementById('screen-context').classList.add('flex');
        }
        
        function backFromGame() {
            if(gameState.currentLevel === 0) {
                document.getElementById('screen-game').classList.add('hidden');
                document.getElementById('screen-game').classList.remove('flex');
                document.getElementById('screen-matrix').classList.remove('hidden');
                document.getElementById('screen-matrix').classList.add('flex');
            } else {
                alert("å·²è¿›å…¥åç»­å…³å¡ï¼Œä¸ºä¿è¯æ¨¡æ‹ŸçœŸå®æ€§ï¼Œä¸å¯é€€å›ä¸Šä¸€å…³ã€‚");
            }
        }

        // --- é—®å·é€»è¾‘ ---
        function goToSurvey() {
            document.getElementById('screen-start').classList.add('hidden');
            document.getElementById('screen-survey').classList.remove('hidden');
            document.getElementById('screen-survey').classList.add('flex');
            renderLikertScales();
            updateUI(); 
        }

        function renderLikertScales() {
            if(document.querySelector('.likert-opt')) return;
            
            const scales = document.querySelectorAll('.likert-scale');
            scales.forEach(el => {
                const name = el.dataset.name;
                for(let i=1; i<=5; i++) {
                    let label = "";
                    if(i===1) label = "å®Œå…¨<br>ä¸åŒæ„";
                    if(i===2) label = "ä¸åŒæ„";
                    if(i===3) label = "ä¸­ç«‹";
                    if(i===4) label = "åŒæ„";
                    if(i===5) label = "å®Œå…¨<br>åŒæ„";
                    el.innerHTML += `
                        <div class="likert-opt" onclick="selectLikert('${name}', ${i}, this)">
                            <div class="likert-circle">${i}</div>
                            <span class="likert-label">${label}</span>
                        </div>
                    `;
                }
            });
        }

        function selectLikert(name, val, el) {
            userProfile.surveyData[name] = val;
            const parent = el.parentElement;
            Array.from(parent.children).forEach(child => child.classList.remove('selected'));
            el.classList.add('selected');
            parent.classList.remove('scroll-highlight'); 
        }

        function selectRadio(el, field, val) {
            const group = el.parentElement;
            const inputs = document.querySelectorAll(`input[name="${field}"]`);
            inputs.forEach(input => {
                input.parentElement.classList.remove('checked');
            });
            el.classList.add('checked');
            userProfile[field] = val;
            el.closest('.form-group').classList.remove('scroll-highlight'); 
        }

        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('form-select')) {
                userProfile[e.target.dataset.field] = e.target.value;
                if(e.target.value) {
                    e.target.closest('.form-group').classList.remove('scroll-highlight');
                }
            }
        });

        function validateAndSubmit() {
            const d = userProfile.surveyData;
            
            const checks = [
                { id: 'q-gender', val: userProfile.gender },
                { id: 'q-age', val: userProfile.age },
                { id: 'q-major', val: userProfile.major },
                { id: 'q-pm', val: userProfile.role_pm },
                { id: 'q-hse', val: userProfile.role_hse },
                { id: 'q-exp', val: userProfile.exp_neg },
                { id: 'q-moral1', val: d.moral1 },
                { id: 'q-moral2', val: d.moral2 },
                { id: 'q-moral3', val: d.moral3 },
                { id: 'q-time1', val: d.time1 },
                { id: 'q-time2', val: d.time2 },
                { id: 'q-time3', val: d.time3 },
                { id: 'q-esg1', val: d.esg1 },
                { id: 'q-esg2', val: d.esg2 },
                { id: 'q-esg3', val: d.esg3 },
                { id: 'q-risk1', val: d.risk1 },
                { id: 'q-risk2', val: d.risk2 },
                { id: 'q-risk3', val: d.risk3 },
            ];

            let firstErrorId = null;
            document.querySelectorAll('.scroll-highlight').forEach(el => el.classList.remove('scroll-highlight'));

            checks.forEach(item => {
                if (!item.val) {
                    const el = document.getElementById(item.id);
                    if(el) {
                        el.classList.add('scroll-highlight');
                        if(!firstErrorId) firstErrorId = item.id;
                    }
                }
            });

            if (firstErrorId) {
                const errorEl = document.getElementById(firstErrorId);
                errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            submitSurvey();
        }

        function submitSurvey(e) {
            if(e) e.preventDefault();
            const d = userProfile.surveyData;
            userProfile.esgScore = ((6 - d.esg1) + (6 - d.esg2) + d.esg3) / 3; 
            userProfile.riskScore = (d.risk1 + d.risk2 + (6 - d.risk3)) / 3;
            userProfile.moralScore = (d.moral1 + d.moral2 + d.moral3) / 3;
            userProfile.timeScore = (d.time1 + d.time2 + (6 - d.time3)) / 3;
            
            goToBriefing();
        }

        // --- æµç¨‹è·³è½¬ ---
        function goToBriefing() {
            document.getElementById('screen-survey').classList.add('hidden');
            document.getElementById('screen-survey').classList.remove('flex');
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('screen-briefing').classList.remove('hidden');
            document.getElementById('screen-briefing').classList.add('flex');
        }

        function goToContext() {
            document.getElementById('screen-briefing').classList.add('hidden');
            document.getElementById('screen-briefing').classList.remove('flex');
            document.getElementById('screen-context').classList.remove('hidden');
            document.getElementById('screen-context').classList.add('flex');
            if (!hasContextGenerated) {
                runContextAnimation();
            } else {
                showSavedContext();
            }
        }

        // --- ä¹å®«æ ¼åŠ¨ç”» & é€»è¾‘ ---
        function getRiskBgClass(r, s) {
             const resMap = { 'low': 0, 'mid': 1, 'high': 2 };
             const senMap = { 'low': 0, 'mid': 1, 'high': 2 };
             const rIdx = resMap[r];
             const sIdx = senMap[s];
             const riskScore = (2 - rIdx) + sIdx; 
             
             if (riskScore === 4) return 'bg-red-200 text-red-900 border-red-300';
             if (riskScore === 3) return 'bg-orange-100 text-orange-900 border-orange-200';
             if (riskScore === 2) return 'bg-yellow-50 text-yellow-900 border-yellow-200';
             if (riskScore === 1) return 'bg-lime-50 text-lime-900 border-lime-200';
             return 'bg-emerald-100 text-emerald-900 border-emerald-200';
        }

        function runContextAnimation() {
            document.getElementById('btn-start-matrix').classList.add('hidden');
            document.getElementById('btn-start-matrix').classList.remove('flex');
            const grid = document.getElementById('random-grid');
            grid.innerHTML = '';
            const resList = ['low', 'mid', 'high'];
            const senList = ['low', 'mid', 'high'];
            
            const combinations = [];
            resList.forEach(r => { senList.forEach(s => { combinations.push({ r, s }); }); });
            
            combinations.forEach((c, idx) => {
                const el = document.createElement('div');
                const bgClass = getRiskBgClass(c.r, c.s);
                el.className = `grid-cell grid-cell-${idx} ${bgClass}`;
                el.innerHTML = `
                    <div class="grid-unified-text">${getResDescShort(c.r)}</div>
                    <div class="grid-unified-text my-0.5">+</div>
                    <div class="grid-unified-text">${getSenDescShort(c.s)}</div>
                `;
                grid.appendChild(el);
            });

            const targetIndex = Math.floor(Math.random() * combinations.length); 
            const target = combinations[targetIndex];
            globalContext.resource = target.r;
            globalContext.sensitivity = target.s;

            let jumps = 0;
            let currentHighlight = 0;
            const maxJumps = 15 + Math.floor(Math.random() * 5);
            const cells = document.querySelectorAll('.grid-cell');
            const interval = setInterval(() => {
                cells.forEach(c => c.classList.remove('active'));
                currentHighlight = (currentHighlight + 1) % 9;
                cells[currentHighlight].classList.add('active');
                jumps++;
                if (jumps > maxJumps && currentHighlight === targetIndex) {
                    clearInterval(interval);
                    hasContextGenerated = true;
                    setTimeout(showContextResult, 500);
                }
            }, 100);
        }

        function showSavedContext() {
             const grid = document.getElementById('random-grid');
            grid.innerHTML = '';
            const resList = ['low', 'mid', 'high'];
            const senList = ['low', 'mid', 'high'];
            const combinations = [];
            resList.forEach(r => { senList.forEach(s => { combinations.push({ r, s }); }); });
            const targetIndex = combinations.findIndex(c => c.r === globalContext.resource && c.s === globalContext.sensitivity);
            combinations.forEach((c, idx) => {
                const el = document.createElement('div');
                const bgClass = getRiskBgClass(c.r, c.s);
                el.className = `grid-cell ${idx === targetIndex ? 'active' : ''} ${bgClass}`;
                if (idx === targetIndex) el.style.opacity = 1;
                el.innerHTML = `
                    <div class="grid-unified-text">${getResDescShort(c.r)}</div>
                    <div class="grid-unified-text my-0.5">+</div>
                    <div class="grid-unified-text">${getSenDescShort(c.s)}</div>
                `;
                grid.appendChild(el);
            });
            showContextResult();
        }

        function showContextResult() {
            const footer = document.getElementById('btn-start-matrix');
            footer.classList.remove('hidden');
            footer.classList.add('flex');
            document.getElementById('ctx-result-area').classList.remove('hidden');
            document.getElementById('ctx-result-area').classList.add('flex');
            document.getElementById('final-ctx-text').innerText = `${getResDescShort(globalContext.resource)} + ${getSenDescShort(globalContext.sensitivity)}`;
            document.querySelectorAll('.ctx-desc-card').forEach(el => el.classList.remove('highlighted'));
            document.getElementById(`desc-res-${globalContext.resource}`).classList.add('highlighted');
            document.getElementById(`desc-sen-${globalContext.sensitivity}`).classList.add('highlighted');
        }

        function getResDescShort(l) { return l==='low'?'ä½èµ„æº':(l==='mid'?'ä¸­èµ„æº':'é«˜èµ„æº'); }
        function getSenDescShort(l) { return l==='low'?'ä½æ•æ„Ÿåº¦':(l==='mid'?'ä¸­æ•æ„Ÿåº¦':'é«˜æ•æ„Ÿåº¦'); }

        function goToMatrix() {
            document.getElementById('screen-context').classList.add('hidden');
            document.getElementById('screen-context').classList.remove('flex');
            document.getElementById('screen-matrix').classList.remove('hidden');
            document.getElementById('screen-matrix').classList.add('flex');
            renderMatrix();
        }

        function buildProbString(lowText, midText, highText) {
            const s = globalContext.sensitivity;
            const t1 = s === 'low' ? `<span class="prob-highlight">${lowText}</span>` : lowText;
            const t2 = s === 'mid' ? `<span class="prob-highlight">${midText}</span>` : midText;
            const t3 = s === 'high' ? `<span class="prob-highlight">${highText}</span>` : highText;
            return `æš´éœ²æ¦‚ç‡: ${t1} | ${t2} | ${t3}`;
        }

        function renderMatrix() {
            const r = globalContext.resource;
            document.getElementById('user-ctx-summary').innerText = `${getResDescShort(r)} + ${getSenDescShort(globalContext.sensitivity)}`;
            
            let html = `
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width:15%">ç­–ç•¥</th>
                            <th rowspan="2" style="width:15%">çŠ¶æ€</th>
                            <th colspan="3">åˆ©æ¶¦å½±å“</th>
                            <th colspan="3">å·¥æœŸå½±å“(æœˆ)</th>
                            <th colspan="3">å£°èª‰å½±å“</th>
                        </tr>
                        <tr>
                            <th class="${r==='low'?'matrix-highlight':''}">ä½èµ„æº</th>
                            <th class="${r==='mid'?'matrix-highlight':''}">ä¸­èµ„æº</th>
                            <th class="${r==='high'?'matrix-highlight':''}">é«˜èµ„æº</th>
                            <th class="${r==='low'?'matrix-highlight':''}">ä½èµ„æº</th>
                            <th class="${r==='mid'?'matrix-highlight':''}">ä¸­èµ„æº</th>
                            <th class="${r==='high'?'matrix-highlight':''}">é«˜èµ„æº</th>
                            <th class="${r==='low'?'matrix-highlight':''}">ä½èµ„æº</th>
                            <th class="${r==='mid'?'matrix-highlight':''}">ä¸­èµ„æº</th>
                            <th class="${r==='high'?'matrix-highlight':''}">é«˜èµ„æº</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // A éƒ¨åˆ†
            html += `
                <tr class="bg-red-50">
                    <td rowspan="3" class="font-bold text-red-600 border border-red-200">A é€ƒé¿</td>
                    <td class="prob-row border border-red-200" colspan="10">
                        ${buildProbString('ä½æ•æ„Ÿ50%', 'ä¸­æ•æ„Ÿ60%', 'é«˜æ•æ„Ÿ70%')}
                    </td>
                </tr>
                <tr class="bg-red-50">
                    <td class="text-[8px] border border-red-200">æœªæš´éœ²</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">-24</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">-20</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">-16</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">+0.24</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">+0.2</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">+0.16</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">0</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">0</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">0</td>
                </tr>
                <tr class="bg-red-50">
                    <td class="text-[8px] text-red-500 border border-red-200">æš´éœ²</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">-192</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">-160</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">-128</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">+1.92</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">+1.6</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">+1.28</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-red-200'}">-24</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-red-200'}">-20</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-red-200'}">-16</td>
                </tr>
            `;

            // B éƒ¨åˆ†
            html += `
                <tr class="bg-yellow-50">
                    <td rowspan="3" class="font-bold text-yellow-600 border border-yellow-200">B å¦¥å</td>
                    <td class="prob-row border border-yellow-200" colspan="10">
                        ${buildProbString('ä½æ•æ„Ÿ30%', 'ä¸­æ•æ„Ÿ40%', 'é«˜æ•æ„Ÿ50%')}
                    </td>
                </tr>
                <tr class="bg-yellow-50">
                    <td class="text-[8px] border border-yellow-200">æœªæš´éœ²</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">-48</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">-40</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">-32</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">+0.48</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">+0.4</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">+0.32</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">0</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">0</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">0</td>
                </tr>
                <tr class="bg-yellow-50">
                    <td class="text-[8px] text-red-500 border border-yellow-200">æš´éœ²</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">-156</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">-130</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">-104</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">+1.56</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">+1.3</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">+1.04</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-yellow-200'}">-12</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-yellow-200'}">-10</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-yellow-200'}">-8</td>
                </tr>
            `;
            
            // C éƒ¨åˆ†
            html += `
                <tr class="bg-green-50">
                    <td class="font-bold text-green-600 border border-green-200">C åˆè§„</td>
                    <td class="border border-green-200">-</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-green-200'}">-120</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-green-200'}">-100</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-green-200'}">-80</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-green-200'}">+1.2</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-green-200'}">+1.0</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-green-200'}">+0.8</td>
                    <td class="${r==='low'?'matrix-highlight':'border border-green-200'}">+8</td>
                    <td class="${r==='mid'?'matrix-highlight':'border border-green-200'}">+10</td>
                    <td class="${r==='high'?'matrix-highlight':'border border-green-200'}">+12</td>
                </tr>
            `;

            html += "</tbody></table>";
            document.getElementById('matrix-container').innerHTML = html;
        }

        // --- æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ---

        function startGame() {
            gameState = { budget: 1000, schedule: 12.0, reputation: 100, currentLevel: 0 };
            decisionPath = [];
            dynamicMultiplier = 1.0; 
            dynamicProbAdder = 0.0; 
            updateUI();
            document.getElementById('screen-matrix').classList.add('hidden');
            document.getElementById('screen-matrix').classList.remove('flex');
            document.getElementById('screen-game').classList.remove('hidden');
            document.getElementById('screen-game').classList.add('flex');
            document.getElementById('game-back-container').classList.remove('hidden');
            document.getElementById('game-back-container').classList.add('flex');
            loadLevel(0);
        }

        function loadLevel(index) {
            if (index >= gameData.length) { endGame(); return; }
            if(index > 0) {
                 document.getElementById('game-back-container').classList.add('hidden');
                 document.getElementById('game-back-container').classList.remove('flex');
            }
            gameState.currentLevel = index;
            const data = gameData[index];
            document.getElementById('screen-result').classList.add('hidden');
            document.getElementById('screen-result').classList.remove('flex');
            document.getElementById('screen-game').classList.remove('hidden');
            document.getElementById('screen-game').classList.add('flex');
            document.querySelector('#screen-game .overflow-y-auto').scrollTop = 0;

            updateUI(); 

            const warningEl = document.getElementById('dynamic-warning');
            const warningMsg = document.getElementById('dynamic-msg-content');
            if (experimentGroup === 'dynamic' && dynamicMultiplier > 1.0) {
                warningEl.classList.remove('hidden');
                const increasePct = Math.round((dynamicMultiplier - 1.0) * 100);
                warningMsg.innerText = `é¡¹ç›®å·²è¢«é‡ç‚¹å…³æ³¨ï¼æš´éœ²æ¦‚ç‡ä¸ä»£ä»·å·²ä¸Šæµ® ${increasePct}%ï¼`;
            } else {
                warningEl.classList.add('hidden');
            }

            const btnNext = document.getElementById('btn-next-level');
            btnNext.onclick = null;
            if(index === 4) {
                btnNext.innerText = "æŸ¥çœ‹æœ€ç»ˆç»“æœ ğŸ";
                btnNext.onclick = function() { endGame(); };
            } else {
                btnNext.innerText = "ä¸‹ä¸€äº‹ä»¶ â¡ï¸";
                btnNext.onclick = function() { nextLevel(); };
            }

            document.getElementById('level-indicator').innerText = `Level ${index + 1}/5`;
            document.getElementById('progress-bar').style.width = `${(index / gameData.length) * 100}%`;
            document.getElementById('event-tag').innerText = data.tag;
            document.getElementById('event-title').innerText = data.title;
            document.getElementById('event-desc').innerHTML = data.desc;

            const timePressureEl = document.getElementById('contextual-time-pressure');
            timePressureEl.classList.add('hidden');
            timePressureEl.innerHTML = ''; 
            
            if (index >= 3) {
                if (gameState.schedule > 14.5) {
                }
            }

            const container = document.getElementById('options-container');
            container.innerHTML = ''; 
            
            let budgetStyle = "";
            let repStyle = "";
            if (userProfile.timeScore <= 2) budgetStyle = "highlight-short-term"; 
            if (userProfile.timeScore >= 4) repStyle = "highlight-long-term";

            const currentOptionsData = {};
            ['A', 'B', 'C'].forEach(type => {
                currentOptionsData[type] = calculateOptionImpact(type);
            });

            data.options.forEach((opt) => {
                const calc = currentOptionsData[opt.type];
                const btn = document.createElement('button');
                
                let bgClass = "";
                let borderClass = "";
                if (opt.type === 'A') { bgClass = "bg-red-50"; borderClass = "border-red-200"; }
                else if (opt.type === 'B') { bgClass = "bg-yellow-50"; borderClass = "border-yellow-200"; }
                else if (opt.type === 'C') { bgClass = "bg-green-50"; borderClass = "border-green-200"; }
                else { bgClass = "bg-white"; borderClass = "border-slate-200"; }

                btn.className = `relative w-full text-left ${bgClass} border ${borderClass} rounded-xl p-3 shadow-sm active:scale-[0.98] transition-all duration-100 hover:shadow-md`;
                
                btn.onclick = () => handleDecision(opt, calc, currentOptionsData);

                let riskLabel = "";
                let costPreview = "";
                
                if (opt.type === 'C') {
                    riskLabel = `<span class="text-[10px] px-2 py-0.5 rounded-full font-medium text-green-700 bg-white border border-green-200">å®‰å…¨åˆè§„</span>`;
                    costPreview = `<span class='text-green-700'>å›ºå®šç»“æœ: <span class="${budgetStyle}">åˆ©æ¶¦${fmt(calc.c.b)}</span> | å·¥æœŸ+${fmt(calc.c.s)} | <span class="${repStyle}">å£°èª‰+${fmt(calc.c.r)}</span></span>`;
                } else {
                    const probPct = (calc.prob * 100).toFixed(0);
                    const riskColor = opt.type === 'A' ? 'text-red-600 bg-white border-red-200' : 'text-yellow-600 bg-white border-yellow-200';
                    const labelText = opt.type === 'A' ? 'é€ƒé¿ (é«˜é£é™©)' : 'å¦¥å (ä¸­é£é™©)';
                    riskLabel = `<span class="text-[10px] px-2 py-0.5 rounded-full font-medium ${riskColor} border">${labelText}</span>`;
                    
                    costPreview = `
                        <span class='text-slate-500'>${100-probPct}% æœªæš´éœ²: <span class="${budgetStyle}">åˆ©æ¶¦${fmt(calc.success.b)}</span> | å·¥æœŸ+${fmt(calc.success.s)}</span><br>
                        <span class='text-red-600'>${probPct}% æš´éœ²: <span class="${budgetStyle}">åˆ©æ¶¦${fmt(calc.fail.b)}</span> | å·¥æœŸ+${fmt(calc.fail.s)} | <span class="${repStyle}">å£°èª‰${fmt(calc.fail.r)}</span></span>
                    `;
                }

                btn.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="bg-slate-800 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center text-xs shadow-sm flex-none">${opt.type}</span>
                        ${riskLabel}
                    </div>
                    <p class="text-sm font-bold text-slate-700 leading-tight mb-2">${opt.text}</p>
                    <div class="text-[10px] bg-white/60 p-2 rounded border border-slate-100/50 leading-snug">
                        ${costPreview}
                    </div>
                `;
                container.appendChild(btn);
            });

            levelStartTime = Date.now();
        }

        function calculateOptionImpact(type) {
            const r = globalContext.resource;
            const s = globalContext.sensitivity;
            
            let probMod = 0;
            let costFactor = 1.0;

            if (experimentGroup === 'dynamic') {
                probMod = dynamicProbAdder;
                costFactor = dynamicMultiplier;
            }

            if (type === 'C') {
                return { c: STRATEGY_LOGIC.C.cost[r] };
            } else {
                const logic = STRATEGY_LOGIC[type];
                let baseProb = logic.prob[s];
                let finalProb = Math.min(baseProb + probMod, 1.0); 
                
                const failRaw = logic.fail[r];
                const failAdjusted = {
                    b: failRaw.b * costFactor,
                    s: failRaw.s * costFactor,
                    r: failRaw.r * costFactor
                };

                return {
                    prob: finalProb,
                    fail: failAdjusted,
                    success: logic.success[r]
                };
            }
        }

        function handleDecision(opt, calc, allOptionsCalc) {
            const duration = (Date.now() - levelStartTime) / 1000;

            decisionPath.push({ 
                level: gameState.currentLevel, 
                type: opt.type, 
                exposed: false,
                duration: duration, 
                snapshot: {
                    budget: gameState.budget,
                    schedule: gameState.schedule,
                    reputation: gameState.reputation
                },
                optionsSnapshot: allOptionsCalc
            });
            
            if (opt.type === 'C') {
                resolveSafe(opt, calc.c);
            } else {
                document.getElementById('screen-check').classList.remove('hidden');
                document.getElementById('screen-check').classList.add('flex');
                document.getElementById('check-text').innerText = `é£é™©åˆ¤å®šä¸­ (æš´éœ²æ¦‚ç‡ ${(calc.prob * 100).toFixed(0)}%)...`;
                setTimeout(() => {
                    document.getElementById('screen-check').classList.add('hidden');
                    document.getElementById('screen-check').classList.remove('flex');
                    resolveRisk(opt, calc);
                }, 1500);
            }
        }

        function resolveSafe(opt, cost) {
            applyResult({
                budget: cost.b,
                schedule: cost.s,
                rep: cost.r,
                isFail: false,
                title: "åˆè§„é€šè¿‡",
                desc: opt.successMsg,
                learning: opt.learning
            });
        }

        function resolveRisk(opt, calc) {
            const isCaught = Math.random() < calc.prob; 
            decisionPath[decisionPath.length - 1].exposed = isCaught;

            if (isCaught) {
                if (experimentGroup === 'dynamic') {
                    dynamicMultiplier *= 1.1;
                    dynamicProbAdder += 0.1; 
                }
                applyResult({
                    budget: calc.fail.b,
                    schedule: calc.fail.s,
                    rep: calc.fail.r,
                    isFail: true,
                    title: "é£é™©æš´éœ²ï¼",
                    desc: opt.riskMsg,
                    learning: opt.learning
                });
            } else {
                applyResult({
                    budget: calc.success.b,
                    schedule: calc.success.s,
                    rep: calc.success.r,
                    isFail: false,
                    isLucky: true,
                    title: "ä¾¥å¹¸è¿‡å…³",
                    desc: opt.luckyMsg,
                    learning: opt.learning
                });
            }
        }

        function applyResult(result) {
            updateStat('budget', result.budget);
            updateStat('schedule', result.schedule);
            updateStat('reputation', result.rep);

            const screenResult = document.getElementById('screen-result');
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('flex');
            
            screenResult.classList.remove('hidden');
            screenResult.classList.add('flex');
            document.querySelector('#screen-result .overflow-y-auto').scrollTop = 0;

            const rIcon = document.getElementById('result-icon');
            const rTitle = document.getElementById('result-title');
            const rDesc = document.getElementById('result-desc');
            const rLearn = document.getElementById('result-learning');
            const rBadge = document.getElementById('lucky-badge');

            showDiff('show-diff-budget', result.budget, 'åˆ©æ¶¦');
            showDiff('show-diff-schedule', result.schedule, 'å·¥æœŸ');
            showDiff('show-diff-rep', result.rep, 'å£°èª‰');

            rDesc.innerText = result.desc;
            rLearn.innerText = result.learning;
            rBadge.classList.add('hidden');

            if (result.isFail) {
                rIcon.innerText = "ğŸ›‘";
                rTitle.className = "text-2xl font-black text-red-600 mb-4 text-center";
                rTitle.innerText = result.title;
                screenResult.classList.add('shake');
            } else if (result.isLucky) {
                rIcon.innerText = "ğŸ˜…";
                rTitle.className = "text-2xl font-black text-orange-500 mb-4 text-center";
                rTitle.innerText = result.title;
                rBadge.classList.remove('hidden');
                screenResult.classList.remove('shake');
            } else {
                rIcon.innerText = "âœ…";
                rTitle.className = "text-2xl font-black text-emerald-600 mb-4 text-center";
                rTitle.innerText = result.title;
                screenResult.classList.remove('shake');
            }
        }

        function showDiff(id, val, unit) {
            const el = document.getElementById(id);
            if (!val || val === 0) { el.classList.add('hidden'); return; }
            el.classList.remove('hidden');
            const prefix = val > 0 ? "+" : "";
            el.innerText = `${unit}${prefix}${val.toFixed(2)}`;
            if (unit === 'å·¥æœŸ') {
                el.className = val > 0 ? 'text-red-500' : 'text-emerald-500';
            } else {
                el.className = val > 0 ? 'text-emerald-500' : 'text-red-500';
            }
        }

        function updateStat(key, delta) {
            gameState[key] += delta;
            updateUI();
            if(delta !== 0) {
                const floatEl = document.getElementById(`float-${key}`);
                floatEl.innerText = delta > 0 ? `+${delta.toFixed(2)}` : delta.toFixed(2);
                floatEl.className = `stat-float text-sm ${delta > 0 ? (key === 'schedule' ? 'text-red-600' : 'text-emerald-600') : (key === 'schedule' ? 'text-emerald-600' : 'text-red-600')}`;
                floatEl.style.animation = 'none';
                floatEl.offsetHeight; 
                floatEl.style.animation = null; 
            }
        }

        function updateUI() {
            document.getElementById('val-budget').innerText = gameState.budget.toFixed(2);
            
            const lbl = document.getElementById('lbl-schedule');
            const valEl = document.getElementById('val-schedule');
            const box = document.getElementById('box-schedule');

            if (gameState.schedule <= LIMIT_SCHEDULE) {
                const remaining = LIMIT_SCHEDULE - gameState.schedule;
                lbl.innerText = "è¿›åº¦(å‰©ä½™)";
                valEl.innerText = remaining.toFixed(1); 
                valEl.className = "text-blue-600 text-base"; 
                
                if (remaining < 2.0) {
                    valEl.className = "text-red-600 text-base font-bold"; 
                    box.classList.add('animate-box-flash'); 
                } else {
                    box.classList.remove('animate-box-flash');
                }

            } else {
                const overdue = gameState.schedule - LIMIT_SCHEDULE;
                lbl.innerText = "è¿›åº¦(å»¶è¯¯)";
                valEl.innerText = "-" + overdue.toFixed(1);
                valEl.className = "text-red-600 text-base font-bold";
                box.classList.add('animate-box-flash'); 
            }
            
            document.getElementById('val-reputation').innerText = gameState.reputation.toFixed(2);
        }

        function nextLevel() {
            const nextIndex = gameState.currentLevel + 1;
            loadLevel(nextIndex);
        }

        // [Fix: Mobile Network]
        // 1. ä½¿ç”¨ä¼ ç»Ÿçš„ XHR (XMLHttpRequest) æ›¿ä»£ Fetchï¼Œå› ä¸º XHR åœ¨éƒ¨åˆ†å®‰å“ Webview å’Œå¾®ä¿¡æµè§ˆå™¨ä¸­å…¼å®¹æ€§æ›´å¥½
        // 2. å¢åŠ  JSON.stringify ä¹‹å‰çš„æ•°æ®æ¸…æ´—ï¼Œç¡®ä¿æ²¡æœ‰ undefinedï¼Œé˜²æ­¢ LeanCloud æŠ¥é”™
        // 3. å¢åŠ  Explicit Timeout è®¾ç½®
        function xhrRequest(method, url, data) {
            return new Promise(function (resolve, reject) {
                var xhr = new XMLHttpRequest();
                xhr.open(method, url, true); // async
                xhr.setRequestHeader("X-LC-Id", LC_APP_ID);
                xhr.setRequestHeader("X-LC-Key", LC_APP_KEY);
                xhr.setRequestHeader("Content-Type", "application/json");
                
                xhr.timeout = 10000; // 10s timeout

                xhr.onload = function () {
                    if (this.status >= 200 && this.status < 300) {
                        try {
                            resolve(JSON.parse(xhr.responseText));
                        } catch(e) {
                            reject({ message: "JSON Parse Error", status: this.status });
                        }
                    } else {
                        reject({
                            status: this.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText
                        });
                    }
                };
                xhr.onerror = function () {
                    reject({ message: "Network Error", status: xhr.status });
                };
                xhr.ontimeout = function () {
                    reject({ message: "Request Timeout", status: 408 });
                };

                if (data) {
                    // æ•°æ®æ¸…æ´—ï¼šç§»é™¤ undefinedï¼Œé˜²æ­¢ 400 Bad Request
                    var cleanData = JSON.parse(JSON.stringify(data, function(k, v) {
                        return v === undefined ? null : v;
                    }));
                    xhr.send(JSON.stringify(cleanData));
                } else {
                    xhr.send();
                }
            });
        }

        async function submitDataWithRetry(url, data, retries = 2) {
            for (let i = 0; i <= retries; i++) {
                try {
                    return await xhrRequest("POST", url, data);
                } catch (err) {
                    console.warn("Retry " + (i+1) + " failed:", err);
                    if (i === retries) throw err;
                    // ç­‰å¾…æ—¶é—´ï¼š500ms, 1000ms
                    await new Promise(r => setTimeout(r, 500 * Math.pow(2, i)));
                }
            }
        }

        async function endGame() {
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('screen-result').classList.add('hidden');
            document.getElementById('screen-result').classList.remove('flex');
            document.getElementById('screen-end').classList.remove('hidden');
            document.getElementById('screen-end').classList.add('flex');
            document.getElementById('progress-bar').style.width = '100%';
            document.querySelector('#screen-end .overflow-y-auto').scrollTop = 0;

            let finalBudget = gameState.budget; 
            let schedulePenalty = 0;
            const isDelayed = gameState.schedule > LIMIT_SCHEDULE;

            if (isDelayed) {
                const overdue = gameState.schedule - LIMIT_SCHEDULE;
                schedulePenalty = Math.ceil(overdue * PENALTY_PER_MONTH); 
                finalBudget -= schedulePenalty;
                document.getElementById('end-overdue-stamp').classList.remove('hidden');
            }
            gameState.budget = finalBudget; 
            
            document.getElementById('end-budget').innerText = finalBudget.toFixed(2);
            document.getElementById('end-schedule').innerText = gameState.schedule.toFixed(2);
            document.getElementById('end-rep').innerText = gameState.reputation.toFixed(2);
            document.getElementById('comp-user-budget').innerText = finalBudget.toFixed(2);
            document.getElementById('comp-user-schedule').innerText = gameState.schedule.toFixed(2);
            document.getElementById('comp-user-rep').innerText = gameState.reputation.toFixed(2);

            let industryAvg = { budget: 600.0, schedule: 16.0, rep: 60.0 };
            let avgCount = 0;

            const bestCompliance = { budget: 600, schedule: 16.0, rep: 160.0 }; 
            const repThreshold = 50; 

            let feedbackHTML = "";
            let analysisText = "";

            const riskCount = decisionPath.filter(d => d.type === 'A').length; 
            const safeCount = decisionPath.filter(d => d.type === 'C').length; 
            
            let styleDesc = "";
            if (riskCount >= 3) {
                styleDesc = "æ‚¨é‡‡å–äº†<b>æ¿€è¿›å†’é™©</b>çš„ç­–ç•¥ç»„åˆï¼ˆå¤šæ¬¡é€‰æ‹©Aæ–¹æ¡ˆï¼‰ï¼Œå€¾å‘äºä»¥åšå¼ˆæ¢å–çŸ­æœŸåˆ©ç›Šã€‚";
            } else if (safeCount >= 3) {
                styleDesc = "æ‚¨é‡‡å–äº†<b>é«˜åº¦ç¨³å¥</b>çš„åˆè§„ç­–ç•¥ï¼ˆå¤šæ¬¡é€‰æ‹©Cæ–¹æ¡ˆï¼‰ï¼Œå±•ç°äº†å¯¹é£é™©çš„æåº¦åŒæ¶ã€‚";
            } else {
                styleDesc = "æ‚¨é‡‡å–äº†<b>çµæ´»åŠ¡å®</b>çš„æ··åˆç­–ç•¥ï¼Œåœ¨ä¸åŒæƒ…å¢ƒä¸‹æƒè¡¡äº†åˆ©å¼Šã€‚";
            }

            let budgetEval = "";
            if (finalBudget > industryAvg.budget + 100) {
                budgetEval = `ç»æµæ•ˆç›Š<span class="text-emerald-600 font-bold">æ˜¾è‘—ä¼˜äºè¡Œä¸šå¹³å‡</span>`;
            } else if (finalBudget < industryAvg.budget - 100) {
                budgetEval = `ç»æµæ•ˆç›Š<span class="text-red-600 font-bold">ä½äºè¡Œä¸šå¹³å‡</span>`;
            } else {
                budgetEval = `ç»æµæ•ˆç›Šä¸è¡Œä¸šå¹³å‡<span class="text-blue-600 font-bold">æŒå¹³</span>`;
            }

            let repEval = "";
            if (gameState.reputation >= bestCompliance.rep - 10) {
                repEval = `å£°èª‰è¡¨ç°è¾¾åˆ°äº†<span class="text-indigo-600 font-bold">æœ€ä½³åˆè§„æ ‡æ†</span>æ°´å‡†`;
            } else if (gameState.reputation > industryAvg.rep + 20) {
                repEval = `å£°èª‰ç§¯ç´¯<span class="text-emerald-600 font-bold">è¿œè¶…åŒåƒš</span>`;
            } else if (gameState.reputation < industryAvg.rep - 20) {
                repEval = `å£°èª‰<span class="text-yellow-600 font-bold">è½åäºè¡Œä¸šä¸»æµ</span>`;
            } else {
                repEval = `å£°èª‰è¡¨ç°å¤„äº<span class="text-slate-600 font-bold">è¡Œä¸šä¸»æµåŒºé—´</span>`;
            }

            analysisText = `åœ¨æœ¬æ¬¡æŒ‘æˆ˜ä¸­ï¼Œ${styleDesc}æœ€ç»ˆç»“æœæ˜¾ç¤ºï¼Œæ‚¨çš„${budgetEval}ï¼ŒåŒæ—¶${repEval}ã€‚`;
            
            if (avgCount === 0) {
                analysisText += `<br><span class="text-gray-400 italic text-xs">(æ³¨ï¼šå½“å‰ç½‘ç»œè¿æ¥å—é™ï¼Œå¯¹æ¯”åŸºäºç†è®ºä¸­æ€§å€¼)</span>`;
            }

            if (gameState.reputation < repThreshold) {
                feedbackHTML = `
                    <strong class="text-red-600 block mb-2">âš ï¸ é¡¹ç›®è§¦å‘åˆ¶è£æœºåˆ¶ (å¼ºåˆ¶é€€åœº)</strong>
                    <div class="bg-slate-100 p-2 rounded text-xs text-slate-700">
                        <span class="font-bold">ç®¡ç†æ´å¯Ÿï¼š</span><br>
                        è™½ç„¶${styleDesc}ï¼Œä½†æ‚¨çš„å£°èª‰åˆ†å·²ä½äºå®‰å…¨é˜ˆå€¼ï¼ˆ${repThreshold}åˆ†ï¼‰ï¼Œç›´æ¥è§¦å‘äº†ä¸–è¡Œçš„é»‘åå•æœºåˆ¶ã€‚æ— è®ºç»æµæ”¶ç›Šå¦‚ä½•ï¼Œé¡¹ç›®å·²å¤±è´¥ã€‚åˆè§„æ˜¯å›½é™…å·¥ç¨‹çš„ç”Ÿå­˜åº•çº¿ã€‚
                    </div>
                `;
            } else {
                let overallTitle = "";
                let overallColor = "";
                
                if (finalBudget > industryAvg.budget && gameState.reputation > industryAvg.rep) {
                    overallTitle = "ğŸ† å“è¶Šçš„é¡¹ç›®ç®¡ç†"; 
                    overallColor = "text-emerald-600";
                } else if (safeCount >= 3 && gameState.reputation >= 100) {
                    overallTitle = "ğŸ›¡ï¸ è´Ÿè´£ä»»çš„é•¿æœŸä¸»ä¹‰è€…";
                    overallColor = "text-blue-600";
                } else if (riskCount >= 3 && finalBudget > 800) {
                    overallTitle = "ğŸ’° æ¿€è¿›çš„åˆ©æ¶¦è¿½é€è€…";
                    overallColor = "text-orange-500";
                } else {
                    overallTitle = "âš–ï¸ å‡è¡¡å‘å±•çš„ç®¡ç†è€…"; 
                    overallColor = "text-slate-700";
                }
                
                feedbackHTML = `
                    <strong class="${overallColor} block mb-2">${overallTitle}</strong>
                    <div class="bg-slate-100 p-2 rounded text-xs text-slate-700 border-l-2 border-slate-300">
                        <span class="font-bold text-slate-800">ğŸ“Š æ™ºèƒ½ç”»åƒï¼š</span><br>
                        ${analysisText}
                    </div>
                `;
            }
            
            document.getElementById('end-feedback').innerHTML = feedbackHTML;
            
            updateBenchmarks();
            document.getElementById('loading-stats').classList.remove('hidden');
            
            const d = userProfile.surveyData;
            const saveData = {
                budget: finalBudget,
                schedule: gameState.schedule,
                reputation: gameState.reputation,
                
                demo_gender: userProfile.gender,
                demo_age: userProfile.age,
                demo_major: userProfile.major,
                demo_role_pm: userProfile.role_pm,
                demo_role_hse: userProfile.role_hse,
                demo_exp_neg: userProfile.exp_neg,

                ctx_resource: globalContext.resource,
                ctx_sensitivity: globalContext.sensitivity,
                exp_group: experimentGroup, 
                final_multiplier: dynamicMultiplier,

                esgScore: userProfile.esgScore,
                riskScore: userProfile.riskScore,
                moralScore: userProfile.moralScore,
                timeScore: userProfile.timeScore,
                
                raw_moral1: d.moral1, raw_moral2: d.moral2, raw_moral3: d.moral3,
                raw_time1: d.time1, raw_time2: d.time2, raw_time3: d.time3,
                raw_esg1: d.esg1, raw_esg2: d.esg2, raw_esg3: d.esg3,
                raw_risk1: d.risk1, raw_risk2: d.risk2, raw_risk3: d.risk3
            };
            
            if(decisionPath && decisionPath.length > 0) {
                decisionPath.forEach((dp, index) => {
                    const step = index + 1;
                    if (dp) {
                        saveData[`d${step}_duration`] = dp.duration || 0;

                        if (dp.snapshot) {
                            saveData[`d${step}_snap_budget`] = dp.snapshot.budget;
                            saveData[`d${step}_snap_schedule`] = dp.snapshot.schedule;
                            saveData[`d${step}_snap_rep`] = dp.snapshot.reputation;
                        }

                        if (dp.optionsSnapshot) {
                            const optA = dp.optionsSnapshot.A;
                            if (optA) {
                                saveData[`d${step}_optA_fail_prob`] = optA.prob; 
                                saveData[`d${step}_optA_fail_b`] = optA.fail.b;
                                saveData[`d${step}_optA_fail_s`] = optA.fail.s; 
                                saveData[`d${step}_optA_fail_r`] = optA.fail.r;
                                saveData[`d${step}_optA_succ_b`] = optA.success.b;
                                saveData[`d${step}_optA_succ_s`] = optA.success.s; 
                                saveData[`d${step}_optA_succ_r`] = optA.success.r; 
                            }
                            
                            const optB = dp.optionsSnapshot.B;
                            if (optB) {
                                saveData[`d${step}_optB_fail_prob`] = optB.prob; 
                                saveData[`d${step}_optB_fail_b`] = optB.fail.b;
                                saveData[`d${step}_optB_fail_s`] = optB.fail.s; 
                                saveData[`d${step}_optB_fail_r`] = optB.fail.r;
                                saveData[`d${step}_optB_succ_b`] = optB.success.b;
                                saveData[`d${step}_optB_succ_s`] = optB.success.s; 
                                saveData[`d${step}_optB_succ_r`] = optB.success.r; 
                            }

                            const optC = dp.optionsSnapshot.C;
                            if (optC && optC.c) {
                                saveData[`d${step}_optC_cost_b`] = optC.c.b;
                                saveData[`d${step}_optC_cost_s`] = optC.c.s; 
                                saveData[`d${step}_optC_cost_r`] = optC.c.r;
                            }
                        }

                        saveData[`d${step}_type`] = dp.type || 'N/A';
                        saveData[`d${step}_exposed`] = dp.exposed === undefined ? false : dp.exposed;
                    }
                });
            }

            // [Fix] é‡æ„æäº¤é€»è¾‘ï¼Œä½¿ç”¨ XHR
            try {
                const resultJson = await submitDataWithRetry(LC_API_URL, saveData);
                currentSessionId = resultJson.objectId;
                console.log("Save Success, ID:", currentSessionId);
            } catch(e) {
                console.error("Data Sync Failed:", e);
                document.getElementById('network-status').style.display = 'block';
                let errMsg = "æœªçŸ¥é”™è¯¯";
                if (e.status) errMsg = `HTTP ${e.status}`;
                if (e.message) errMsg += ` (${e.message})`;
                if (e.responseText) {
                     try {
                         const leanErr = JSON.parse(e.responseText);
                         if(leanErr.error) errMsg = leanErr.error;
                     } catch(jsonErr) {}
                }
                document.getElementById('network-status').innerText = `âš ï¸ ç¦»çº¿æ¨¡å¼: ${errMsg}`;
            }
            await fetchAverageData();
        }

        async function fetchAverageData() {
            const avgLabel = document.getElementById('avg-label');
            const elBudget = document.getElementById('avg-budget');
            const elSchedule = document.getElementById('avg-schedule');
            const elRep = document.getElementById('avg-rep');
            
            // [Fix] é‡æ„è·å–é€»è¾‘ï¼Œä½¿ç”¨ XHR GET
            try {
                const data = await xhrRequest("GET", LC_API_URL + '?limit=200&order=-createdAt');
                
                let results = data.results || [];
                if (currentSessionId) results = results.filter(r => r.objectId !== currentSessionId);
                if (results && results.length > 0) {
                    let sumB = 0, sumS = 0, sumR = 0;
                    results.forEach(r => { sumB += (r.budget || 0); sumS += (r.schedule || 0); sumR += (r.reputation || 0); });
                    avgLabel.innerText = `ğŸ‘¥ å­¦å‘˜å¹³å‡ (N=${results.length})`; 
                    elBudget.innerText = (sumB / results.length).toFixed(2);
                    elSchedule.innerText = (sumS / results.length).toFixed(2);
                    elRep.innerText = (sumR / results.length).toFixed(2);
                } else {
                    avgLabel.innerText = `ğŸ‘¥ æš‚æ— å…¶ä»–æ•°æ®`;
                    elBudget.innerText = "-"; elSchedule.innerText = "-"; elRep.innerText = "-";
                }
            } catch(e) {
                console.error("Fetch Failed", e);
                avgLabel.innerText = "âš ï¸ ç¦»çº¿æ¨¡å¼";
                elBudget.innerText = "æœ¬åœ°"; elSchedule.innerText = "æœ¬åœ°"; elRep.innerText = "æœ¬åœ°";
                document.getElementById('network-status').style.display = 'block';
            }
            document.getElementById('loading-stats').classList.add('hidden');
        }

        function forceRetryCloud() {
            document.getElementById('loading-stats').classList.remove('hidden');
            fetchAverageData();
        }
        
        function updateBenchmarks() {
            const bestC = { b: 1000 + (5 * -80), s: 12.0 + (5 * 0.8), r: 100 + (5 * 12) };
            const bestLuck = { b: 1000 + (5 * -16), s: 12.0 + (5 * 0.16), r: 100 + 0 };
            
            let worstS = 12.0 + (5 * 1.92);
            let worstB = 1000 + (5 * -192);
            let worstR = 100 + (5 * -24);
            if (worstS > 16.0) { worstB -= Math.ceil((worstS - 16.0) * 100); }

            document.getElementById('bench-compliance-budget').innerText = bestC.b.toFixed(2);
            document.getElementById('bench-compliance-schedule').innerText = bestC.s.toFixed(2);
            document.getElementById('bench-compliance-rep').innerText = bestC.r.toFixed(2);

            document.getElementById('bench-luck-budget').innerText = bestLuck.b.toFixed(2);
            document.getElementById('bench-luck-schedule').innerText = bestLuck.s.toFixed(2);
            document.getElementById('bench-luck-rep').innerText = bestLuck.r.toFixed(2);

            document.getElementById('bench-worst-budget').innerText = worstB.toFixed(2);
            document.getElementById('bench-worst-schedule').innerText = worstS.toFixed(2);
            document.getElementById('bench-worst-rep').innerText = worstR.toFixed(2);
        }
    </script>
<script>window.parent.postMessage({ action: "ready" }, "*"); 
 
window.console = new Proxy(console, {
  get(target, prop) {
    if (['log', 'warn', 'error'].includes(prop)) {
      return new Proxy(target[prop], {
        apply(fn, thisArg, args) {
          fn.apply(thisArg, args);
          window.parent.postMessage({ action: 'console', 
            type: prop, 
            args: args.map((arg) => {
              try {
                return JSON.stringify(arg).replace(/^["']|["']$/g, '');
              } catch (e) {
                return arg;
              }
            }) 
          }, '*');
        }
      });
    }
    return target[prop];
  }
});
</script></body>
</html>
